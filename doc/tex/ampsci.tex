%\documentclass[12pt,,a4paper]{article}%twocolumn
%\usepackage[top=2.5cm,bottom=2.0cm,left=1.5cm,right=1.5cm]{geometry} %almost-full page
\documentclass[10pt,twocolumn,a4paper]{article}%twocolumn
\usepackage[headsep=0.5cm, top=1.5cm,bottom=1.5cm,left=0.5cm,right=0.5cm]{geometry} %almost-full page

\usepackage{bm,dcolumn,amsmath,graphicx,amsfonts,amssymb,fancyhdr}
\usepackage{cancel}
\usepackage{comment}

%Spacing, header sizes, title white space:
\usepackage{titling}
\setlength{\droptitle}{-2cm}
\setlength{\columnsep}{0.6cm}

%To include diagrams in equations:
\usepackage{adjustbox}
\newcommand{\eqdiagram}[2]{\adjustbox{valign=c}{\includegraphics[width=#1\linewidth]{#2}}}

%Make section headers smaller:
\usepackage[tiny]{titlesec}
\usepackage{enumitem}

%Hyperlinks:
\usepackage{hyperref}
\usepackage{xcolor}
\definecolor{cite}{rgb}{0.,0.,0.95}   % more subtle than the default blue
\hypersetup{
	colorlinks,
	linkcolor={cite},
	citecolor={cite},
	urlcolor={cite}
}


%Bibliog styles:  Emulates revtex (PRA, PRL etc.), with LINKs in bib, sorted citations,
\usepackage[sort&compress,numbers]{natbib}
\bibliographystyle{apsrev4-2}
\usepackage{doi}%<----------


\renewcommand{\bibname}{References}   %changes name to "Refs"

%% Custom functions:
\newcommand{\abs}[1]{\ensuremath{\left |#1\right |}}
\newcommand{\bra}[1]{\ensuremath{\langle #1|}}	%Dirac Bras
\newcommand{\ket}[1]{\ensuremath{|#1\rangle}}
\newcommand{\braket}[1]{\ensuremath{\langle #1\rangle}}	%Dirac BraKets

\newcommand{\matr}[4]{\ensuremath{\begin{pmatrix}#1&#2\\#3&#4\end{pmatrix}}}	% 2x2 matrix
\newcommand{\twocomp}[2]{\ensuremath{\begin{pmatrix}#1\\#2\end{pmatrix}}}	% 2-component wavefunction

%
\newcommand{\threej}[6]{
\renewcommand\arraystretch{0.75}\setlength\arraycolsep{2pt}
\small\ensuremath{\begin{pmatrix}#1&#2&#3\\#4&#5&#6\end{pmatrix}}
}	% 3-j symbol
\newcommand{\sixj}[6]{\renewcommand\arraystretch{0.75}\setlength\arraycolsep{2pt}\small\ensuremath{\begin{Bmatrix}#1&#2&#3\\#4&#5&#6\end{Bmatrix}}}	% 6-j symbol
\newcommand{\sixjs}[6]{\renewcommand\arraystretch{0.75}\ensuremath{\begin{Bmatrix}#1~#2~#3\\#4~#5~#6\end{Bmatrix}}}	% 6-j symbol
\renewcommand{\v}[1]{\ensuremath{\boldsymbol{#1}}}		%bold-math for vectors
\newcommand{\vv}[1]{\ensuremath{\boldsymbol{\vec{#1}}}}		%bold-math for vectors
\newcommand{\vhat}[1]{\ensuremath{\hat{\boldsymbol{#1}}}}		%bold-math for vectors

\newcommand{\E}[1]{\ensuremath{\times10^{#1}}}	%exponent:    A x 10^y

%\newcommand{\lambdabar}{{\mkern0.75mu\mathchar '22\mkern -.75mu\lambda}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% For \lambdabar
\makeatletter
\newcommand{\lambdabar}{{\mathchoice
  {\smash@bar\textfont\displaystyle{0.25}{1.2}\lambda}
  {\smash@bar\textfont\textstyle{0.25}{1.2}\lambda}
  {\smash@bar\scriptfont\scriptstyle{0.25}{1.2}\lambda}
  {\smash@bar\scriptscriptfont\scriptscriptstyle{0.25}{1.2}\lambda}
}}
\newcommand{\smash@bar}[4]{%
  \smash{\rlap{\raisebox{-#3\fontdimen5#10}{$\m@th#2\mkern#4mu\mathchar'26$}}}%
}
\makeatother
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\be}{\begin{equation}}
\newcommand{\ee}{\end{equation}}
\newcommand{\bem}{\begin{multline}}
\newcommand{\eem}{\end{multline}}



%Common symbols (use these (as opposed to doing it manually) for easy notation-changing!!
\def\d{\ensuremath{{\rm d}}}
\newcommand{\psibar}{\ensuremath{\bar\psi}}	%psi-bar
\newcommand{\psidag}{\ensuremath{\psi^\dagger}}	%psi-dagger
\newcommand{\phibar}{\ensuremath{\bar\phi}}	%psi-bar
\newcommand{\phidag}{\ensuremath{\phi^\dagger}}	%psi-dagger

\def\h{\ensuremath{\hbar}}
\def\e{\ensuremath{\epsilon}}
\def\en{\ensuremath{\varepsilon}}
\def\p{\ensuremath{\partial}}

%greek symbol short-cuts:
\renewcommand{\a}{\ensuremath{\alpha}}
\renewcommand{\b}{\ensuremath{\beta}}
\newcommand{\g}{\ensuremath{\gamma}}
\newcommand{\s}{\ensuremath{\sigma}}
\renewcommand{\t}{\ensuremath{\tau}}
\renewcommand{\k}{\ensuremath{\kappa}}
\newcommand{\vk}{\ensuremath{\varkappa}}
\newcommand{\w}{\ensuremath{\omega}}

%''mathcal''
\def\CT{\ensuremath{{\cal T}}}
\def\CL{\ensuremath{{\cal L}}}

% For nicely formatting units
\newcommand{\un}[1]{\ensuremath{\,{\rm{#1}}}} % For nicely formatting general units
\newcommand{\kms}{\ensuremath{\,{\rm km\,s}^{-1}}}
\newcommand{\ev}{\,\textrm{eV}}
\newcommand{\kev}{\,\textrm{keV}}
\newcommand{\mev}{\,\textrm{MeV}}
\newcommand{\gev}{\,\textrm{GeV}}



%%
\usepackage[normalem]{ulem}
\definecolor{newc}{rgb}{0.,0.6,0.4}
\newcommand{\new}[1]{{\color{newc}#1}}
\newcommand{\old}[1]{{\color{red}\sout{#1}}} %
\newcommand{\note}[1]{{\color{orange}{${}^*$({#1})}}}
%\renewcommand{\new}[1]{#1}
%\renewcommand{\note}[1]{#1}
%\renewcommand{\old}[1]{#1}
%

\renewcommand{\abstractname}{~\\[-1.0cm]}
\renewcommand{\contentsname}{~\\[-1.1cm]}

\setcounter{tocdepth}{1}
\usepackage[titles]{tocloft}
\setlength{\cftbeforesecskip}{1.5pt}


%=================================================

\def\updatedDate{July 2024}
%\def\updatedDate{\today}

\pagestyle{fancy}
\fancyhead[L]{ampsci: Method}
\fancyhead[R]{B.\ M.\ Roberts -- \updatedDate}
\begin{document}

%-------------------------------------------------------------------------------
\twocolumn[
\begin{@twocolumnfalse}
\begin{abstract}
\vspace{0.2cm}
\noindent
This is a brief description of the methods used in the code for atomic structure calculations (for single-valence systems), and has definitions for all the relevant equations.
The code is available online:\ \href{https://github.com/benroberts999/ampsci}{github.com/benroberts999/ampsci}; see the ``readme'' file for compiling/usage instructions.
Some basic documentation for the code is also available:\ \href{https://ampsci.dev}{ampsci.dev}.
This is not meant as a complete description of the physics, but references are provided to more detailed descriptions.
\end{abstract}
\vspace{0.1cm}
\end{@twocolumnfalse}
]

%=========================================================

{\footnotesize
\tableofcontents
}

%======================================
\section{Radial Dirac equation}

An $N$-electron atomic wavefunction, $\Psi$, obeys the Schr\"odinger equation
$
H\Psi = E\Psi
$, with
\be
H = \sum_i^N h_0(\v{r}_i) + \sum_{i<j}\frac{e^2}{r_{ij}},
\ee
where $h_0$ is the single-particle Hamiltonian (including only the nuclear potential), and the second term accounts for electron-electron Coulomb interaction, with $r_{ij}\equiv\abs{\v{r}_i-\v{r}_j}$.
We can re-write this as
\be
H = H_0 + \delta V = \sum_i^N \left[h_0(\v{r}_i) + u(\v{r}_i)\right] + \delta V,
\ee
where
\[
\delta V = \sum_{i<j}\frac{1}{r_{ij}} - \sum_i  u(\v{r}_i).
\]
The assumption is that $u$ is a good approximation to interaction term, allowing us to treat $\delta V$ perturbatively.
The formation of the mean-field potential $u$, and how to treat $\delta V$ corrections, will be the discussed in the later sections.
Since the mean-field potential $u$ contains no two-particle terms (i.e., it is a function of single-electron coordinates only), the solutions to the approximate Hamiltonian
$
H_0 \Psi_0 = E_0\Psi_0
$
may be expressed as Slater determinants, which are formed from eigenstates of the single-particle Hamiltonian -- see Appendix~\ref{sec:ManyBodyWavefunction}, and Refs.~\cite{Lindgren1986,JohnsonBook2007}.

For heavy atoms, relativistic effects are crucial, so we must begin with the relativistic Dirac equation:
\be\label{eq:Dirac}
\left(h_D - \en\right) \phi(\v{r}) = 0,
\ee
where $h_D$ is the Dirac Hamiltonian (see, e.g., Ref.~\cite{BetheBook}):
\be\label{eq:H-Dirac}
h_D = c \v{\alpha}\cdot\v{p} + c^2(\beta-1) + \hat V.
\ee
Here, the potential $\hat V$ contains the nuclear and mean-field potentials,
and $\v{\alpha} = \g^0\v{\g}$ and $\b=\g^0$ are Dirac matrices.\footnote{We use atomic units: $\h=m_e=e=4\pi\epsilon_0=1$, $c=1/\alpha\approx137$ ($e>0$)}
Note that we have subtracted the electron rest energy, so the total relativistic energy is $\mathcal{E} = \en + c^2$.
For bound states, $\phi\to0$ as $r\to\infty$ and $\phi$ is regular everywhere and thus normalisable.
The set of solutions $\{\phi_i\}$ (including the negative energy states) to (\ref{eq:Dirac}) form a complete orthogonal set/basis.
We use the standard normalisation choice, so that $\braket{\phi_i|\phi_j} = \delta_{ij}$.
%
%Wavefunctions for many-electron atoms are formed from single-particle orbitals; see Appendix~\ref{sec:ManyBodyWavefunction}, and Refs.~\cite{Lindgren1986,JohnsonBook2007}.

For spherically symmetric potentials $\hat V$, we can express the four-component single-particle orbitals in the form\footnote{We use the Dirac representation; see Appendix~\ref{sec:DiracMatrix}.}$^,$\footnote{Our notation differs from some other places: compared to Ref.~\cite{BetheBook} we have $f\leftrightarrow g$;
compared to~\cite{JohnsonBook2007} we have $f_{\rm here}= P_{\rm Johnson}$, $g_{\rm here}= -Q_{\rm Johnson}$; compared to Ref.~\cite{Dzuba1982a} we have $g_{\rm here} = \alpha g_{\rm Dzuba}$; and compared to Ref.~\cite{Sapirstein1998} we have $f_{\rm here} = g_{\rm Sapirstein}$ and $g_{\rm here}=-f_{\rm Sapirstein}$.}:
\be\label{eq:phi-orbital}
\phi_{n\k m}(\v{r}) = \frac{1}{r}\twocomp
{f_{n\k}(r)\,\Omega_{\k m}(\v{n})}
{ig_{n\k}(r)\,\Omega_{-\k ,m}(\v{n})},
\ee
where $n$ is the principle quantum number, $\k = (l-j)(2j+1)$ is the Dirac quantum number, $m=j_z$ is the projection of $\v{j}=\v{l}+\v{s}$ (total electron angular momentum) onto the quantisation axis,
%($j$ and $l$ total and orbital angular momentum), 
and $\Omega$ is a (two-component) spherical spinor,
\be
\Omega_{\k m} \equiv \sum_{s_z=\pm1/2} \braket{l,m-s_z ,\,1/2,s_z|j,m}\,Y_{l,m-s_z}(\v{n})\,\chi_{s_z},
\ee
with $\braket{j_1 m_1 j_2 m_2|JM}$ a Clebsch-Gordon coefficient, $Y_{lm}$ a spherical harmonic, $\v{n} = \v{r}/r$, and $\chi_{s_z}$ is a spin eigenstate 
($s_z=\pm1/2$).
Even for non-symmetric potentials, we can expand the solutions in terms of orbitals of the form \eqref{eq:phi-orbital}.




Then, we can define the radial Dirac equation in the form: 
\be\label{eq:Dirac-radial}
\left(h_r - \en\right)F_{n\k} = 0,
\ee
where we defined the {\em radial spinor},\footnote{Radial spinor defined in:~/src/Wavefunction/DiracSpinor.hpp}
\be\label{eq:F-radial}
F_{n\k} =\twocomp {f_{n\k}(r)}{g_{n\k}(r)},
\ee
and {\em radial Hamiltonian},
\be\label{eq:H-radial}
h_r = \matr 	{\hat V} 				{c(\frac{\k}{r}-\p_r )}
			{c(\frac{\k}{r} + \p_r  )}	{\hat V-2c^2}.
\ee
The 3D (spherical) Hamiltonian can also be expressed in this form by replacing $\k$ in (\ref{eq:H-radial}) with $-\hat k$ (top right) and $\hat k$ (bottom left), where $\hat k \equiv -1 - \v{\s}\cdot\v{l}$,  and $\hat k\Omega_{\k m} = \k\Omega_{\k m}$.
I will suppress the $r$ subscript and use
$\left(h - \en\right)F = 0$ and $\left(h - \en\right)\phi = 0$ interchangeably, since there is no risk of confusion.
%
The terms in $\phi$ are orthonormal as: 
\begin{align}
&\left(n\k|n'\k\right)\equiv\int F_{n\k}^\dag F_{n'\k}\,\d r = \int\left(f_{n\k}f_{n'\k}+g_{n\k}g_{n'\k}\right)\d r = \delta_{n'n}\notag\\
\label{eq:ffrad}
&\braket{\k m|\k'm'}\equiv\int\Omega_{\k m}^\dag\Omega_{\k' m'}\,\d \Omega = \delta_{\k'\k}\delta_{m'm}.
\end{align}

%------------------------------------
\subsection[Nuclear potential]{Nuclear potential\footnote{Nuclear potentials defined in:~/src/Physics/NuclearPotentials.hpp}}

 
For a point-like nucleus, $V_{\rm nuc} = -Z/r$;
in reality, the nuclear charge is distributed across the finite-size nucleus. 
To form $V_{\rm nuc}$, we assume the nuclear charge follows a Fermi distribution,
\begin{equation}\label{eq:FermiNuc}
\rho(r) = {\rho_0}\,{\left(1+\exp[(r-c)/a]\right)^{-1}},
\end{equation}
where $\rho_0$ is a normalisation factor ($\int\rho\,\d V = Z$), 
$c$ is the half-density radius, and 
$a$ is defined via the 90--10\% density fall-off {${t\equiv 4a\ln3}$} (known as the ``skin thickness''),
which we take to be $t=2.3$\,{\rm fm} for all heavy isotopes.
The half-density radius is related to $a$ and $r_{\rm rms}$, the root-mean-square charge radius, as $c = \sqrt{(5 r_{\rm rms}^2 -7\pi^2a^2)/3}$.
Then, $V_{\rm nuc}$ is obtained numerically from (\ref{eq:FermiNuc}) using Gauss' law.
The code also allows you to assume a spherical nucleus (mainly used for testing).
The root-mean-square charge radii are known to reasonably high precision for most isotopes of interest~\cite{Angeli2013}, and reasonable interpolations can be made for the rest.

%The code also allows you to assume a spherical nucleus: % (mainly used for testing).
%\be
%V_{\rm nuc}^{\rm sph.}(r) = 
%-Z \left({3r_{\rm nuc}^2 - r^2}\right)/\,{2r_{\rm nuc}^3} \qquad {\rm for} \quad r<r_{\rm nuc},
%\ee
%where $r_{\rm nuc}=\sqrt{5/3}r_{\rm rms}$,
%and $V_{\rm nuc}^{\rm sph.}(r) = -Z/r$ for $r>r_{\rm nuc}$.


%======================================================
\section[Numerical solution to the Dirac equation]{Numerical solution to the Dirac equation\footnote{Functions to solve Dirac equation defined in:~/src/DiracODE/}}

\subsection{Bound-state solution to local Dirac equation}\label{sec:solveDirac}

From Eqs.~(\ref{eq:Dirac-radial}) and (\ref{eq:H-radial}), we can express the radial derivative as:
\be\label{eq:dF}
\frac{\p F}{\p r}
%\p_r F  
=\frac{1}{c} \matr 	{-c\,{\k}/{r}} 	{(\en - \hat V+2c^2)}  {-(\en - \hat V)} 	 {c\,{\k}/{r}}F,
\ee
which has the familiar form of an ODE.
Very roughly, we can solve an ODE numerically by stepping forward if we know the derivative of a function and the value of the function at some previous point: $F(r+\delta r) \approx F(r) + {\p_r F}\delta r$.
Multi-step methods approximate the value of the derivative along the interval $(r, \, r+\delta r)$ with greater accuracy by using several points in the estimation. 
We use an $M$-step Adams-Moulton method,
which, for a general DE of the form $\p_r F_n  = y_n$, has the form
\be\label{eq:Adams}
F_{n+M} = F_{n+M-1} + \delta r \sum_{i=0}^M b_i \, y_{n+i},
\ee
where $y_n\equiv y(r_n)$, and $b_j$ are numerical coefficients. 
Since the derivative Eq.~(\ref{eq:dF}) can be written as a matrix equation, we can solve this equation for $F_{n+M}$ algebraically:
\begin{multline}
F_{n+M} = \\\left[1 - \delta r\,b_M D_{n+M}\right]^{-1}\left(F_{n+M-1} + \delta r \sum_{i=0}^{M-1} b_i D_{n+i}F_{n+i}\right).
\end{multline}
Therefore, we may find the value of the function at ${n+M}$ grid-point, provided $M-1$ previous points are known.
These initial points are determined by solving the asymptotic form of the Dirac equation analytically accounting for the boundary conditions (see Ref.~\cite{JohnsonBook2007} for details), noting that for neutral atoms $V(r)\approx-Z/r$ for small $r$, and 
$\approx-1/r$ for large $r$. 


Equation~(\ref{eq:dF}) has solutions for any given $\en$. 
We are interested in the specific bound-state solutions [$F\to0$ as $r\to\infty$, and $F(0)=0$], which occur for specific values of $\en$.
To solve the bound-state (eigenvalue) problem, an initial $\en$ is guessed, and the DE is solved using the multi-step method.
Then, small adjustments are made to $\en$ until (a) we have the correct state ($n\k$) determined by the number of nodes of the orbital ($n-l-1$)~\cite{BetheBook}, and (b) we have the correct boundary conditions.

\begin{figure}
\centering
\includegraphics[width=0.4\textwidth]{img/H-SolveBS}
\caption{\small Hydrogen $1s$ orbital [$f(r)$], as calculated at the first though 7th iteration. 
For this example, the initial energy guess was $-0.3$\,au, and converged to $-0.500006566..$\,au to parts in $10^{-16}$ in 12 iterations.\label{fig:H-SolveBS}}
\end{figure}



It is common to expand the orbital around $r=0$ to start the procedure, and then adjust the energy until $F\to0$ at infinity.
%
A more numerically stable approach is to solve the DE twice, once starting from $r=0$, and once from $r=\infty$~\cite{JohnsonBook2007}.
These two solutions are stepped inwards toward some central point, where the two solutions are joined -- one of the two solutions is re-scaled so that $f_0=f_\infty$ at the defined point.
Small energy adjustments are made until the lower $g$ components also match at this point (this ensures the derivatives match, and the join is smooth).
In our case, the two solutions are not joined at a single point, but are instead ``meshed'' across a few ($\sim10$)  points around the classical turning point, defined via $V(r_{\rm ctp}) = \en$.
The meshing procedure acts to suppress numerical noise, and makes the method more stable.
This procedure typically allows convergence of the energies to parts in $10^{16}$;
see, e.g., Fig.~\ref{fig:H-SolveBS}.






Note that Eq.~(\ref{eq:dF}) does not determine the normalisation for $F$, so the solutions must be normalised explicitly [Eq.~(\ref{eq:ffrad})].
Further, the sign of $F$ is also arbitrary from Eq.~(\ref{eq:dF}); we choose $f(r)$ to be positive as $r\to 0$, as is standard.


Everywhere in the code, the fine structure constant is replaced with: $\alpha\to\lambda \alpha_0$ (in atomic units, $\alpha=1/c$), where $\alpha_0\approx1/137$.
The factor $\lambda$ is a run-time input option, that is 1 by default. 
For example, letting $\lambda\to0$ (i.e., $c\to\infty$) allows us to perform calculations in the non-relativistic limit.
This is a particularly useful option for checking the calculations, and for determining the sensitivity of particular observables to variations in the fine structure constant.
Modifications can also be made to the above equations to account for the finite electron/nucleus mass (reduced mass) -- but this is not implemented in the code.





%======================================================
\subsection[Radial grid]{Radial grid\label{sec:grid}\footnote{Radial grid defined in:~/src/Maths/Grid.hpp}}

The equations are solved numerically on a finite radial grid.
We define a grid on the region from $r_0$ to $r_{\rm max}$, that has $N$ points.
We don't use a uniformly spaced grid, since the wavefunctions vary very rapidly at small distances, but smoothly at large distances.
We define a non-uniformly-spaced radial grid ($r_i$) in terms of a uniformly spaced $u$ grid ($u_{i+1}=u_i+\delta u$).
In this case, integrals become:
\be
\int_{0}^{\infty} f(r)\,\d r \to 
\int_{r_0}^{\rm r_{max}} f(r)\,\d r \to 
\int_{u_0}^{u_{\rm max}} f(r(u))\frac{\d r}{\d u}\,\d u,
\ee
which numerically becomes:
\be
\int_{u_0}^{u_{\rm max}} f(r(u))\frac{\d r}{\d u}\,\d u \to
\sum_{i=0}^{N-1} f(r_i)\frac{\d r}{\d u}\Big|_i\,\delta u
\ee
(in the code we actually use a quadrature integration formula for the integrals).
The initial/final grid points and the grid spacings must be chosen such that the above numerical approximations are sufficiently accurate.

\begin{figure}
\centering
\includegraphics[width=0.43\textwidth]{img/Grids}
\caption{\small Radial distance $r_i$ as function of grid-point, $i$.\label{Fig:grids}}
\end{figure}



In the code, we can set either a logarithmic grid, defined:
\begin{align}
u &= \ln(r), \qquad
\frac{\d r}{\d u} = r,
\end{align}
or a mixed log-linear grid, defined: 
\begin{align}
u &= r + b \ln(r), \qquad
\frac{\d r}{\d u} = \frac{r}{r + b},
\end{align}
which is approximately logarithmic at small distances ($r<b$), and linear at large distances (typically $b$\,$\sim$\,10\,$a_0$); see Fig.~\ref{Fig:grids}.
The logarithmic grid works very well, and allows good convergence without requiring a large number of points.
However, it works less well for highly excited states, and is quite poor for continuum states with high energy.
The log-linear grid works well in a wide range of cases, but often needs more grid points to achieve the same numerical accuracy.






%======================================================
\subsection[Dirac equation involving inhomogeneous terms]{Dirac equation involving inhomogeneous or non-local terms (Green's Method)\footnote{Implemented:~/src/DiracODE/Adams\_Greens.hpp}}


This is a brief overview; for details see, e.g., Ref.~\cite{Arfken2013}.
Consider the inhomogeneous Dirac equation, with `source' term $S$:
\be\label{eq:Green-inhomog}
\left( h_{\rm l}- \en\right)F = S,
\ee
where $h_{\rm l}$ is a Dirac Hamiltonian involving only local potential terms.
We solve this for a normalisable $F$ using the Green's method for ODEs.
First, take the homogeneous equation:
\be\label{eq:Green-homog}
\left(h_{\rm l}- \en\right) G = 0,
\ee
which we solve (for a given energy $\en$) using the regular linear ODE multi-step methods from Sec.~\ref{sec:solveDirac}.
Note that since $F$ is a normalisable solution to (\ref{eq:Green-inhomog}) $G$ will {\em not} (in general) be a normalisable solution to (\ref{eq:Green-homog}) [i.e., $G$ is not regular at both the origin and infinity].
Instead, we seek two solutions, which are each bound by one of the boundary conditions; i.e., one solution that satisfies the boundary condition at the origin, $G_0$, and a second that satisfies that at infinity, $G_\infty$.
The normalisable solution to (\ref{eq:Green-inhomog}) that satisfies both boundary conditions is:
\begin{multline}\label{eq:GreensSolution}
F(r) = G_\infty(r) \int_0^r \frac{G_0(r')^T \, S(r')}{c\,w(r')}\,\d r'r'
\\
+  G_0(r) \int_r^\infty \frac{G_\infty(r')^T \, S(r')}{c\,w(r')}\,\d r',
\end{multline}
where $c=1/\alpha$. 
The Wronskian,
\be\label{eq:Green-Wronskian}
w(r) = f_\infty(r) g_0(r) - f_0(r)g_\infty(r),
\ee
should be independent of $r$.


Note that this method clearly doesn't work if $w=0$; worse, the method can be numerically unstable if $S$ and $w$ are both small (if $S$ is too small, it implies the $G_{0,\infty}$ solutions will be similar, and thus $w$ will be small).



%======================================================
\subsection{Continuum orbitals}

We are sometimes interested in continuum orbitals that are regular at the origin (see, e.g., Ref.~\cite{BetheBook}).
For continuum orbitals of the desired energy $\en>0$, we solve using the multi-step method described above, starting from the origin and integrating outwards.
Note that we do not have $F_c\to0$ at large $r$, and continuum orbitals cannot be normalised as above.
For most problems, however, we do require normalised orbitals.

We choose energy normalisation, such that
\be
\int_{\en-\delta\en}^{\en+\delta\en}\braket{\en' \k m|\en \k m}\,\d\en' = 1.
\ee
This equation cannot be used directly.
Instead, the solutions are normalised in analogy with analytic Coulomb (H-like) continuum states.
For Coulomb potentials, at large $r$ we have~\cite{BetheBook}:
\be\label{eq:cntm-norm}
f(r) \approx \sqrt{\frac{\alpha}{\pi \beta}}\,\sin(kr + \ldots),
\ee
with
$
\beta = \sqrt{{\en}/({\en + 2c^2})}
$
(other terms in the sine function are either constant, or logarithmic in $r$).
At large $r$, the atomic potential is also Coulomb-like.
We use (\ref{eq:cntm-norm}) to normalise the orbitals by enforcing the amplitude of the sine-like orbitals at large $r$ to match the analytic H-like solutions~\cite{BetheBook}.

To do this, we have to extend the radial grid out to very large distances, often much larger than the normal grid used to solve the bound-state orbitals.
The orbital is solved out to large $r$ until the amplitude/frequency of the oscillations becomes close enough to constant, and then the amplitude is re-scaled to match (\ref{eq:cntm-norm}).
After solving, the orbital is only kept up until $r_{\rm max}$, since larger distances typically do not contribute to any required radial integrals. 




%======================================================
\section[Coulomb Integrals]{Coulomb Integrals\label{sec:Coulomb}\footnote{Functions to calculate Coulomb integrals defined in:~/src/Coulomb/, and functions for angular coefficients are in:~/src/Angular/}}



Many problems will require the evaluation of matrix elements of the two-particle Coulomb interaction (see Appendix~\ref{sec:app-many-body-mes}).
The Coulomb integral $g_{abcd}$ can be expressed:
\begin{align}\label{eq:gabcd}
g_{abcd} 
&\equiv \bra{ab}r_{12}^{-1}\ket{cd}\notag\\
&=
\iint\d r_1^3\d r_2^3 \, \psidag_a(\v{r_1})\psidag_b(\v{r_2})\frac{1}{|\v{r}_{12}|}\psi_c(\v{r_1})\psi_d(\v{r_2}) .
\end{align}
To evaluate these integrals, the operator $\v{r}_{12}=|\v{r}_r-\v{r}_2|$ is expanded using the Laplace expansion:
\be
\frac{1}{\v{r}_{12}} = \sum_{k=0}^\infty \sum_{q=-k}^k\frac{r_<^k}{r_>^{k+1}}(-1)^q C^k_{-q}(\v{n}_1)C^k_{q}(\v{n}_2),
\ee
where $r_{<} \equiv \min(r,r')$, 
$k$ is called the multipolarity (with projection $q$),
and $C^k_{q}$ is a spherical tensor:
\be
C^k_{q} \equiv \sqrt{\frac{4\pi}{2k+1}}Y_{kq}(\v{n}).
\ee

Now, the radial and angular variables can be separated:
\begin{equation}\label{eq:gabcd2}
g_{abcd} = \sum_{kq} (-1)^q \bra{\k_a m_a}C^k_{-q}\ket{\k_c m_c} \bra{\k_b m_b}C^k_{q}\ket{\k_d m_d} R^k_{abcd},
\end{equation}
where $R^k_{abcd}$ (the radial Coulomb integral) is:
\begin{align}
R^k_{abcd} =& \int\d r_1 \, \left[f_a(r_1)f_c(r_1) + g_a(r_1)g_c(r_1)\right]\, y^k_{bd}(r_1),
\end{align}
and the symmetric one-body Coulomb integral is defined:
\be
y^k_{bd}(r) = \int_0^\infty \frac{r_<^k}{r_>^{k+1}}\left[f_b(r') f_d(r') + g_b(r') g_d(r')\right]\, \d r'
\ee
(note some other places call $y^k_{bd}(r)/r$ the Hartree screening function).
Note that $y^k$ may be called the effective one-body (radial) Coulomb operator, in that:
\be
({a}|y^{k}_{bd}|{c}) \equiv
\int F_a^\dag(r) y^{k}_{bd}(r) {F_c}(r)\,\d r =
R^k_{abcd}.
\ee

It is easy to see that $g$ is symmetric under interchange of coordinates and/or  initial/final states:
$g_{abcd} = g_{badc} = g_{cdab} = g_{dcba}$.
The $R^k_{abcd}$ integral and has more symmetries: $c\leftrightarrow a ,~ b\leftrightarrow d  ,~ (ac)\leftrightarrow (bd)$:
\begin{multline}
 R^k_{abcd} =R^k_{cbad} =R^k_{adcb} =R^k_{cdab} \\=R^k_{badc} =R^k_{bcda} =R^k_{dabc} =R^k_{dcba}.
\end{multline}
It is also convenient to define the anti-symmetrised Coulomb integral [see Eq.~(\ref{eq:G-twobody})]:
\be
 \widetilde g_{abcd} =  g_{abcd} -  g_{abdc}.
\ee


By making use of the Wigner-Eckart theorem, we can define ``reduced'' Coulomb integrals, which do not depend on magnetic quantum numbers (or projections).
%
We express them as
\begin{align}\label{eq:reduced-Coulomb}
g_{abcd} &\equiv \sum_{k} A^k_{abcd} \, Q^k_{abcd},\\
\widetilde g_{abcd} &\equiv g_{abcd} - g_{abdc} = \sum_{k} A^k_{abcd} \, W^k_{abcd},\label{eq:g-angred-2}
\end{align}
where $A^k_{abcd}$ depends on magnetic quantum numbers (and contains a sum over projections $q$), while $Q$ and $W$ do not.
Using the graphical formalism~\cite{Lindgren1986} (with Lindgren phase choice),
\begin{align}
A^k_{abcd} &= (-1)^{j_a-j_b} \,\,\eqdiagram{0.16}{img/angles/CK_abcd}.
%\\
%&= (-1)^{m_a+m_b+1}\sum_{q}(-1)^{k+q}\threej{j_a}{k}{j_c}{-m_a}{-q}{m_c}\threej{j_b}{k}{j_d}{-m_b}{q}{m_d}.
\end{align}
%(note that $C$ includes an implicit sum over $q$, the projection of $k$).
Explicitly,
\begin{multline}
 \eqdiagram{0.16}{img/angles/CK_abcd} = 
 %(-1)^{j_a-m_a}(-1)^{j_b-m_b}(-1)^{k} 
 (-1)^{j_a-m_a+j_b-m_b+k} 
 \times \\
\sum_{q}(-1)^{q}\threej{j_a}{k}{j_c}{-m_a}{-q}{m_c}\threej{j_b}{k}{j_d}{-m_b}{q}{m_d},
\end{multline}
where $(:::)$ is a Wigner 3$j$ symbol.


Using the rules for angular momentum manipulations~\cite{Varshalovich1988,Lindgren1986}, explicit equations for $Q^k$ and $W^k$ may be found:
%The reduced Coulomb integrals $Q^k$, $W^k$, and $P^k$ are thus defined:
\begin{align}
\label{eq:Qk}
Q^k_{abcd} &\equiv  (-1)^{k + j_a-j_b}C^k_{ac}C^k_{bd} R^k_{abcd}\\
%
%&= (-1)^k \widetilde C^k_{ac}\widetilde C^k_{bd}R^k_{abcd}\,\\
%
\label{eq:Wk}
W^k_{abcd} 
& \equiv Q^k_{abcd}  + P^k_{abcd}\\
\label{eq:Pk}
&\equiv Q^k_{abcd} + [k] \sum_\lambda \sixj{j_a}{j_c}{k}{j_b}{j_d}{\lambda}Q^\lambda_{abdc} 
\end{align}
(note the exchange of the final two indices {\em inside} the $P^k$ definition),
where $\{:::\}$ is a Wigner 6$j$ symbol, $[x]\equiv2x+1$,
\begin{align}
\label{eq:Ckab}
C^k_{ab}&\equiv \bra{\k_a}|C^k|\ket{\k_b} ,\\
%\equiv  (-1)^{j_a+1/2} \widetilde C^k_{ab} ,\\
&= (-1)^{j_a+1/2}\sqrt{[j_a][j_b]}\threej{j_a}{j_b}{k}{-1/2}{1/2}{0}\pi(l_a+l_b+k) ,
\end{align}
and $\pi(x)=1(0)$ if $x$ is even(odd) (parity selection rule).
%We defined $\widetilde C^k_{ab}$
% as a short-hand notation that is useful since $\widetilde C^k_{ab} = \widetilde C^k_{ba}$. 
Note that $C^k_{ab}$ is non-zero only if 
\begin{align}
|j_a-j_b|\leq k\leq j_a+j_b
\,,~\text{and}~ l_a + l_b + k~\text{is even}.
\end{align}

Our definition of $Q^k_{abcd}$  is convenient due to its symmetries: $c\leftrightarrow a ,~ b\leftrightarrow d  ,~ (ac)\leftrightarrow (bd)$ (same as $R$):
\begin{multline}
 Q^k_{abcd} =Q^k_{cbad} =Q^k_{adcb} =Q^k_{cdab} \\=Q^k_{badc} =Q^k_{bcda} =Q^k_{dabc} =Q^k_{dcba}.
\end{multline}
$P^k_{abcd}$ and $W^k_{abcd}$ are symmetric under the subset (same as $g$):
\be
P^k_{abcd} = P^k_{dcba} = P^k_{cdab} = P^k_{badc}.
\ee
%

Note that our $Q^k_{abcd}$ differs from $Q_k({acbd})$ defined in Ref.~\cite{DzubaHFS1984} by a factor $(-1)^{k+1}$ (and note the second and third indices are swapped).
Our $Q^k$ and $W^k$ are related to the $X_k$ and $Z_k$ of Ref.~\cite{Lindgren1986,JohnsonBook2007} via a 
%factor $(-1)^{j_a+j_b+1}$:
factor $(-1)^{j_a-j_b}$:
\begin{align}
X_k({abcd}) &\equiv  (-1)^k C^k_{ac}C^k_{bd} R^k_{abcd} \notag\\
  & = (-1)^{j_a-j_b}Q^k_{abcd}\\
 Z_k({abcd}) &=  (-1)^{j_a-j_b} W^k_{abcd}
\end{align}
Our definition is chosen to make full advantage of the symmetry.


It is also sometimes useful to define $Q^{k(\kappa_a)}_{bcd}(r)$, which has the form of a two-component radial spinor, such that
\be
(F_a|Q^{k(\kappa_a)}_{bcd}) = \int F_a(r)^\dag Q^{k(a\kappa_a)}_{bcd}(r)\,\d r = Q^k_{abcd}
\ee
(similar definitions can be made for $R$, $P$, $W$ etc.).
Note that we will often write $Q^{k(\kappa_a)}_{bcd}$ as $Q^{k(a)}_{bcd}$ for brevity, though note that it only depends on the $\kappa_a$, and not $n_a$.

%======================================================
\section[Hartree-Fock (self-consistent field method)]{Hartree-Fock (self-consistent field method)\footnote{Implemented in:~/src/HF/HartreeFock.hpp}}


The many-body atomic Hamiltonian may be expressed as
\be\label{eq:H-manybody}
H = \sum_i \hat h_{\rm 0}(\v{r}_i) + \sum_{i<j}\frac{1}{|\v{r}_i-\v{r}_j|},
\ee
where 
\[\hat h_0 = c \v{\alpha}\cdot\v{p} + c^2(\beta-1) +  V_{\rm nuc},\]
is the single-particle Dirac Hamiltonian including only the nuclear potential (see Sec.~\ref{sec:ManyBodyWavefunction}).
To solve the Dirac equation for an $N$ electron atom, we replace the complicated electron-electron repulsion term with an approximate potential, $V_{\rm avg}^{(i)}$, 
which is the average potential seen by the $i$th electron due to the other ($N-1$) electrons:
\be
H \approx \sum_i \left[ \hat h_{\rm 0}(\v{r}_i) + \hat V_{\rm avg}^{(i)}(\v{r}_i) \right].
\ee


For any general ``self-consistent field method'', we start with an initial approximation for the electronic potential (e.g., Thomas-Fermi potential, or a simple parametric potential), and use this to generate a set of orbitals for the desired subset of atomic electrons (e.g., the core).
The total electron density formed from these orbital tells us the electronic charge distribution across the atom, which we use to generate a new electronic potential (also accounting for the exchange interaction).
In general, this new potential will be a better approximation for the true electronic potential than the initial guess.
A new set of orbitals formed in this better potential will be a better set of orbitals, which we use to generate a better-yet potential and so on, until convergence is reached.
At the end, the potential used to form the electron orbitals should be the same as the potential that is formed from the electron orbitals, and is thus self-consistent.

\subsection{Relativistic Hartree-Fock method}

We start calculations from the relativistic Hartree-Fock (HF) method, which includes the electron exchange interaction.
In this approximation, the single-particle Dirac equation is
\be\label{eq:HF}
\left(h_{\rm HF} - \en\right) \phi(\v{r}) = 0,
\ee
with the Hartree-Fock Hamiltonian,
\be\label{eq:H-HF}
h_{\rm HF}  = c \v{\alpha}\cdot\v{p} + c^2(\beta-1) +  V_{\rm nuc} +  \hat V_{\rm HF}.
\ee
Here, $\hat V_{\rm HF}$ is the Hartree-Fock potential.
We consider mainly atoms with a single valence electron above closed shells, and take the Hartree-Fock potential to be the potential due to the $N-1$ core electrons.
This is called the $V^{(N-1)}$ potential. 

The form of the potential can be derived in a number of ways, for example, by defining the mean-field potential $u=V_{\rm HF}$ such that first-order perturbation corrections vanish (see, e.g.,~Ref.~\cite{JohnsonBook2007}).
It is found to be
\begin{multline}\label{eq:Vhf-vector}
\hat V_{\rm HF}\phi_a(\v{r}_1) = \sum_{i\neq a}^{N_c}\Bigg(
\int \frac{\phi_i^\dag(\v{r}_2)\phi_i(\v{r}_2)}{|\v{r}_{12}|}\d^3\v{r}_2\,\phi_a(\v{r}_1)\\
-\int \frac{\phi_i^\dag(\v{r}_2)\phi_a(\v{r}_2)}{|\v{r}_{12}|}\d^3\v{r}_2\,\phi_i(\v{r}_1)
\Bigg),
\end{multline}
where the sum over $i$ extends over all occupied electrons $i=\{n_i,\k_i,m_i\}$.
The first and second terms are the direct and exchange parts, respectively (the `Hartree' method neglects the exchange part).
The Coulomb integrals are computed by expanding ${r}_{12}^{-1}$ in terms of spherical harmonics (Laplace expansion) -- see Section~\ref{sec:Coulomb}.
Integrating over angles, and summing over $m$ quantum numbers we have:
\begin{align}
\label{eq:Vhf-radial}
\hat V_{\rm HF}F_a(r)& = \left(\sum_b [j_b] x_b  \,  y^0_{bb}(r)\right)F_a(r)
\notag \\  & \qquad\quad
-\frac{1}{[j_a]}\sum_b \sum_k \tilde x_b^{a,k}(C^k_{ba})^2\, y^k_{ba}(r) F_b(r)  \\
\label{eq:Vhf}
&\equiv V_{\rm dir}(r)\,F_a(r) + [\hat V_{\rm ex}F_a](r),
\end{align}
where now the $b$ sum extends over all occupied {\em orbitals} (i.e., $b=\{n_b,\k_b\}$), and 
$y_{ab}^k$  and $C^k_{ab}$ are defined in section \ref{sec:Coulomb}.
The $x_b$ term is the occupation fraction for core shell $b$ (typically $x_b=1$), and
$\tilde x^{a,k}_b = x_b$ except for $b=a$,\,$k=0$: $\tilde x^{a,0}_a = 1$; its inclusion allows an approximate treatment for open-shell systems\footnote{The $i$ sum in (\ref{eq:Vhf-vector}) includes a sum over all occupied $m$ states; for partially filled shells, this doesn't include all $m$ values. So, to do the sum, we assume each $m$ is filled with equal probability -- i.e., that each $m$ is partially filled.}.

First, the Hartree-Fock equations (\ref{eq:HF}), (\ref{eq:Vhf-vector}) are solved self-consistently for all the electrons in the core.
Since the HF potential depends on the electron orbitals (which depend on the HF potential), this equation must be solved iteratively, starting from an initial approximation for the potential.
Once the self-consistency is reached, the core orbitals are ``frozen''.
Then we do the same procedure for the valence electrons; the exchange part of the HF potential depends on the valence orbital, so these equations must also be solved iteratively.
Plots of the electron density ($\rho = \sum_n|\psi_n|^2$) for Cs are shown in Fig.~\ref{fig:ElectronDensity}, as calculated in varying approximations.



The Hartree-Fock method is the ideal starting point for many-body calculations, since all first-order corrections to the HF potential (i.e., corrections involving single electron excitations) cancel exactly~\cite{Lindgren1986}.
Corrections to energies and wavefunctions only arise at the second-order of perturbation theory.





\begin{figure}
\centering
\includegraphics[width=0.5\textwidth]{img/DensityPlot-Cs}
\caption{\small Electron density $\rho = \sum_n|\psi_n|^2$ for the core (solid line) and $6s$ valence (dashed line) electrons for Cs in the relativistic Hartree-Fock (HF), non-relativistic Hartree-Fock (HF-NR), and Hartree approximations. Relativistic effects ``pull'' the electrons closer to the nucleus, and the exchange interaction is crucial for valence states.\label{fig:ElectronDensity}}
\end{figure}






%-----------------------------------------------------------
\subsection{Numerically solving the HF equation}\label{sec:hf-orbital}

To solve the HF equation for a given orbital, we use the Green's method as outlined above.
The HF Hamiltonian is split in to local and non-local parts as $h_{\rm HF} = h_{\rm l}+V_{\rm nl}$, with
\begin{align}
h_{\rm l} &= h_0 + V_{\rm nuc}+fV_{\rm dir},\\
V_{\rm nl} &= (1-f)V_{\rm dir}+V_{\rm exch}.
\end{align}
Here,
\be
f=
\begin{cases}
(N_c - 1)/N_c & {\rm core} \\
 1 & {\rm valence}
\end{cases}
\ee
is chosen so that $V_{\rm l} = V_{\rm nuc} +f V_{\rm dir}\to -Z_{\rm ion}/r$ as $r\to\infty$ (otherwise, we would have $V_{\rm l}\to0$).
This is done to ensure the existence of the solution that is regular at infinity ($G_\infty$), and so that the asymptotic behaviour of the homogeneous solutions (\ref{eq:Green-homog})  match that of the final solution.

Then, the inhomogeneous equation has the form of Eq.~(\ref{eq:Green-inhomog}):
\be
\left( h_{\rm l}- \en\right)F = -V_{\rm nl}F.
\ee
Note that the ``source'' term in this case contains the solution $F$. 
So the equations must be solved iteratively, with some starting approximation for the source term, so that the solution at the $n$th step depends on the approximate solution from the previous step.
Further, $V_{\rm nl}$ and $h_{\rm l}$ also depend on the solution $F$ via (\ref{eq:Vhf}), and these are also formed at the $n$th step using $F^{(n-1)}$.
That is, the equation we solve at each iteration is
\begin{multline}\label{eq:inhomog-HF}
\left( h_0 + V_{\rm nuc} + fV_{\rm dir}^{(n-1)} - \en\right)F^{(n)} =
\\
 -\left( (1-f)V_{\rm dir}^{(n-1)}+V_{\rm exch}^{(n-1)} \right)F^{(n-1)}.
\end{multline}
%
The energy guess used for the $(n+1)$th step can be approximated from $\Delta V^{(n)} \equiv V_{\rm HF}^{(n)} - V_{\rm HF}^{(n-1)}$, as $\en^{(n)}+\delta\en$:
\be
\delta\en \approx  \frac{\bra{F^{(n-1)}} \Delta V \ket{F^{(n)}}}{\braket{F^{(n-1)}|F^{(n)}}}.
\ee


In general, these solutions will not be correctly normalised eigenstates of the HF Hamiltonian.
We therefore make small adjustments to the energy and orbital until $F$ is properly normalised and thus an eigenstate of the Hamiltonian. 
This procedure is outlined in the next subsection~\ref{sec:hf-adjustEn}.

Once the energy has been fine-tuned, and we have a normalised eigenstate, we continue the HF procedure.
To aid convergence, however, we first ``damp'' the orbitals as:
\be
F \to (1-\eta)F+ \eta F_{\rm old}.
\ee
This both increases the numerical stability, and speeds up the convergence. 
So long as the equations converge, the solutions do not depend on the value chosen.



%-----------------------------------------------------------
\subsection{Energy adjustments -- finding eigenstate}\label{sec:hf-adjustEn}



The above procedure finds a solution, $F_0$, to the HF equation (\ref{eq:inhomog-HF}) given the energy guess $\en_0$.
Since $\en_0$ is unlikely the correct eigen-state energy, this solution will not be properly normalised.
Assume the correct orbital and energy can be written as
$F_0 +  \delta F$, and
$\en_0 + \delta\en $.
Substituting this back into the HF equation, we find a new inhomogenous equation (to first order):
\begin{align}
(h_{\rm HF} - \en_0) \delta F &=  \delta\en F_0  \\
(h_{\rm l} - \en_0) \delta F &=  \delta\en F_0  - V_{\rm nl} \delta F,  \label{eq:HF-adjust-Green}
\end{align}
which we solve iteratively for $\delta F$ and $\delta \en$.
As the first step, we divide (\ref{eq:HF-adjust-Green}) by the unknown $\delta\en$, set $V_{\rm nl} \delta F=0$, and solve for $\tilde F\equiv\delta F/\delta\en$ using Green's method (\ref{eq:GreensSolution}).
Note that we don't need to re-solve the homogeneous equation (\ref{eq:Green-homog}), since we can re-use the $G_\infty$, $G_0$
solutions obtained when solving (\ref{eq:inhomog-HF}).

Since $(F+\delta F)$ must be normalised, we find the first guess for $\delta \en$ as (keeping only first-order terms):
\be
\delta \en = \frac{\braket{F|F} - 1}{2\braket{F|\tilde F}}.
\ee
Using  $\delta F = \delta\en\tilde F$, we form $V_{\rm nl} \delta F$ and solve (\ref{eq:HF-adjust-Green}) for $\delta F$.
Then, we make the corrections to the orbital and energy:
\be
F= F_0+\delta F \, , \qquad \en=\en_0 + \delta\en.
\ee
This iterative procedure is continued from Eq.~(\ref{eq:HF-adjust-Green}) until the energy correction drops below a specified value
(i.e., until $F$ is properly normalised).
This procedure is very rapid; e.g., $\delta\en/\en$ typically converges to parts in $10^{20}$ with just two iterations.

Note that, so long as it was chosen appropriately, the non-local term $V_{\rm nl}$ is small, and so the $V_{\rm nl}\delta F$ term is even smaller and can be excluded entirely in this section without having much of an impact.
Including it, however, leads to better overall convergence of the HF equations.
Note that $V_{\rm nl} \delta F$ includes $V_{\rm exch} \delta F$, which must be calculated.




%-----------------------------------------------------------
\subsection{Approximate ``local'' exchange potential}\label{sec:hf-approx}


There are several methods for obtaining a localised approximation to the HF potential, common  examples are the ``Hartree-Fock-Slater''~\cite{Slater1951}, and Kohn-Sham methods.
%
Here, I outline a different method that very well approximates the HF potential. 
We use this only as a starting point for the HF (and TDHF) procedure, so final result do not depend on this potential. 
A good choice of starting approximation does, however, speed up the convergence of the iterative procedures.

Introducing the notation $v^x_{ab}$ [see Eq.~(\ref{eq:Vhf-radial})], the non-local exchange part of the HF potential can be expressed
\be\label{eq:vex-vab}
 [\hat V_{\rm ex}F_a](r) = \sum_b v^x_{ab}(r) F_b(r).
\ee
Multiply (\ref{eq:vex-vab}) from the right and divide  by $ F_a^\dag F_a$:
\begin{align}
 \frac{[\hat V_{\rm ex}F_a] F_a^\dag }{F_a^\dag F_a} F_a
&= \frac{\sum_b v^x_{ab}(r) F_b(r)F_a^\dag(r) }{F_a^\dag F_a} F_a(r)\\
&\approx U^{(a)}_{\rm ex}(r)F_a(r).
\end{align}
In this way we may define $U^{(a)}_{\rm ex}(r)$, which is a localised exchange potential (for state $a$).
Note that $U(r)$ is different for each state, and depends on $F_a$, and therefore must be found iteratively.

This is numerically unstable when $F_a^\dag F_a$ is small.
However, when $F_a$ is small, the exchange potential is less important (only the combination $V_{\rm ex}F_a$ enters the equations).
We proceed by introducing a cut-off, $\lambda_a$, so that
\begin{align}
& U^{(a)}_{\rm ex}(r) =  
v^x_{aa}(r) + \sum_{b\neq a} v^x_{ab}(r) \Lambda(r),
\\
&\Lambda(r) = 
\begin{cases}\dfrac{F_a^\dag(r) F_b(r)}{F_a^\dag F_a} & |f_a(r)|>\lambda_a\\
0&\mathrm{otherwise}
\end{cases}.
\end{align}
%
We don't apply the cut-off for the $b=a$ term, since there is exact cancellation and no numerical instability.
This $a=b$ term gives the dominant contribution to the exchange potential. 
The reason this method gives such good results is that the dominating case is treated exactly.
%
In the code, the cut-off is taken as
$
\lambda_{a} = 10^{-2} |f_a|^{\rm max},
$
where  $|f|^{\rm max}$ is the maximum magnitude for the upper $f(r)$ component of $F_a$.
Making the cut-off too small introduces numerical instabilities.
%





%======================================================
\section[Algebraic solution to the Dirac equation (basis)]{Algebraic solution to the Dirac equation (basis)\label{sec:finite-basis}\footnote{Implemented in:~/src/Wavefunction/BSplineBasis.hpp}}

In many problems in perturbation theory, a summation over the full (infinite) set of orbitals is required.
In theory, a basis of HF orbitals can be used for this.
However, such a basis generally converges very slowly, requires a very large radial grid, and the solutions become numerically unstable for low energies.
Further, sum over all states must include the integral over all positive- and negative-energy continuum states.
%
Instead, it is common to introduce a finite basis for the radial Dirac equation, see, e.g., Ref.~\cite{Quiney1987,Johnson1988}.
%
We assert that all orbitals go to zero at the boundary of a subset of the radial grid, $r_{\rm max}$.
This is equivalent to placing the atom in the centre of an infinite spherical ``square-well'' potential.
In this case, a complete set of orbitals can be approximately expanded in terms of a finite number of discreet states.
So long as the size of the cavity is large compared to typical radius of orbitals we are directly interested in, the results should be independent of the cavity size.




%----------------------------------------------------------------
\subsection{B-spline basis}\label{sec:Bsplines}


\begin{table*}%[h]
\small
\centering
\caption{\small Comparison between energies of spline (DKB) basis orbitals and finite-difference Hartree-Fock orbitals.
The basis was constructed using 50 B-splines of order 7 in a cavity of radius 30\,$a_B$ with the first internal point at $r=10^{-5}\,a_B$ (only the first 10 splines of each symmetry are shown).
Final column shows the root-mean-square radii for the Hartree-Fock orbitals. The spline basis energies agree very well (better than parts in $10^6$) with the Hartree-Fock energies, so long as the cavity is large compared to the typical radius of the orbital in question; for higher orbitals, where this is not the case, the energies diverge significantly. [$\epsilon=(A-B)/A$]\label{tab:splines-energies}}
\begin{tabular}{l D{.}{.}{5.7} D{.}{.}{5.7} D{.}{}{3.3} D{.}{.}{2.2} l D{.}{.}{4.7} D{.}{.}{4.7} D{.}{}{3.3} D{.}{.}{2.2}}
\hline
\hline
 &  \multicolumn{4}{c}{$s_{1/2}$} &  &
   \multicolumn{4}{c}{$p_{1/2}$}  \\
\cline{2-5}\cline{7-10}
$n$ &  \multicolumn{1}{c}{$\en_{\rm spline}$} &  \multicolumn{1}{c}{$\en_{\rm HF}$} &\multicolumn{1}{c}{$\epsilon$}
 &\multicolumn{1}{c}{$\braket{r^2}^{1/2}_{\rm HF}$}& &\multicolumn{1}{c}{$\en_{\rm spline}$} &  \multicolumn{1}{c}{$\en_{\rm HF}$} &\multicolumn{1}{c}{$\epsilon$}
 &\multicolumn{1}{c}{$\braket{r^2}^{1/2}_{\rm HF}$}\\
\hline
1	& -1330.1186542	& -1330.1188558	& -2{\rm e}.-7	& 0.03	&& 	& 	& 	& \\
2	& -212.5644469	& -212.5644963	& -2{\rm e}.-7	& 0.12	&& -199.4294948	& -199.4295038	& -5{\rm e}.-8	& 0.10\\
3	& -45.9697097	& -45.9697486	& -8{\rm e}.-7	& 0.32	&& -40.4482937	& -40.4483086	& -4{\rm e}.-7	& 0.31\\
4	& -9.5127994	& -9.5128206	& -2{\rm e}.-6	& 0.74	&& -7.4462753	& -7.4462846	& -1{\rm e}.-6	& 0.77\\
5	& -1.4898011	& -1.4898044	& -2{\rm e}.-6	& 1.88	&& -0.9078963	& -0.9078975	& -1{\rm e}.-6	& 2.15\\
6	& -0.1273679	& -0.1273681	& -1{\rm e}.-6	& 6.52	&& -0.0856153	& -0.0856159	& -6{\rm e}.-6	& 8.65\\
7	& -0.055047	& -0.0551874	& -3{\rm e}.-3	& 14.58	&& -0.0411125	& -0.0420214	& -2{\rm e}.-2	& 18.16\\
8	& -0.0240059	& -0.0309525	& -3{\rm e}.-1	& 25.77	&& -0.0110954	& -0.0251205	& -8{\rm e}.-1	& 30.79\\
9	& 0.0147887	& -0.0198146	& 	& 40.11	&& 0.0314743	& -0.0167280	& 	& 46.56\\
10	& 0.0679063	& -0.0137713	& 	& 57.61	&& 0.0877553	& -0.0119427	& & 65.48\\
\hline
\hline
\end{tabular}
\end{table*}


\begin{table*}%[h]
\small
\centering
\caption{\small Magnetic dipole hyperfine constants $A$ (MHz) for single-particle $s$-state Cs orbitals (point-like nuclear magnetisation distribution). Calculated using the Hartree-Fock orbitals, and the DKB basis constructed using 50 B-splines of order 7 in a cavity of radius 50\,$a_B$, with varying first internal point ($A$ is sensitive to orbitals at small radial distances). [$\epsilon=(A-B)/A$]\label{tab:splines-hfs}}
\begin{tabular}{l D{.}{.}{1.9}  D{.}{.}{1.9} D{.}{}{2.6} | D{.}{.}{1.9} D{.}{}{2.6} | D{.}{.}{1.9} D{.}{}{2.6}}
\hline
\hline
 &   & 
\multicolumn{2}{c}{$r_0 = 10^{-4}\,a_B$} &
\multicolumn{2}{|c|}{$10^{-5}\,a_B$} &
\multicolumn{2}{c}{$10^{-6}\,a_B$} \\
\cline{3-8}
$n$ &  \multicolumn{1}{c}{$A_{\rm HF}$} & 
 \multicolumn{2}{c}{$A_{\rm Spline}$, $\epsilon$} & 
  \multicolumn{2}{|c|}{$A_{\rm Spline}$, $\epsilon$} & 
   \multicolumn{2}{c}{$A_{\rm Spline}$, $\epsilon$} \\
\hline
1	& 3.9180\E{7}	& 3.8361\E{7}	& -2.\E{-2}	& 3.9172\E{7}	& -2.\E{-4}	& 3.9179\E{7}	& -3.\E{-6}\\
2	& 4.6208\E{6}	& 4.5209\E{6}	& -2.\E{-2}	& 4.6199\E{6}	& -2.\E{-4}	& 4.6207\E{6}	& -3.\E{-6}\\
3	& 9.3463\E{5}	& 9.1437\E{5}	& -2.\E{-2}	& 9.3446\E{5}	& -2.\E{-4}	& 9.3462\E{5}	& -1.\E{-5}\\
4	& 1.9822\E{5}	& 1.9392\E{5}	& -2.\E{-2}	& 1.9819\E{5}	& -2.\E{-4}	& 1.9823\E{5}	& 4.\E{-5}\\
5	& 2.7987\E{4}	& 2.7380\E{4}	& -2.\E{-2}	& 2.7982\E{4}	& -2.\E{-4}	& 2.7988\E{4}	& 5.\E{-5}\\
6	& 1.4337\E{3}	& 1.4022\E{3}	& -2.\E{-2}	& 1.4334\E{3}	& -2.\E{-4}	& 1.4336\E{3}	& -4.\E{-5}\\
\hline
\hline
\end{tabular}
\end{table*}






The set of atomic orbitals are expanded as
\be
F_{n\k} = \sum_i^{2N} p_i S_i(r),
\ee
where $\{S_i\}$ are a set of $2N$ basis functions that form an approximately complete set over a sub-domain of the radial grid $[0,r_{\rm max}]$ ($N$ is defined this way because of the duel set of positive/negative energy Dirac solutions).
The $\{p_i\}$ expansion coefficients are found by diagonalising the set of basis functions with respect to the Hamiltonian matrix, equivalent to solving the (generalised) eigenvalue problem:
\begin{align}\label{eq:Hij-splines}
\sum_j\bra{S_i}\hat h_{\rm HF}\ket{S_j} p_j &= \en\,\braket{S_i|S_j} p_j.
\\
\sum_j h_{ij}p_j &= \en S_{ij}p_i.
\end{align}
There are $2N$ solutions of eigenvalues $\en$ with corresponding eigenvectors $\vec{p}$, which correspond to the spectrum of stationary states; $N$ of these correspond to negative-energy ($\en<-mc^2$) states.
If the $\{S\}$ set is orthonormal, $S_{ij}$ is just the identity; in general it is not.
Both $h_{ij}$ and $S_{ij}$ are positive-definite, real, symmetric matrices.
States of different $\k$ are orthogonal, so the $h_{ij}$ matrix can be chosen to be block diagonal (in $\k$); i.e.,\ the expansion may be performed separately for each $\kappa$. 







The choice of basis must account for the boundary conditions for the stationary states.
A good choice of basis allows for convergence of many-body problems with fewer basis states.
The particular choice we use is called the Duel-Kinetic-Balance (DKB) B-spline basis as introduced in Ref.~\cite{Beloy2008};
\be\label{eq:DKB}
S_i^{\rm DKB}= \begin{cases}
\twocomp{b_i(r)}{\frac{\alpha}{2}\left(\p_r+\kappa/r\right)b_i(r)}  &  0\leq i<N \\
\twocomp{\frac{\alpha}{2}\left(\p_r-\kappa/r\right)b_{i-N}(r)}{b_{i-N}(r)}   & N\leq i<2N.
\end{cases}
\ee
full details, including on including boundary conditions, 
are given in that work (see also~\cite{Johnson1988,AMBiT2018} and the review~\cite{Bachau2001}).
Note that the boundary conditions are met by discarding some of the underlying $b_i(r)$ b-splines; when we talk of an expansion using $N$ splines, we refer only to the ones that are kept; the underlying spline basis consists of a slightly larger set~\cite{Beloy2008}.
Another common choice, which we refer to as the Notre-Dame (ND) basis~\cite{Johnson1988} may be formed with the lower-component of (\ref{eq:DKB}) set to zero for $i<N$, and the upper set to zero for $i\geq N$; this set requires extra conditions for the boundary conditions to be met~\cite{Johnson1988}.

Each B-spline, $b_i^{(k)}(r)$, is a polynomial of order $k$ (degree $k-1$), that is non-zero only in the interval $t_i\leq r<t_{i+k}$, where $\{t_i\}$ are a set of $(N+k-2)$ ``knots'' (the $S_i$ basis orbitals are non-zero also only in this region).
The first ``interior'' knot is placed at $r_0$ and the last at $r_{\rm max}$\footnote{The actual first knot is placed at 0; the end knots are repeated $k$ times.}, and the rest are distributed uniformly along the $u$ radial grid (see Sec.~\ref{sec:grid}).
The piecewise nature of the splines simplifies the integrals, and makes $h_{ij}$ and $S_{ij}$ banded matrices, which can typically be solved with high numerical precision.


The basis orbitals are typically defined on a smaller sub-domain of the radial grid.
The benefit of restricting the radial sub-domain for the basis is that reasonable completeness can be achieved with fewer basis functions.
However, increasing $r_0$ too much degrades the low-$r$ behaviour of the basis orbitals, and making $r_{\rm max}$ too small loses the correspondence between the ``real'' and basis orbitals.
The ideal choice of sub-domain depends on the specifics of the problem.
%
Table \ref{tab:splines-energies} shows the energies of spline orbitals, using 50 B-splines of order 7 in a cavity of radius 30\,$a_B$ with the first internal point at $r=10^{-5}\,a_B$.
This spline basis is orthogonal (or normal) with respect to the Hartree-Fock core to parts in $10^6$; the basis itself is orthogonal to parts in $10^{15}$.
Table \ref{tab:splines-hfs} shows hyperfine constants calculated using spline orbitals, which is a test of the low-$r$ performance of the orbitals.\footnote{The input files used to generate these tables are provided in: /doc/examples/Cs\_testBasis.in}











%======================================================
\section[External fields \& matrix elements (RPA)]{External fields \& matrix elements (RPA)\footnote{Implemented in:~/src/ExternalField/}}

\subsection{Time-dependent Hartree-Fock}\label{sec:tdhf}


In the presence of a time-varying external field of frequency $\omega$,
\be
T^k_q = t^k_q \, e^{-i\w t} + t^{k\dag}_q e^{+i\w t} ,
\ee
where $t^k_q$ is an irreducible tensor operator of rank $k$ (projection $q$) and parity $\pi$, 
 the orbitals will contain time-varying perturbations:
\be\label{eq:tdhf-dPsi}
\phi \to \phi + \delta\phi(t) = \phi +  X e^{- i\w t}+ Y e^{ i\w t},
\ee
and $\en\to\en+\delta\en (e^{- i\w t}+ e^{ i\w t})$.
Keeping terms only to first-order in $t$, the corrections satisfy the equations (e.g.,~\cite{DzubaHFS1984}):
\begin{equation}\begin{split}
\label{eq:tdhf}
\left( h_{\rm HF} - \en -\w \right)X &= -\left( t^k_q + \delta V - \delta \en \right)\phi \\
\left( h_{\rm HF} - \en +\w \right)Y &= -\left({t^{k\dag}_q} + \delta V^\dag - \delta \en \right)\phi ,
\end{split}\end{equation}
and $\delta\en = \bra{\phi}{t^k_q} + \delta V\ket{\phi}$.
%
In general, these are called the ``mixed-states'' equations for orbital $\phi$.
In Eq.~\eqref{eq:tdhf}, $\delta V$ is the correction to the HF potential arising due to the corrections $\{X,\,Y\}$ to each of the core orbitals:
\be\label{eq:dV}
\delta V = V_{\rm HF}(\{\phi+\delta\phi\})-V_{\rm HF}(\{\phi\}).
\ee
Explicit formulas for $\delta V$ will be given later.
Note that Eqs.~\eqref{eq:tdhf} and \eqref{eq:dV} must be solved self-consistently for all the core orbitals to obtain $\delta V$; this is known as the time-dependent Hartree-Fock (TDHF) method.
The term $\delta V$ leads to important corrections to matrix elements known as core polarisation, which will be discussed further later.

Note that ${t^k_q}\phi_a$ is {\em not} (in general) a state of definite angular momentum, though {\em is} a state of definite parity, and contains terms with $j\in[j_a-k,\,j_a+k]$ and parity $\pi\cdot\pi_a$, where $\pi_a=(-1)^{l_a}$ is parity of state $\phi_a$.
To continue to work in the basis of definite angular momentum, we make use of the Wigner-Eckart theorem to define the {\em reduced projection} $[t^k\phi_a]_n$, which {\em is} a state of definite angular momentum (with $\kappa=\kappa_n$), such that:
\be\label{eq:mixedstates-proj}
{t^k_q}\phi_a = \sum_n(-1)^{j_n-m_n}\threej{j_n}{k}{j_a}{-m_n}{q}{m_a}
%\, \delta({\pi\cdot\pi_a,\pi_n}) 
\, \delta_{\pi\pi_a,\pi_n}\,
[{t^k\phi_a}]_n . 
\ee
Only terms allowed by the selection rules contribute to the sum:\ the 3$j$ symbol is zero unless the triangle rule  $\Delta(j_n,k,j_a)$ (and $m_n=q+m_a$) is satisfied, and the Kronecker delta encodes parity selection rule.
The coefficient in Eq.~\eqref{eq:mixedstates-proj} is chosen so that the inner-product of the projected state with $\phi_n$ gives the reduced matrix element of $t$:
\be
\braket{n|[{t^k\phi_a}]_n} = \bra{n}|t^k|\ket{a},
\ee
where the reduced matrix element is defined via
\be
\bra{n}t^k_q\ket{a} = (-1)^{j_n-m_n}\threej{j_n}{k}{j_a}{-m_n}{q}{m_a}\bra{n}|t^k|\ket{a}
\ee
The same definition is made for $\delta V$:
$
\braket{n|[{\delta V\phi_a}]_n} = \bra{n}|\delta V|\ket{a}.
$
Note that this choice of coefficient means that the reduced projection $[{t^k\phi_a}]_n$ is independent of the magnetic quantum numbers $m_a,m_n$ and projection $q$ due to the Wigner-Eckart theorem.

Of course, this means the correction $\delta\phi$ is also not (in general) a state of definite angular momentum (hence `mixed-states').
In the same way, we expand $X$ and $Y$ in terms of projected states $\chi$ and $\eta$ of definite $\k$:
\begin{equation}
\label{eq:dPsi-pw}
X^{a} = \sum_{n}(-1)^{j_n-m_n}\threej{j_n}{k}{j_a}{-m_n}{q}{m_a}
\, \delta_{\pi\pi_a,\pi_n}\,
\chi^a_{n}.
\end{equation}
%(To be consistent, we could have written $\chi^a_n = [X^a]_n$).
Here, the superscript refers to the unperturbed state that $X$ is a correction to, while the subscript refers to the angular quantum numbers of the corrections.
%The sum over $\alpha$ runs over all angular momentum states with $j_\alpha = j_a - k, ..., j_a+k$ and parity $\pi_\alpha = (-1)^{l_a + \pi}$ ($\pi$ is the parity of the operator $\hat h$).
Note that $\{\chi_n\}$ are orthogonal (and are orthogonal to $\phi_a$), and form a linearly independent set of solutions to (\ref{eq:tdhf}).
Therefore, the mixed-states equations can be re-cast in terms of states of definite angular momentum as:
\begin{align}
\left( h_{\rm HF} - \en_a -\w \right)\chi^a_n &= -[(t^k+\delta V)\phi_a]_n + [\delta\en_a]_n\\
\left( h_{\rm HF} - \en_a +\w \right)\eta^a_n &= -[(t^{k\dag}+\delta V^\dag)\phi_a]_n + [\delta\en_a]_n,
\end{align}
where we also defined
\be
[\delta\en_a]_n\equiv\bra{a}|h+\delta V|\ket{a}\,\delta_{an}.
\ee

The corrections may be expressed as:
\begin{equation}\begin{split}\label{eq:XiEtaSum}
\ket{X^a} &= \sum_{n\neq a}\frac{\ket{n}\bra{n}{t^k_q+\delta V}\ket{a}}{\en_a-\en_n+\omega}
\\
\ket{Y^a} &= \sum_{n\neq a}\frac{\ket{n}\bra{n}{t^{k\dag}_q+\delta V^\dag}\ket{a}}{\en_a-\en_n-\omega},
%\\
% \ket{\chi_\a} &= \sum_{n\neq a}\frac{\ket{n}\bra{n}|{\hat h+\delta V}|\ket{a}}{\en_a-\en_n+\omega}
% \,,~
% \ket{\eta_\a} = \sum_{n\neq a}\frac{\ket{n}\bra{n}|{\hat h^\dag+\delta V^\dag}|\ket{a}}{\en_a-\en_n-\omega},
\end{split}\end{equation}
and it is possible to calculate them that way.
Instead, we solve the mixed-states equations (\ref{eq:tdhf}) without the need for a basis.



%================================
\subsection[Solving the TDHF equations]{Solving the mixed-states equations\label{sec:tdhf-solve}\footnote{Functions for solving the mixed-states/TDHF equations are in:~/src/ExternalField/MixedStates.hpp}}

The $\delta V$ term in (\ref{eq:tdhf}) is very important and will be discussed in the next section. 
Here, we will ignore how it is calculated and just focus on solving the inhomogenous equations. 


As before, we express the Hamiltonian as $H =H_{\rm l} + V_{\rm nl} $: %, with
\begin{align}
H_{\rm l}&= H_0 + V_{\rm nuc} +  V_{\rm dir} +  U_{\rm x} \\
V_{\rm nl} &= V_{\rm exch} - U_{\rm x},
\end{align}
where $U_{\rm x}$ is a local approximation to the exchange potential.
In the simplest case it is $(f-1)V_{\rm dir}$, but better approximations aid the convergence (see Sec.~\ref{sec:hf-approx}).
%It is desirable to make  $V_{\rm nl}$ as small as possible.

We solve the equations iteratively, such that at the $n$th step:
\begin{multline}\label{eq:tdhf-its}
\left( H_{\rm l} - \en \pm\w \right)X^{(n)} =
 \\
 - (V_{\rm nl} X)^{(n-1)} - \left(t^k_q  + \delta V- \delta \en^{(n-1)} \right)\psi_a,
\end{multline}
with $V_{nl}X= 0$ initially.
From Eq.~(\ref{eq:GreensSolution}), the solution is
\be\label{eq:del-phi-tdhf}
X_\a = \frac{X_\a^\infty}{cw}\int_0^r\left\{X^0_\a|S\right\}\,r^2\d r'
+ \frac{X_\a^0}{cw}\int_r^\infty\left\{X^\infty_\a|S\right\}\,r^2\d r',
\ee
where $w$ is the Wronskian (\ref{eq:GreensSolution}), and $S$ is the rhs of Eq.~(\ref{eq:tdhf-its})
(the $\delta\en$ term only contributes for the $X$ term with $\a=a$).
The $X_\a^{0,\infty}$ orbitals here are the solutions with Dirac quantum number $\a$ to the homogenous equation (\ref{eq:Green-homog}). 
We defined here the ``partial'' matrix elements, that include only the integral over angular coordinates:
\be
\left\{\psi_a|t^k_q|\psi_b\right\} \equiv \int \psidag_a t^k_q\psi_b \,\d\Omega.
\ee




We similarly define the partial reduced matrix element:
\begin{align}\label{eq:partial-rme}
\left\{\psi_a|t^k_q|\psi_b\right\} &\equiv (-1)^{j_a-m_a}{\small\threej{j_a}{k}{j_b}{-m_a}{q}{m_b}}\left\{\psi_a||t^k||\psi_b\right\}.
\end{align}
Then, in terms of the partial waves ($\chi$), the solution becomes:
\be\label{eq:del-phi-tdhf2}
\chi_\a = \frac{\chi_\a^\infty}{cw}\int_0^r\left\{\chi^0_\a||S\right\}\,r^2\d r'
+ \frac{\chi_\a^0}{cw}\int_r^\infty\left\{\chi^\infty_\a||S\right\}\,r^2\d r'.
\ee
This is done so that we only need to calculate the ($m$-independent) {\rm reduced} matrix element of $\hat h$.
The radial integral $|\chi_\a|^2$ is used to control convergence (for including the exchange term).
Using $U_x$ from Sec.~\ref{sec:hf-approx}, convergence (for a given orbital) to parts in $10^9$ is typically reached in $\sim$\,10 iterations.
For the case that $\kappa_\alpha = \kappa_a$ (which only happens for even operators), one should explicitly ensure that $\chi_\alpha$ is orthogonal to $\psi_a$.

One may use the perturbation expression (\ref{eq:XiEtaSum}) to test the method.
Consider, e.g., (excluding $\delta V$)
\begin{align}
\label{eq:tdhf-test}
\braket{m|\chi} &= \frac{\bra{m}|t^k|\ket{\psi}}{\en-\en_m + \omega},
\end{align}
which can be calculated both ways (lhs vs rhs); see Table~\ref{tab:tdhf-test}.


\begin{table}%[h]
\small
\centering
\caption{\small Testing TDHF method using Eq.~(\ref{eq:tdhf-test}) for Cs, with $m=6p_{1/2}$, $\psi=6s_{1/2}$ (Hartree-Fock level, no $\delta V$).\label{tab:tdhf-test}}
\begin{tabular}{llll}
\hline
\hline
Operator&(\ref{eq:tdhf-test})~lhs&(\ref{eq:tdhf-test})~rhs&$\epsilon^*$\\
\hline
$h_{\rm E1}~~~(\omega=\omega_{\rm HF})$&63.2029312&63.2025676&6\E{-6}\\
$h_{\rm E1}~~~(\omega=0)$&126.405501&126.405135&3\E{-6}\\
$h_{\rm PNC}~(\omega=0)$&-1.0700928&-1.0700932&4\E{-7}\\
\hline
\hline
\end{tabular}
\\{\scriptsize$^*\epsilon \equiv (lhs-rhs)/lhs$}
\end{table}

An important application of this technique is that it allows calculations to be done without requiring a summation over the complete set of intermediate states (replaced by solving the inhomogeneous differential equation).
This method of performing exact summation over intermediate states is sometimes called the Solving Equations, Mixed States, or Dalgarno-Lewis method~\cite{Dalgarno1955}, depending on context.
In this example (\ref{eq:tdhf-test}) the intermediate-states summation is trivial, since it involves only single operator and hence only a single intermediate state contributes. 
In general, all intermediate states (including continuum and positive energy states) contribute, so this method allows calculations without the need for a large basis.


Another way to test the method is to consider the parity non-conservation (PNC) amplitude, which is a correction to the (otherwise forbidden) $E1$ transition between states of the same parity, due to the parity-violating weak interaction between the electrons and nucleus (see, e.g., Ref.~\cite{GingesRev2004}).
This can be expressed as a sum over all intermediate states $n$:
\be
E_{{\rm PNC}}^{(z)} = \sum_n\frac{\bra{B}\v{d}_z\ket{n}\bra{n}h_{\rm W}\ket{A}}{\en_{A}-\en_n} + \frac{\bra{B}h_{\rm W}\ket{n}\bra{n}\v{d}_z\ket{A}}{\en_{B}-\en_n},
\label{eq:pnc-se-ss}
\ee
where $\v{d}$ is the $E1$ operator, and $h_{\rm W}$ is the PNC operator.
Using the TDHF (Dalgarno-Lewis) method as described in Sec.~\ref{sec:tdhf}, this can also be expressed in two other formally equivalent ways:
\begin{align}
E_{{\rm PNC}}^{(z)} &= \bra{B}\v{d}_z\ket{\delta A^{(W)}} + \bra{\delta B^{(W)}}\v{d}_z\ket{A} \label{eq:pnc-se-dw}\\
&= \bra{\delta B^{(d)}}h_{\rm W}\ket{A} +  \bra{B}h_{\rm W}\ket{\delta A^{(d)}}\label{eq:pnc-se-dd},
\end{align}
where $\delta A^{(W/d)}$ is the correction to orbital $A$ due to the weak/E1 interaction.
%
Comparing the results of Eqs.~(\ref{eq:pnc-se-dw}) and (\ref{eq:pnc-se-dd}) tests the numerical accuracy of the Dalgarno Lewis (solving-equations) method, and comparing these to the result of (\ref{eq:pnc-se-ss}) gives a good test of the basis.
The two forms of the Dalgarno Lewis method agree to parts in $10^8$.
Comparison between the PNC amplitude as calculated using this and the direct-summation method is in Table~\ref{tab:pnc-basis}.



\begin{table}%[h]
\small
\centering
\caption{\small 
Comparison of PNC amplitudes (at the HF level) for $^{133}$Cs as calculated using the TDHF method, and direct summation using a spline basis [in a cavity of $(10^{-6},50)\,a_B$ using $N$ splines  of order $k$].\label{tab:pnc-basis}}
\begin{tabular}{lllll}
\hline
\hline 
&&\multicolumn{3}{c}{Direct Summation: $N/k$}\\
\cline{3-5}
Transition&TDHF&50/5&60/6&70/7\\
\hline
$6s-7s$&-0.73954&-0.73948&-0.73953&-0.73954\\
$6s-5d_{3/2}$&-2.4000&-2.3998&-2.4000&-2.4000\\
\hline
\hline
\end{tabular}
\end{table}



%======================================================
%======================================================




%======================================================
\subsection[Core polarisation (RPA)]{Core polarisation (RPA)\footnote{Implemented:~/src/ExternalField/CorePolarisation.hpp, TDHF.hpp}\label{sec:RPA}}

This section largely follows Ref.~\cite{DzubaHFS1984} (see also \cite{Dzuba2018a,Manakov1986,Johnson1980,Johnson1989}).
In the presence of an external field, the core electrons become perturbed (\ref{eq:tdhf-dPsi}), and a correction to the HF potential is induced.
This leads to important corrections to the matrix elements of the external field operator.
This effect is often called core polarisation, and is particularly important since it involves corrections with single excitations from the HF core (in the absence of an external field, the lowest-order corrections to the HF potential involve double excitations).
The method described here is often referred to as the random phase approximation (RPA).


To account for core polarisation, the set of TDHF equations (\ref{eq:tdhf}) are solved self-consistently for each of the core orbitals (see Sec.~\ref{sec:tdhf}).
%
The $\delta V$ term is the correction to the HF potential: 
\be\label{eq:delV-simple}
\delta V = V_{\rm HF}(\{\psi_b + \delta\psi^b\}) - V_{\rm HF}(\{\psi_b\}),
\ee
where $\{\psi_b\}$ denotes the set of all core orbitals.

The TDHF equations are solved iteratively, updating the $\delta V$ and $\delta \en$  terms at each step
until convergence is reached; i.e., at the $n$th step, we have
\begin{equation}\begin{split}
\label{eq:tdhf-rpa}
\left( h_{\rm HF} - \en -\w \right)X_\beta^{(n)} &= -\left(\hat h + \delta V^{(n-1)} - \delta \en^{(n-1)} \right)\psi_b,
\end{split}\end{equation}
with $\delta V=0$ for the initial iteration (similarly for $Y$).
The $\delta\en$ term only survives in the equations when $\b=b$ [see Eq.~(\ref{eq:del-phi-tdhf})].
% (which never occurs for odd-parity operators).



Combining Eqs.~(\ref{eq:delV-simple}) with (\ref{eq:tdhf-dPsi}), (\ref{eq:dPsi-pw}), and (\ref{eq:Vhf-vector}), we have:
\begin{multline}\label{eq:del-Vhf-vector}
\delta V\phi_a(\v{r}_1) = \\
\sum_{i\neq a}^{N_c}\int \frac{\d^3\v{r}_2}{|\v{r}_{12}|}
\Big(
\phi_i^\dag(\v{r}_2)\left[
X^i(\v{r}_2)\phi_a(\v{r}_1)
-\phi_a(\v{r}_2)  X^i(\v{r}_1)\right]\\
%
+Y^{i\dag}(\v{r}_2)\left[
\phi_i(\v{r}_2)  \phi_a(\v{r}_1)
-\phi_a(\v{r}_2) \phi_i(\v{r}_1)\right]
\Big).
\end{multline}
%
The reduced matrix elements of $\delta V$ are:
\begin{multline}\label{eq:dV-rme}
\bra{\phi_n}|\delta V|\ket{\phi_a}
 = 
 \sum_{b\beta}\frac{(-1)^{j_n-j_\beta+k}}{[k]} 
\left(
W^k_{nba\b} + W^k_{n\b'ab}\right),
\end{multline}
where the reduced Coulomb integrals $W^k$ are defined in section~\ref{sec:Coulomb}.
The sum $b$ runs over core orbitals, and $\beta$ runs over all corrections to $b$ [Eq.~(\ref{eq:dPsi-pw})].
The prime ($\beta'$) means the $\eta_\beta$ orbital is used; no prime means $\chi_\beta$.
The equation for $\bra{\phi_n}|\delta V^\dag|\ket{\phi_a}$ is the same, but with $\beta\leftrightarrow\beta'$.



The amplitude for a transition from state $v\to w$ in the TDHF method can be found from analogy with regular time-dependent perturbation theory (e.g.,~\cite{Sakurai2011}), where 
\[
\delta\psi_v(t) \simeq \frac{M_{wv}}{\en_v-\en_w+\w}\psi_be^{-i\w t}
\]
(keeping only the resonant term with $\w\approx\en_v-\en_w$).
At the same time, from Eq.~(\ref{eq:tdhf}), we have
\be
\braket{\psi_w | \delta\psi_v(t)} = \braket{\psi_w | X^v}e^{-i\w t}
= \frac{\bra{\psi_w} t^k_q + \delta V \ket{\psi_v}}{\en_v - \e_w + \w}e^{-i\w t}.
\ee
Combining leads to the expression: 
\be
M_{wv} = \bra{w}t^k_q + \delta V\ket{v}.
\ee
Since $\delta V$ was found self-consistently, the matrix elements include core polarisation  to all-orders~\cite{DzubaHFS1984,Dzuba1987jpbRPA}.
This is equivalent to the RPA method (see, e.g., Ref.~\cite{JohnsonBook2007}).
If the equations (\ref{eq:tdhf-rpa}) are solved just once (without iterations), it corresponds to the lowest (first) order correction to the amplitude, which are shown in Fig.~\ref{fig:corePol}.
Further iterations correspond to higher-orders.


\begin{figure}%[h]
\centering
\includegraphics[width=0.195\textwidth]{img/tdhf/meth-CP-direct2}~~~~~
\includegraphics[width=0.195\textwidth]{img/tdhf/meth-CP-direct1}\\
\includegraphics[width=0.195\textwidth]{img/tdhf/meth-CP-exchange1}~~~~~
\includegraphics[width=0.195\textwidth]{img/tdhf/meth-CP-exchange2}
\caption{\small Diagrams representing the lowest order direct and exchange core-polarisation (RPA) corrections to the $\bra{w}\hat h\ket{v}$ amplitude.
Wavy line is Coulomb interaction, dotted line is external field ($\hat h$). All internal lines are summed over: forwards lines are virtual excited states, backward lines are holes in the core.
In higher-order diagrams, each $\hat h$ vertex is corrected again by these four diagrams (RPA).\label{fig:corePol}}
\end{figure}



%%======================================================
%\subsubsection{Algebraic method}
%
%The THDF equations  can also be solved using an algebraic method, by expanding the $\chi$ and $\eta$ corrections over a basis of states:
%\be
%\chi^{\varkappa} = \sum_j a_j x_j \,, \qquad  \eta^{\varkappa} = \sum_j b_j x_j \,, \qquad
%\ee
%where $\{x_j\}$ is the set of basis orbitals, and $\{a_j/b_j\}$ are the expansion coefficients.
%Multiply Eq.~(\ref{eq:tdhf}) from the left by $x_i^\dag$ (and integrate), which yields the matrix equations:
%\begin{equation}\begin{split}\label{eq:TDHF-Matrix}
%\left[H_{ij} - (\en-\omega)S_{ij}\right] a_j &= -h_{ic} - \delta V_{ic} + \delta\en_{c}S_{ic}\delta_{\kappa_i\k_c} \\
%\left[H_{ij} - (\en+\omega)S_{ij}\right] b_j &= -h_{ic}^\dagger - \delta V_{ic}^\dagger + \delta\en_{c}S_{ic}\delta_{\kappa_i\k_c}.
%\end{split}\end{equation}
%Here,
%\begin{equation}\begin{split}
%H_{ij} &= \bra{x_i}\hat H_{\rm HF}\ket{x_j} \, , \qquad S_{ij} = \braket{x_i|x_j}\,,  \\
%h_{ic} &= \bra{x_i}|\hat h |\ket{\psi_c} \,,\qquad \delta\en_c = \bra{\psi_c}|\hat h + \delta V|\ket{\psi_c}, %+ \delta V?
%\end{split}\end{equation}
%$\delta V_{ic} $ is given by Eq.~(\ref{eq:dV-rme}), and the delta function means the $\delta\en$ term only appears for partial-wave corrections with $\kappa = \kappa_c$.
%
%There are two ways to proceed.
%The simplest way is to solve (\ref{eq:TDHF-Matrix}), which is a pair of linear matrix equations, for the set of expansion coefficients, $a_j$ and $b_j$.
%This must be solved for each partial wave correction ($\varkappa_i$) to each core state $c$.
%Note, however, that $\delta V$ depends on the corrected states, and thus on $a$ and $b$; so this would have to be solved iteratively.
%In another approach, the $\delta V$ term is also expanded in terms of the basis; then no iterations are required, and the equations take the form of a generalised eigenvalue problem, see Ref.~\cite{Johnson1989}.





%======================================================
\subsection[RPA diagram technique]{RPA diagram technique\footnote{Implemented in:~/src/ExternalField/DiagramRPA.hpp}\label{sec:RPA-diagram}}

The core polarisation correction to a matrix element can also be taken into account by directly evaluating the four diagrams in Fig.~\ref{fig:corePol}.
To lowest order, the matrix element of operator $\hat h$ is $h_{ij}^{(0)}$. 
The first-order correction is then~\cite{Lindgren1986}:
\begin{align}
\delta h_{ij} &= 
\sum_{ma}\frac{h_{am}^{(0)}\widetilde g_{imja}}{\en_a - \en_m - \omega}
+ \sum_{ma}\frac{h_{ma}^{(0)}\widetilde g_{iajm}}{\en_a - \en_m + \omega},
\label{eq:dh:rpa1}
\end{align}
where
$ \widetilde g_{abcd} =  g_{abcd} -  g_{abdc}$, with 
$g_{abcd}$ being the two-electron Coulomb matrix element (see appendix for definition).
The $a$ sum runs over all occupied core electrons ($n,\k,m$), while $m$ runs over all virtual excited states.

In the RPA method, the lowest-order matrix elements in $\delta h_{ij}$ (\ref{eq:dh:rpa1}) are then replaced with the corrected values. This process is repeated iteratively (for all core states $i$ and $j$) until convergence is reached; i.e., at the $n$th iteration we have:
\begin{multline}
\delta h_{ij}^{n} = \\
\sum_{ma}\Bigg(\frac{(h_{am}^{(0)}+\delta h_{am}^{n-1})\widetilde g_{imja}}{\en_a - \en_m - \omega}
+ \frac{(h_{ma}^{(0)}+\delta h_{ma}^{n-1})\widetilde g_{iajm}}{\en_a - \en_m + \omega}\Bigg).
\end{multline}

The reduced matrix element in the RPA approach is then:
\be
\bra{i}|h|\ket{j}^{\rm RPA} = \bra{i}|h|\ket{j} + \bra{i}|\delta h|\ket{j},
\ee
with
\begin{multline}
\bra{i}|\delta h|\ket{j} = 
\frac{1}{[k]}\sum_{am}(-1)^{j_a-j_i+k}\Bigg(
 \frac{\bra{a}|h|\ket{m}^{\rm RPA}W^k_{imja}}{\en_a-\en_m-\omega}\\
+ (-1)^{j_a-j_m}\frac{\bra{m}|h|\ket{a}^{\rm RPA}W^k_{iajm}}{\en_a-\en_m+\omega}
\Bigg),
\end{multline}
(sum is now over {\rm orbitals $n,\k$}).
RPA matrix elements between valence states have the same expression (the equations need only be iterated for the core electrons).
Note that $W$ depends only on the {\em rank} of the operator, so in theory, they need only be calculated once.
In practise, we only calculate $W^k_{imja}$ when $h_{am}\neq0$, meaning effectively that $W$ also depends on the operator parity.
It can be shown the diagram and TDHF methods are equivalent:
 $\bra{i}|\delta h|\ket{j}=\bra{i}|\delta V|\ket{j}$ [see Eq.~(\ref{eq:XiEtaSum})].




%======================================================
\subsection[Core polarisation (``basis'' technique)]{Core polarisation (``basis'' technique)\footnote{Implemented in:~/src/ExternalField/TDHFbasis.hpp}\label{sec:RPA-basis}}
%

Sometimes, the TDHF equations do not converge due to instabilities in solving the mixed-states equations (\ref{eq:tdhf}).
There are several ways to proceed in these cases, including using the diagram method as above, and using algebraic (matrix) techniques~\cite{Johnson1989}.
We also implement a method where the TDHF equations are solved using perturbation theory, by expanding the $\chi$ and $\eta$ functions over a basis using Eq.~(\ref{eq:XiEtaSum}). (Note that, unlike the matrix technique, this required iterations since the expansion depends on $\delta V$.)
Then, $\delta V$ remains as Eq.~(\ref{eq:dV-rme}).
This allows inclusion of the Breit effect into $\delta V$ (see Sec.~\ref{sec:Breit}) (which are not so simple to include in the diagram method).





%======================================================
\section[Correlation corrections]{Correlation corrections\footnote{Implemented in:~/src/MBPT/CorrelationPotential.hpp}}

Correlation corrections are the deviation from the pure single-particle picture, and correspond to many-body effects beyond the mean field (Hartree-Fock) approximation.
The many-body atomic Hamiltonian may be expressed as
\be
H = \sum_i h_{\rm HF}(\v{r}_i) + \delta V_{\rm corr},
\ee
where $h_{\rm HF}(\v{r}_i)$ is the single-particle HF Hamiltonian (\ref{eq:H-HF}), and
\be\label{eq:residCoul}
\delta V_{\rm corr} = \sum_{i<j}\frac{1}{\v{r}_{ij}} - \sum_iV_{\rm HF}(\v{r}_i)
\ee
is the {\em residual Coulomb interaction} (beyond the mean potential) that may be taken into account perturbatively.
We consider the case of an atom with a single valence electron ($v$) above closed shells.
In the single particle picture, this perturbation corresponds to residual interactions of the valence electron with the indevidual electrons in the core.
Starting from the Hartree-Fock method with a $V^{N-1}$ potential, there are no first-order corrections to the wavefunction (that is, corrections involving a single core excitation)~\cite{Lindgren1986}.


{\bf Notation:} I use the convention that letters at the beginning of the alphabet {${(a,\,b,\,...)}$} denote occupied core states (or holes),
those from the middle {${(n,\,m,\,...)}$} denote virtual excited states, and
those from the end {${(v,\,w,\,...)}$} denote valence states.
The letters {${(i,\,j,\,...)}$} are dummy indices that may stand for any state.



%--------------------------------------------------------------------------------------------
\subsection{Second-order correlations: Goldstone technique}\label{sec:Sigma2-goldstone}

\begin{figure}%[h]
\centering\tiny
\includegraphics[width=0.15\textwidth]{img/Sigma/Sigma2_a}~~~~~~~
\includegraphics[width=0.15\textwidth]{img/Sigma/Sigma2_b}
\includegraphics[width=0.15\textwidth]{img/Sigma/Sigma2_c}~~~~~~~
\includegraphics[width=0.15\textwidth]{img/Sigma/Sigma2_d}
\caption{\small Goldstone diagrams for the second-order correlation correction to the energy for valence state $v$. Backward facing lines denote (single-particle) states in the core; $n$ and $m$ are virtual excited states. Diagrams (a) and (c) are direct diagrams, (b) and (d) are corresponding exchange diagrams.\label{fig:Sigma2}}
\end{figure}

This section follows closely the method from Ref.~\cite{DzubaHFS1984}.
Goldstone diagrams for the second-order correction to the valence energy are shown in Fig.~\ref{fig:Sigma2}.
This can be expressed as~\cite{DzubaHFS1984,JohnsonBook2007}:
\begin{align}\label{eq:dE-SO}
\delta E_v &= 
\sum_{amn}
\frac{g_{vamn}\widetilde g_{nmav}}{\en_v+\en_a - \en_m-\en_n}
+\sum_{abn}
 \frac{g_{vnab}\widetilde g_{banv}}{\en_v+\en_n-\en_a-\en_b}  ,
\end{align}
where $m$ and $n$ run over (unoccupied) virtual excited states, and $a$ and $b$ run over (occupied) core states (there is an implicit sum over magnetic quantum numbers here).
The first term corresponds to the diagrams (a) and (b), the second to (c) and (d) [Fig.~\ref{fig:Sigma2}].
Integrating over angular coordinates, and summing over magnetic quantum numbers, gives~\cite{DzubaHFS1984}
\begin{align}\label{eq:dE-SO-red}
\delta E_v &=\sum_k \frac{1}{[k][j_v]}\Bigg(
 \sum_{amn} \frac{Q^k_{vamn}W^k_{vamn}}{\en_v+\en_a - \en_m-\en_n}
\notag\\&\qquad\qquad\qquad\qquad\qquad
+\sum_{abn}\frac{Q^k_{vnba}W^k_{vnba}}{\en_v+\en_n-\en_b-\en_a} 
 \Bigg),
\end{align}
where $Q^k,\,W^k$ and are given by Eqs.~(\ref{eq:Qk}), (\ref{eq:Wk}), and 
we used the symmetries and angular identities given in Section~\ref{sec:Coulomb}.




We define the {\em correlation potential}, $\hat \Sigma$, so that its matrix elements correspond to the energy shift: $\bra{v}\Sigma^{(2)}\ket{v} = \delta E_v$.
We may express the (energy dependent) second-order correlation potential as
\begin{multline}
\hat \Sigma^{(2)}_{\en} = 
\sum_{k}\frac{1}{[k][j_v]}\Big(
\sum_{amn}\frac{\ket{Q^{k(v)}_{amn}}\bra{W^{k(v)}_{amn}}}
{\en + \en_a-\en_m-\en_n}\\
+
\sum_{abn}\frac{\ket{Q^{k(v)}_{nba}}\bra{W^{k(v)}_{nba}}}
{\en + \en_n-\en_b-\en_a}
\Big),
\end{multline}
which is sometimes called the self-energy operator.
This has the form of a sum of operators,
which can be expressed in (radial) coordinate space as
\be
G^{(v)}_{nba}(r_1,r_2,\en) = \sum_{k}\frac{1}{[k][j_v]}
\frac{Q^{k(v)}_{nba}(r_1)\, W^{k(v)}_{nba}(r_2)}
{\en + \en_n-\en_b-\en_a}.
\ee
Thus the correlation potential may be expressed as
\begin{multline}
\Sigma^{(2)}_{\en}(r_1,r_2) = 
\sum_{abnm}\left[
G^{(v)}_{amn}(r_1,r_2,\en)
+
G^{(v)}_{nba}(r_1,r_2,\en)
\right].
\end{multline}

Note that $\Sigma$ is a matrix in (radial) spinor space:
\be
\Sigma \propto \matr{f_Q(r_1)f_W(r_2)}{f_Q(r_1)g_W(r_2)}{g_Q(r_1)f_W(r_2)}{g_Q(r_1)g_W(r_2)},
\ee
where $f$ and $g$ are the large and small components of the $Q/W$ radial spinors.
Each of these four terms can themselves be represented as square matrices (on a radial grid).
It is common to only calculate the first ($ff$) term; it is also common to store the $\Sigma$ matrix on only a subset of the radial grid.

%--------------------------------------------------------------------------------------------
\subsection{Correlation potential method (Brueckner orbitals)}



In the {\em correlation potential method}~\cite{DzubaPNC1984,DzubaPNC1985}, the non-local energy-dependent $\Sigma$ operator is added to the single-particle Hartree-Fock equation for the valence states:
\be\label{eq:H-Bru}
(h_{\rm HF} + \hat \Sigma_\en)\psi^{\rm (Br)} = \en^{\rm (Br)}\psi^{\rm (Br)}.
\ee
The resulting orbitals, known as Brueckner orbitals\footnote{Note that the exact definition of ``Brueckner'' orbitals varies slightly depending on the source; we use the definition from \cite{DzubaPNC1984}.}, include the second-order correlation effects.
This means, for example, the dominant correlation corrections can be included into the calculation of matrix elements simply by using the Brueckner orbitals, e.g., $\bra{a^{\rm HF}}{\hat v}\ket{b^{\rm HF}}\to\bra{a^{\rm Br}}{\hat v}\ket{b^{\rm Br}}$.
We will drop the (Br) superscript from here on unless it is necessary to avoid confusion.
The iterations of the Hartree-Fock equation for the valence state actually means that certain classes of diagrams are included to all orders; this is called the {\em chaining} of the self-energy operator.




The $\Sigma$ operator should be evaluated at the Hartree-Fock energy of the valence state.
The correlation potential depends only weakly on $\en_v$ [see Eq.~(\ref{eq:dE-SO})],
so it is often instead found at the energy of the lowest valence state $v$ of the given symmetry (since this is typically where the highest accuracy is required, and because the correlation corrections are larger for lower states).


One may also include the correlation corrections into a set of basis orbitals by adding the correlation potential to the Hartree-Fock Hamiltonian when solving the eigenvalue problem for the set of B-splines; i.e.,
\be
h_{ij} \to \bra{S_i}\hat h_{\rm HF}\ket{S_j}  + \bra{S_i}\hat \Sigma_\en\ket{S_j} 
\ee
in Eq.~(\ref{eq:Hij-splines}).
This leads to an (approximately) complete set of orbitals that include correlation effects.
These orbitals may then be used in calculations requiring a summation of a complete set of orbitals; so this method allows the inclusion of correlation corrections into such calculations in a reasonably simple way.


The correlation potential can also be taken into account in the TDHF method for the valence state (see Eq.~\eqref{eq:tdhf}):
\be
\left( h_{\rm HF} +\hat\Sigma_\en -  \en -\w \right)X = -\left(\hat t + \delta V - \delta \en \right)\psi_v.
\ee
This gives a means of including the correlation corrections into the Dalgarno-Lewis (Mixed-States) method.




%======================================
\section{Correlation potential: Feynman method}


In the previous section, I described the usual second-order many-body perturbation theory method using the Goldstone diagram technique.
Here, I outline an alternative approach: the Feynman method.
This method does not require a summation over intermediate states (i.e., no basis is required), but instead introduces an integral over frequencies.
Importantly, the Feynman method allows several classes of dominating higher-order corrections (Coulomb screening and the hole-particle interaction) to be included to all-orders by an exact summation of series of diagrams.
This section describes the method as developed in Ref.~\cite{DzubaCPM1988pla}, and follows that work closely; see also~\cite{Abrikosov1965,DzubaCPM1989plaEn,GingesCs2002}.

In this section, I will sometimes include subscripts on the Dirac bra/kets to indicate which coordinate they belong to.
I will also abuse the Dirac notation here so that $\ket{a}_1$ is just a short-hand for $\phi_a(\v{r_1})$; note that when the coordinate index is shown, there is no implied integration in the braket, e.g.:
\[
\bra{a}_1\ket{b}_1 = \phi^\dag_a(\v{r}_1)\phi_b(\v{r}_1),
~~ \text{while}\quad
\braket{a|b} = \int\d^3\v{r}'\phi^\dag_a(\v{r}')\phi_b(\v{r}').
\]


%------------------------------------------------------------------
\subsection{Feynman Green's function}

First, we introduce the Feynman Green's function, which can be expressed as (see \cite{DzubaCPM1988pla,Abrikosov1965} and references therein):
\be\label{eq:FeynmanGreen}
\hat G(\en) = \lim_{\delta\to0}\left(
\sum_a^{\rm core}\frac{\ket{a}\bra{a}}{\en-\en_a-i\delta} 
+ \sum_n^{\rm exc.}\frac{\ket{n}\bra{n}}{\en-\en_n+i\delta}\right).
\ee
Note that, if $\en$ is the (single-particle) ground-state energy, $\en>\en_a$, but $\en<\en_n$.
Conceptually, the simplest way to evaluate it is by summation over the complete set of core and excited orbitals using a pseudospectrum basis as described previously.
It is also, however, possible to evaluate the Green's function exactly (up to numerical errors) without the need for a basis.

Consider the inhomogeneous Hartree-Fock equation including the direct ($V_{\rm d}$) and exchange ($V_{\rm x}$) potentials, and its homogeneous counterpart (without exchange):
\begin{align}
(h_0 + V_{\rm d} - \en)\phi &= -V_{\rm x}\phi \\
(h_0 + V_{\rm d} - \en)\chi &= 0,
\end{align}
with $\chi_0$ being the homogeneous solution regular at the origin, and $\chi_\infty$ that regular at infinity.
The local Green's function (without exchange) can be expressed in coordinate space as:
\be
\hat G_0 \equiv  G_0(\v{r}_1,\v{r}_2) = \frac{\chi_0(r_<,\vhat{n})\chi_\infty(r_>,\vhat{n})}{w},
\label{eq:Green-direct}
\ee
where $r_<=\min(r_1,r_2)$, and $w=(f_0 g_\infty - f_\infty g_0)/\alpha$ ($w$ is independent of $r$, and $f,g$ are radial components of $\chi$).
Exchange can be taken into account by solving the Dyson equation~\cite{DzubaCPM1989plaEn,Abrikosov1965}
\begin{align}
\hat G &= \hat G_0 +  \hat G_0 \hat V_{\rm x}  \hat G = \left[ 1-  \hat G_0 \hat V_{\rm x}\right]^{-1}\hat G_0 .
\label{eq:Green-exchange}
\end{align}
The local direct and non-local exchange operators are
\begin{align}
\hat V_{\rm d} =  \sum_a^{\rm core}{\bra{a}\hat Q\ket{a}},
\quad\text{and}\qquad
\hat V_{\rm x} = - \sum_a^{\rm core}{\ket{a}\hat Q\bra{a}},
\end{align}
respectively, with the (two-particle) Coulomb operator:
\be\label{eq:CoulombOperator}
\hat Q(\v{r}_1,\v{r}_2) = \v{r}^{-1}_{12}.
\ee

These operators may be represented as coordinate matrices: e.g., $\hat G$\,$\Leftrightarrow$\,$G(\v{r}_1,\v{r}_2)$.
Multiplication is understood to mean:
 \[
 \hat W = \hat X \hat Y \hat Z \Rightarrow W(r_1, r_2) =  \iint \d r_i \d r_j X(r_1, r_i) Y(r_i, r_j) Z(r_j, r_2).
 \]
Note that $G$, $Q$, $V$ etc.\ are symmetric.

%------------------------------------------------------------------
\subsection{Two useful integrals}

Here, I present two useful analytic integrals involving Feynman Green's functions.
These are evaluated analytically by extending the integral over the complex plane.
As a reminder, Cauchy's integral formula is
\[
\oint \d z \frac{f(z)}{z-a} = 2\pi i f(a).
\]

The first integral\footnote{Note $|G(\w)|\to0$ as $|\w|\to\infty$ ($\w\in\mathbb{C}$); see Eq.~(\ref{eq:FeynmanGreen}).}
\begin{align}
\int \frac{\d \w}{2\pi}&\hat G_{12}(\en_i+\w) \hat G_{34}(\en_j + \omega)\\
=&\sum_{abnm}\int \frac{\d \w}{2\pi} \left(
\frac{\ket{a}_1\bra{a}_2}{\en_i+\w-\en_a-i\delta} + \frac{\ket{n}_1\bra{n}_2}{\en_i+\w-\en_n+i\delta}
\right)
\notag\\&\times
\left(
\frac{\ket{b}_3\bra{b}_4}{\en_j+\w-\en_b-i\delta} + \frac{\ket{m}_3\bra{m}_4}{\en_j+\w-\en_m+i\delta}
\right),
\label{eq:GreenIntegral1}
\end{align}
can be expanded to four seperate terms, each with a pair of poles.
%
Consider the first (``$a,b$'') term of (\ref{eq:GreenIntegral1}):
\be
\int \frac{\d \w}{2\pi} \left(
\frac{\ket{a}\bra{a}}{\en_i+\w-\en_a-i\delta} 
\right)
\left(
\frac{\ket{b}\bra{b}}{\en_j+\w-\en_b-i\delta} 
\right),
\ee
which has poles at $\w=\en_{a/b}-\e_{i/j}+i\delta$.
By closing the contour in the lower complex plane (Fig.~\ref{fig:contour}, left), it is seen the integral is zero.
The same is found for the last (``$n,m$'') term by closing in the upper plane.
The other two terms are non-zero, and can be evaluated by closing in (e.g.) the upper plane; an example for the ``$a,m$'' term with pole at $\w=\en_a-\en_i+i\delta$ is given in Fig.~\ref{fig:contour} (right).
Together, this gives the final expression:\footnote{I renamed $m=n$ in the first term, and $b=a$ in the second.}
\begin{align}
\int \frac{\d \w}{2\pi}&\hat G_{12}(\en_i+\w) \hat G_{34}(\en_j + \omega)\notag\\
&=
i\sum_{an}\left[
\frac{\ket{a}_1\bra{a}_2 \, \ket{n}_3\bra{n}_4}{\en_j-\en_i+\en_a-\en_n}
+
\frac{\ket{n}_1\bra{n}_2 \, \ket{a}_3\bra{a}_4}{\en_i-\en_j+\en_a-\en_n}
\right].\label{eq:GreenInt1}
\end{align}




\begin{figure}%[h]
\centering
\includegraphics[width=0.195\textwidth]{img/contour_1}~~~~
\includegraphics[width=0.195\textwidth]{img/contour_2}
\caption{\small Contours for the ``$a,b$'' and ``$a,m$'' terms of Eq.~(\ref{eq:GreenIntegral1}).\label{fig:contour}}
\end{figure}

The second integral is found in the same way:
\begin{align}
\int \frac{\d \w}{2\pi}&\hat G_{12}(\en_i+\w) \hat G_{34}(\en_j - \omega)\notag\\
&=
i\sum_{abnm}\left[
\frac{\ket{a}_1\bra{a}_2 \, \ket{b}_3\bra{b}_4}{\en_i+\en_j - \en_a - \en_b}
-
\frac{\ket{n}_1\bra{n}_2 \, \ket{m}_3\bra{m}_4}{\en_i + \en_j - \en_m - \en_n}
\right].
\label{eq:GreenInt2}
\end{align}



%------------------------------------------------------------------
\subsection{Feynman method for second-order correlations}



The second-order correlation corrections are given by the diagrams presented in Fig.~\ref{fig:Sigma2-Feyn}.
The electron loop in Fig.~\ref{fig:Sigma2-Feyn} (1) may be written in terms of the polarisation operator:
\be\label{eq:PolarisationOperator}
\hat\Pi_{12}(\w) \equiv \int \frac{\d \en'}{2\pi}\hat  G_{12}(\en') \hat G_{21}(\w+\en') .
\ee
Note that this is a (largely) non-relativistic many-body problem; the polarisation is of the atomic core, not the vacuum, and relativistic corrections to the Coulomb operator can be excluded (see Breit and QED corrections discussed later).
In this formalism, Feynman diagrams carry a phase factor of~\cite{Abrikosov1965}
\be\label{eq:phaseFactor}
i^{N_{Q}}(-1)^{N_{l}},
\ee
where $N_{Q}$ is the number of Coulomb (wavy) lines, and $N_{l}$ is the number of closed loops.


\begin{figure}%[h]
\centering
\includegraphics[width=0.235\textwidth]{img/Sigma/Feynman_dir}
\includegraphics[width=0.235\textwidth]{img/Sigma/Feynman_exch}
\caption{\label{fig:Sigma2-Feyn}\small Second-order direct (1) and exchange (2) correlation diagrams in the Feynman technique.
The straight lines represent Hartree-Fock (bound-electron) Green's functions (\ref{eq:FeynmanGreen}),
the wavy photon lines represent the (non-relativistic) Coulomb operator (\ref{eq:CoulombOperator}).
}
\end{figure}


Using Eq.~(\ref{eq:GreenInt1}), the integral over frequencies in the polarisation operator can be performed analytically, yielding:
\be\label{eq:PiGreen2}
\hat\Pi(\w) = i\sum_{an}\left[
\frac{\ket{a}_2\bra{a}_1 \, \ket{n}_1\bra{n}_2}{\en_a-\w-\en_n}
+
\frac{\ket{n}_2\bra{n}_1 \, \ket{a}_1\bra{a}_2}{\en_a+\w-\en_n}
\right],
\ee
which can be further simplified to:
\be\label{eq:PiGreen}
\hat\Pi(\w) = i\sum_a \ket{a}\left[\hat G^{\rm ex}(\en_a -\w) +  \hat G^{\rm ex}(\en_a +\w)\right]\bra{a}.
\ee
Here, $\hat G^{\rm ex}\equiv\hat G-\hat G^{\rm core}$ only includes excited orbitals, and may be formed without the use of a basis using Eqs.~(\ref{eq:Green-exchange}) and (\ref{eq:FeynmanGreen}), so long as the core orbitals are known.
It is more numerically stable to calculate it as:
\be\label{eq:Gex}
\hat G^{\rm ex} =  \hat G - \sum_a^{\rm core} \ket{a}\bra{a}\hat G.
\ee


With these, the direct (d) and exchange (x) correlation potentials can be expressed in the Feynman approach as
\be\label{eq:FeynDir}
\hat\Sigma^{(2)}_{\rm d}
= \iint\d^3 r_i\d^3 r_j
\int\frac{\d\w}{2\pi}\hat G_{12}(\en+\w)\hat Q_{1i}\hat\Pi_{ij}(\w)\hat Q_{j2},
\ee
and
\begin{multline}\label{eq:FeynExch}
\hat\Sigma^{(2)}_{\rm x}
= -\iint\d^3 r_i\d^3 r_j
\iint\frac{\d\w_1}{2\pi}\frac{\d\w_2}{2\pi}\\
\hat G_{1i}(\en+\w_1)\hat Q_{1j} \hat G_{ij}(\en+\w_1+\w_2)\hat Q_{i2}\hat G_{j2}(\en+\w_2).
\end{multline}
The signs are due to Eq.~(\ref{eq:phaseFactor}).
In the Feynman technique, as compared to the Goldstone technique, we avoid the need for a summation over the complete set of states, but instead require integration over frequencies.
Note that $\Sigma = \Sigma_{\rm d} + \Sigma_{\rm x}$ is also called the self-energy operator.
Comparison between the Feynman and Goldstone corrections shown in Table~\ref{tab:de-direct}.
Note that the Feynman direct diagram is calculated {\em much} faster than the Goldstone one when a large basis is required




%------------------------------------------------------------------
\subsection{Feynman to Goldstone transformation}




\begin{table}%[h]
\small
\centering
\caption{\small 
Expectation values of the direct part of the correlation potential $\bra{v}\Sigma_d\ket{v}$ for the lowest valence states of Cs (atomic units).
The first four rows correspond to the second-order Goldstone technique using various number of states in the MBPT expansion, and the fifth row is the second-order Feynman technique.
The final two rows are the screening and hole-particle corrections (see below).
%$l_{\rm max}=6$.
\label{tab:de-direct}}
\begin{tabular}{lrrrrr}
\hline
\hline
           & $6s_{1/2}$  & $6p_{1/2}$  & $6p_{3/2}$  & $5d_{3/2}$  & $5d_{5/2}$  \\
\hline
30spdfghi  & -0.01906 & -0.00771 & -0.00693 & -0.01226 & -0.01182 \\
40spdfghi  & -0.01915 & -0.00768 & -0.00690 & -0.01228 & -0.01182 \\
50spdfghi  & -0.01919 & -0.00769 & -0.00691 & -0.01230 & -0.01184 \\
60spdfghi  & -0.01920 & -0.00769 & -0.00691 & -0.01230 & -0.01184 \\[0.15cm]
%
Feynman & -0.01920 & -0.00766 & -0.00689 & -0.01236 & -0.01190 \\[0.15cm]
%
$\delta$Screen & 0.00631  & 0.00246  & 0.00221  & 0.00331  & 0.00313  \\
$\delta$h-p     & -0.00769 & -0.00359 & -0.00322 & -0.00477 & -0.00457 \\
%All-order  & -0.01561 & -0.00649 & -0.00584 & -0.01101 & -0.01067\\
\hline
\hline
\end{tabular}
\end{table}








Here, we show the connection between the Feynman and Goldstone approaches, by demonstrating the Feynman expressions reduce to the Goldstone ones by integration over frequencies.

Inserting (\ref{eq:PiGreen}) into the direct term (\ref{eq:FeynDir}), we get
\begin{multline}
\Sigma^{(2)}_{\rm d}
= i\iint\d^3 r_i\d^3 r_j
\int\frac{\d\w}{2\pi}
\hat G_{12}(\en+\w) \hat Q_{1i}\hat Q_{j2}\\
\times \sum_a\Bigg(
\ket{a}_2\bra{a}_1\hat G^{\rm ex}_{12}(\en_a-\w)
+\ket{a}_1\bra{a}_2\hat G^{\rm ex}_{21}(\en_a+\w)
\Bigg).
\end{multline}
%
The two required frequency integrals:
\begin{align}
\begin{split}
\int \frac{\d \w}{2\pi}\hat G_{12}(\en+\w) \hat G^{\rm ex}_{ij}(\en_a - \omega)
&=
-i\sum_{nm}
\frac{\ket{n}_1\bra{n}_2 \, \ket{m}_i\bra{m}_j}{\en+ \en_a - \en_m - \en_n},
\\
\int \frac{\d \w}{2\pi}\hat G_{12}(\en+\w) \hat G^{\rm ex}_{ji}(\en_a + \omega)
&=
-i\sum_{bn}
\frac{\ket{b}_1\bra{b}_2 \, \ket{n}_j\bra{n}_i}{\en - \en_a - \en_b + \en_n},
\end{split}
\end{align}
are evaluated using Eqs.~(\ref{eq:GreenInt2}) and (\ref{eq:GreenInt1}), respectively, noting that only the excited states appear in the expansion for $G^{\rm ex}$.
%
Bringing these together, and evaluating the direct matrix element  (using notation $\ket{ab}_{12}=\ket{a}_1\ket{b}_2$), we have:
\begin{align}
\delta\en_v^{\rm d}&=\bra{v}\Sigma^{(2)}_{\rm d}\ket{v}\notag\\
&=\sum_{anm}\frac{\bra{va}Q\ket{nm} \bra{mn}Q\ket{av}}{\en+\en_a-\en_m-\en_n}
+\sum_{abn}\frac{\bra{vn}Q\ket{ba} \bra{ab}Q\ket{nv}}{\en-\en_a-\en_b+\en_n} \notag\\
&=\sum_{anm}\frac{g_{vanm}g_{mnav}}{\en+\en_a-\en_m-\en_n}
+\sum_{abn}\frac{g_{vnba}g_{abnv}}{\en-\en_a-\en_b+\en_n},
\end{align}
which is the expression from Goldstone diagrams (a) and (c).




For the exchange term, we first integrate over $\w_1$, with:
\begin{align}
&\int\frac{\d\w_1}{2\pi}
\hat G_{1i}(\en+\w_1) \hat G_{ij}(\en+\w_1+\w_2) 
\notag\\
&= i\sum_{an}\left(
\frac{\ket{a}_1\bra{a}_i\ket{n}_i\bra{n}_j}{\w_2+\en_a-\en_n}+\frac{\ket{n}_1\bra{n}_i\ket{a}_i\bra{a}_j}{-\w_2+\en_a-\en_n}
\right)
\notag\\
\label{eq:ExchInt1}
&=  i\sum_{a}\left[
\ket{a}_1\bra{a}_i \, \hat G^{\rm ex}_{ij}(\en_a+\w_2)+ \hat G^{\rm ex}_{1i}(\en_a-\w_2) \, \ket{a}_i\bra{a}_j 
\right]\\
& \equiv  i \, \hat\Gamma_{1iij}(\w_2)
\label{eq:ExchInt1-Gamma}
\end{align}
which was evaluated using Eq.~(\ref{eq:GreenInt1}).
The $\Gamma_{1iij}$ term is defined for notational brevity; note the similarity+difference to $\Pi_{ij}$.
This leads to two seperate integrals over $\w_2$:\
\begin{align}
\small
\begin{split}
\int \frac{\d \w_2}{2\pi}\hat G^{\rm ex}_{ij}(\en_a+\w_2) \hat G_{j2}(\en+\omega_2)
&=
i\sum_{bn}
\frac{\ket{n}_i\bra{n}_j \ket{b}_j\bra{b}_2}{\en_a - \en + \en_b - \en_n},
\\
\int \frac{\d \w_2}{2\pi}\hat G^{\rm ex}_{1i}(\en_a-\w_2) \hat G_{j2}(\en+\omega_2)
&=
i\sum_{nm}
\frac{\ket{m}_1\bra{m}_i\ket{n}_j\bra{n}_2 }{\en_m + \en_n-\en - \en_a },
\end{split}
\end{align}
which were evaluated using Eqs.~(\ref{eq:GreenInt1}) and (\ref{eq:GreenInt2}), respectively.
%
Finally, combining all the terms, we have:
\begin{align}
\delta\en_v^{\rm x}&=\bra{v}\Sigma^{(2)}_{\rm x}\ket{v} \notag\\
&=-\sum_{abn}\frac{\bra{vn}Q\ket{ab} \bra{ab}Q\ket{vn}}{\en-\en_a-\en_b+\en_n}
-\sum_{anm}\frac{\bra{va}Q\ket{mn} \bra{mn}Q\ket{av}}{\en+\en_a-\en_m-\en_n} \notag\\
&=-\sum_{anm}\frac{g_{vnab}g_{abvn}}{\en-\en_a-\en_b+\en_n}
-\sum_{abn}\frac{g_{vman}g_{mnav}}{\en+\en_a-\en_m-\en_n},
\end{align}
which is exactly the expression from Goldstone diagrams (d) and (b), respectively (note that $g_{ijkl}=g_{jilk}$).




%------------------------------------------------------------------
\subsection{Angular separation}


Using the same angular identities used for the Goldstone case:
\begin{align}
\sum_{m_{i,j,k,l}}  g_{ijkl} \, g_{lkji}
    &= \sum_\mu \frac{1}{[\mu]} \left( C^\mu_{ik}C^\mu_{jl} R^\mu_{ijkl}\right)^2 \\
\sum_{m_{i,j,k,l}}  g_{ijkl} \, g_{klji}
        &=\sum_{\mu \lambda}(-1)^{\mu+\lambda+1}\, C^\mu_{ik}C^\mu_{jl}C^\lambda_{il}C^\lambda_{jk} \notag \\
    &\phantom{=\sum_{\mu \lambda}}~~\times \sixj{j_i}{j_k}{\mu}{j_j}{j_l}{\lambda}R^\mu_{ijkl}R^\lambda_{ijlk}\\
            &=\sum_{\mu \lambda}(-1)^{\mu+\lambda+1} \, L^{\mu\lambda}_{ijkl} \, R^\mu_{ijkl}R^\lambda_{ijlk},
\end{align}
where $L^{k\lambda}_{ijkl}$ is defined for convenience in the last line,
the correlation potential (for angular state $\k_v$) can be written:
\begin{align}
\Sigma^{(\k_v)}_{12,{\rm d}}
&= \int\frac{\d \w}{2\pi} \sum_k\,\sum_{\alpha}^{(\kappa)} \frac{ (C^k_{v\a})^2}{[j_v]}
g^{\alpha}_{12}(\en+\w) \, \sum_{ij} \hat q^k_{1i} \, \hat \pi_{ij}^{k}(\w) \, \hat q^k_{j2},
\label{eq:RadialSigmaDir}
\\
\Sigma^{(\k_v)}_{12,{\rm x}}
&= \iint\frac{\d\w_1}{2\pi} \frac{\d\w_2}{2\pi} \sum_{k\lambda}\frac{(-1)^{k+\lambda}}{[j_v]}
\sum^{(\k)}_{\a,\b,\g} 
L_{v\b\a\g}^{k\lambda}
\notag\\
\times&\sum_{ij}  g^\a_{1i}(\en+\w_1)\,\hat q^k_{1j}\,g^\b_{ij}(\en+\w_1+\w_2)\,\hat q^\lambda_{i2}\,g^\g_{j2}(\en+\w_2).
\label{eq:RadialSigmaExch}
\end{align}
Here, the $k$ and $\lambda$ sums are over Coulomb multipolarities, and the ($\k=\a,\b,\g$) sum is over angular quantum numbers (partial waves).
In theory, the $k$ and $\kappa$ sums are infinite; in practice one (or both) must be truncated.
The $ij$ sum is the finite-grid implementation of radial integrals; the integration measures are included in $q_{ij}$.


The radial Green's function is
\begin{align}\label{eq:RadialGreen}
g^\a_{12}(\en) &= \sum_n^{\k_\a} \frac{F_{n\a}(r_1)F^\dag_{n\a}(r_2)}{\en-\en_{n\a}}
= \frac{\chi_0^\a(r_<)\chi_\infty^\a(r_>)}{w},
\end{align}
where the sum runs over all orbitals with $\k=\k_\a$, and the $\chi$ are solutions to the radial Dirac equation with $\k=\k_\a$.
As described above, $g$ should be corrected to account for exchange, with
\be\label{eq:RadialVx}
V_{\rm x,12}^{(\k_v)} = \frac{-1}{[j_v]}\sum_a^{\rm core}\sum_\lambda (C^\lambda_{av})^2F_a(r_1)F_a^\dag(r_2)\hat q^\lambda_{12}.
\ee
The radial Coulomb operator is (see Laplace expansion)
\be\label{eq:RadialQ}
\hat q^k_{ij} = \frac{r_<^k}{r_>^{k+1}} \, \d r_i\d r_j,
\ee
and the radial polarisation operator is
\begin{multline}\label{eq:RadialPolarisation}
\pi_{12}^{k}(\w) = i\sum_{a}^{\rm core}p^a_{12}\sum_{n}^{(\kappa)} \frac{(C^k_{an})^2}{[k]}
\Big[g_{12}^{{\rm ex},n}(\en_{a}-\w)
+g_{12}^{{\rm ex},n}(\en_{a}+\w)
\Big],
\end{multline}
where 
\[
p^a_{ij} = F_a(r_i)F^\dag_a(r_j)
\]
is the (radial) projection operator onto single core state $a$.



%--------------------------------------------------------
\subsection{Numerical frequency integration}


\begin{figure}%[h]
\centering%
\includegraphics[width=0.21\textwidth]{img/PreRotate}~~
\raisebox{14\height}{${\to}$}~~~
\includegraphics[width=0.21\textwidth]{img/RotatedOmega}%
\caption{\small Rotation of the contour for integrals in the form of Eq.~(\ref{eq:GenOmInt}).
Dots represent Green's function poles, crosses are polarisation operator poles (only bound-state poles are shown, there are also continuum-state poles at larger $|\w|$),
$\en_0$ is the energy of the deepest core state, and $|\Delta\en|$ is the energy gap between the core and excited bound states.
\label{fig:contourRotate}}
\end{figure}


The direct and exchange potentials involve integrals of the form:
\be\label{eq:GenOmInt}
\int g(\en+w)\pi(\w)\ldots \frac{\d\w}{2\pi}.
\ee
The integrand contains poles from the Green's function at 
$\w=\en_n-\en-i\delta$ and $\w=\en_a-\en+i\delta$,
and poles from the polarisation operator at 
$\w=\en_a-\en_n+i\delta$ and $\w=\en_n-\en_a-i\delta$.
If $\en$ is the energy of the lowest excited state, then
there are an infinite number of poles from the polarisation operator in each of the regions $\w<-|\Delta\en|$, and $|\Delta\en|<\w<\infty$,
where $\Delta\en$ is the energy gap between the highest core and lowest excited states (for Cs, $|\Delta\en|\approx0.7$\,au).
From the Green's function, there are a finite number (equal to the number of core states) of poles in the region
$-|\en_0|<\w<-|\Delta\en|$, and an infinite number of poles in the region $\w>0$ (see Fig.~\ref{fig:contourRotate}).

If we were to evaluate the integral (\ref{eq:GenOmInt}) numerically using a semi-circle contour closed in the upper/lower-half of the complex plain, it would involve evaluating the integrand arbitrarily close to the poles, which is problematic.
Instead, we rotate the integration contour anti-clockwise by 90$^\circ$; the straight part of the contour is at fixed ${\rm Re}(\w)$.
This is shown in Fig.~\ref{fig:contourRotate}.
It is clear from Cauchy's theorem that the integral over each of the contours is the same and equal to the required
integral (\ref{eq:GenOmInt}).


Using the contour as shown in Fig.~\ref{fig:contourRotate}, the integral becomes
\be\label{eq:GenOmInt-num}
\int_{-\infty}^\infty g(\en+\w_{r}+i\w_i)\pi(\w_{r}+i\w_i)\ldots \frac{\d\w_i}{2\pi} + \cancelto{0}{\oint_{\rm curved}\ldots}.
\ee
If the contour radius (i.e., maximum value of $\w_i$) is large enough, the value of the integrand around the curved part of the contour $\approx0$, so only the $\w_i$ integral needs to be evaluated.
It is desirable to place $\w_r$, which remains constant throughout the integration, as far away from the poles as possible.
There is a region with no poles between 0 and $|\Delta\en|$, so we take $\w_r \simeq -{|\Delta\en|}/2$.


Finally, to perform the integrals numerically, we must evaluate Green's functions at complex frequency values: $\w=\w_r + i\w_i$.
This can be done in analogy with Eq.~(\ref{eq:Green-exchange}):
\begin{align}
g(\en+\w) &= \left[1+i\w_ig(\en+\w_r)\right]^{-1}g(\en+\w_r) 
\end{align}
This $g(\en+\w)$ will be a complex-valued matrix; $g(\en+\w_r)$ is real-valued.
The integration over $\w_i$ can then proceed using standard numerical integration. 








%======================================
\section{All-orders correlation potential}\label{sec:all-orders}

The three most important corrections beyond the second-order correlation potential are:
(i) the screening of the residual Coulomb interaction by the core electrons~\cite{DzubaCPM1988pla}, 
(ii) the hole-particle interaction~\cite{DzubaCPM1989plaEn}, and
(iii) the chaining of the $\Sigma$ operator~\cite{DzubaPNC1985,DzubaPNC1984}.
These effects are described by a series of diagrams that can be summed exactly to all-orders using the Feynman technique.
The method described here was developed in the above works, and may be called the {\sl Dzuba-Flambaum-Sushkov} (DFS) method; it is also called the {\sl perturbation theory in the screened Coulomb interaction} (PTSCI) method.



\begin{figure}%[h!]
\centering
\includegraphics[height=0.025\textwidth]{img/Sigma/CoulombScreening0}
\includegraphics[height=0.025\textwidth]{img/Sigma/plus}
\includegraphics[height=0.025\textwidth]{img/Sigma/CoulombScreening1}
\includegraphics[height=0.025\textwidth]{img/Sigma/plus}
\includegraphics[height=0.025\textwidth]{img/Sigma/CoulombScreening2}
\includegraphics[height=0.025\textwidth]{img/Sigma/plus}
\includegraphics[height=0.025\textwidth]{img/Sigma/dotdotdot}
\caption{\label{fig:Screening}\small Screening of the Coulomb interaction: each Coulomb line is replaced with this infinite series of screening diagrams.}
\end{figure}



It is important to stress a key advantage of the current method: its numerical efficiency.
Using the Feynman approach for the second-order (direct) diagrams takes roughly the same computational power as using the Goldstone method (in fact, it is a bit faster).
Then, the inclusion of the all-orders screening and hole-particle interaction has effectively {\em no} impact on the computer time required.
That is, calculating the all-orders correlation potential is roughly just as computationally intensive as calculating the second-order  corrections using the usual (Goldstone) many-body approach.
This is in stark contrast to other methods (e.g., coupled-cluster), which require {\em huge} computational resources for all-orders calculations.
%
Further, our method takes into account screening effects with double, triple, quadruple, and higher core  excitations, in contrast to all-order coupled-cluster methods, which typically include only double (and sometimes partial triple) excitations.

%--------------------------------------------------------
\subsection{Screening of the residual Coulomb interaction}



The most important correction is the the screening of the residual Coulomb interaction by the core electrons, which can be taken into account by a continued insertion of polarisation loops into the Coulomb lines, as shown in Fig.~\ref{fig:Screening}.
This chain of diagrams represent the matrix geometric series:
\be\label{eq:qpq}
\widetilde Q \equiv \hat Q + \hat Q(-i\,\hat \Pi \hat Q) + \hat Q(-i\,\hat \Pi \hat Q)^2+\ldots.
\ee
Note that each additional $\Pi \hat Q$ term carries a factor of $(-i)$ due to Eq.~(\ref{eq:phaseFactor}).
The series may be summed exactly as
\begin{align}\label{eq:ScreenQ}
\widetilde Q(\w) = \hat Q\left[1+i\,\hat\Pi(\w)\hat Q\right]^{-1}
							= \left[1+i\,\hat Q\hat\Pi(\w)\right]^{-1} \hat Q.
\end{align}
This is the screened Coulomb operator, and includes electron screening to all-orders.
This is enhanced by the number of electrons in the outermost core shell, and the relatively small energy denominator associated with their excitation, see Eq.~(\ref{eq:PiGreen}).
We could also instead write the series (\ref{eq:qpq}) as $Q\widetilde \Pi Q$, with
\begin{align}\label{eq:ScreenPi}
\widetilde \Pi(\w) = \hat \Pi(\w)\left[1+i\,\hat Q\hat\Pi(\w)\right]^{-1}
							= \left[1+i\,\hat\Pi(\w)\hat Q\right]^{-1} \hat \Pi(\w).
\end{align}

Inserting the screened Coulomb operator into Eqs.~(\ref{eq:FeynDir}) and (\ref{eq:FeynExch}) yields the new correlation potential:
\begin{align}
\Sigma_{\rm d}
&= \iint\d^3 r_id^3 r_j
\int\frac{\d\w}{2\pi}\hat G_{12}(\en+\w)\hat Q_{1i}\hat\Pi_{ij}(\w)\widetilde Q_{j2}(\w),
\label{eq:SigmaAll-dir}
\\
\Sigma_{\rm x}
&= -\iint\d^3 r_id^3 r_j
\iint\frac{\d\w_1}{2\pi}\frac{\d\w_2}{2\pi} \, \times \notag\\
\label{eq:SigmaAll-exch}
\hat G_{1i}(\en&+\w_1)\widetilde Q_{1j}(\w_1) \hat G_{ij}(\en+\w_1+\w_2)\widetilde Q_{i2}(\w_2)\hat G_{j2}(\en+\w_2),
\end{align}
which includes screening to all-orders.
Note that the screened operator should replace only a single Coulomb line in the direct diagram, but both in the exchange diagram.

Note that this method takes into account screening diagrams with double, triple, quadruple, and higher core electron excitations.
This is because the Feynman diagram technique contains all possible time orderings of the polarisation loops; therefore the screening diagrams contain any number of excited electrons~\cite{DzubaCPM1988pla}.
This is in contrast to the widely-used ``singles-doubles coupled-cluster method'', where only double excitations are considered (and sometimes a selection of important triple excitations).
There are, however, some perturbation-theory diagrams included in the coupled-cluster methods that are not included in our approach. 
The most important of which (the so-called ladder diagrams) are very small, and can be included into our method by means of the method presented in Ref.~\cite{DzubaLadder2008}. 




%--------------------------------------------------------
\subsection{Hole-particle interaction}


\begin{figure}%[b]
\centering
\includegraphics[height=0.04\textwidth]{img/Sigma/polAll}
\includegraphics[height=0.04\textwidth]{img/Sigma/equals}
\includegraphics[height=0.04\textwidth]{img/Sigma/pol0}
\includegraphics[height=0.04\textwidth]{img/Sigma/plus}
\includegraphics[height=0.04\textwidth]{img/Sigma/pol1}
\includegraphics[height=0.04\textwidth]{img/Sigma/plus}
\includegraphics[height=0.04\textwidth]{img/Sigma/pol2}
\includegraphics[height=0.04\textwidth]{img/Sigma/plus}
\includegraphics[height=0.04\textwidth]{img/Sigma/dotdotdot}
\caption{\label{fig:HoleParticle}\small Hole-particle corrections to the polarisation operator}
\end{figure}

\begin{figure}%[b]%[h]%[h!]
\centering
\includegraphics[height=0.033\textwidth]{img/Sigma/CoulombAll}~~
\includegraphics[height=0.033\textwidth]{img/Sigma/equals}~~
\includegraphics[height=0.033\textwidth]{img/Sigma/CoulombScreening0}~~~
\includegraphics[height=0.033\textwidth]{img/Sigma/plus}\\~~~
\includegraphics[height=0.033\textwidth]{img/Sigma/CoulombScreening_hp}~~
\includegraphics[height=0.033\textwidth]{img/Sigma/plus}~~
\includegraphics[height=0.033\textwidth]{img/Sigma/CoulombScreening_hp_2}~~
\includegraphics[height=0.033\textwidth]{img/Sigma/plus}~~
\includegraphics[height=0.033\textwidth]{img/Sigma/dotdotdot}
\caption{\label{fig:DressedCoulomb}\small All-order screening of the Coulomb operator including the hole-particle interaction.}
\end{figure}



The chain of diagrams corresponding to the hole-particle interaction is shown in Fig.~\ref{fig:HoleParticle}.
Physically, this effect arises due to the 
deviation of the (direct) Hartree-Fock potential for the excited core electron in the polarisation loop from that for the non-excited one~\cite{DzubaCPM1989plaEn}.
In other words, it corresponds to an alteration of the core potential due to the excitation of the particle from the core to the virtual intermediate state; the excited core particle in the polarisation loop moves in the field of $N-2$ other core electrons instead of the usual $V^{N-1}$ potential.


In practical Hartree-Fock calculations for occupied core states, the self-interaction term is included in the direct potential; this is then exactly compensated by the corresponding term in the exchange potential. 
However, for the state excited from the core ($a_n^\dag a_a\ket{0}$), no such cancellation occurs.
Therefore, the self-interaction term should be removed for the excited states.




Following the approach from Ref.~\cite{DzubaCPM1989plaEn}, the potential that simultaneously describes the occupied core and excited states is
\be\label{eq:V-hp}
\hat V = V^{N-1} - (1-\hat P_{\rm core})V_0 (1-\hat P_{\rm core}),
\ee
where
\be
\hat P_{\rm core} = \sum_a^{\rm core}\ket{a}\bra{a}
\ee
is the operator of projection onto the core, and $V_0$ is the self-interaction part of the Hartree-Fock potential for the outgoing electron:
 \be
V_0^a(r) = y^0_{aa}(r) - \sum_k^{\rm even}\frac{(C^k_{aa})^2}{[j_a]^2}y^k_{aa}(r)
\ee
%
We use Eq.~(\ref{eq:V-hp}) since the Green's function contains both core and excited electrons [see Eq.~(\ref{eq:FeynmanGreen})]; $\hat P$ is introduced to ensure orthogonality of the orbitals.
The $G^{\rm ex}$ function that appears in the polarisation operator is then formed as Eq.~(\ref{eq:Gex}).
Note that $\braket{V}=\braket{V^{N-1}}$ for the occupied core states, and
$\braket{V}=\braket{V^{N-1}}-\braket{V_0}$ for the excited states.
In this method, we do not calculate the hole-particle diagrams directly.
We calculate the Green's function using the potential in Eq.~(\ref{eq:V-hp}), and use it to form the polarisation operator.
This corrected polarisation operator includes the dominating hole-particle effects.



We may include the ``corrected'' polarisation operator in place of the regular polarisation operator when calculating the screened Coulomb line, as shown in Fig.~\ref{fig:DressedCoulomb}.
Inserting the corrected polarisation loop, and the screened Coulomb lines into the diagrams for the correlation potential, we obtain an expression for the all-order correlation potential as shown in Fig.~\ref{fig:SigmaAO-Feyn}.







%--------------------------------------------------------
\subsection{Self-energy chaining}

The ``chaining'' of the correlation potential (iteration of $\Sigma$) is shown in Fig.~\ref{fig:Chaining}.
This is accounted for automatically by including $\Sigma$ into the Hartree-Fock iterations for the valence orbital (correlation potential method, as described previously).
This is an important effect that includes terms with excitations of the external valence electron, and is enhanced due to the small energy denominator associated with this excitation.
Because the Hartree-Fock equations (with $\Sigma$) are iterated until self-consistancy is reached, the chaining is included to all-orders.


\begin{figure}%[h]
\centering
\includegraphics[width=0.235\textwidth]{img/Sigma/AODirect}
\includegraphics[width=0.235\textwidth]{img/Sigma/AOExch}
\caption{\label{fig:SigmaAO-Feyn}\small All-order correlation diagrams including the Coulomb screening and hole-particle interaction.}
\end{figure}

\begin{figure}[b]
\centering
\includegraphics[height=0.0285\textwidth]{img/Sigma/Chaining1}~
\includegraphics[height=0.0285\textwidth]{img/Sigma/plus}~
\includegraphics[height=0.0285\textwidth]{img/Sigma/Chaining2}~
\includegraphics[height=0.0285\textwidth]{img/Sigma/plus}~
\includegraphics[height=0.0285\textwidth]{img/Sigma/dotdotdot}
\caption{\label{fig:Chaining}\small Chaining of the correlation potential (self-energy); the boxed $\Sigma$ refers to the sum of diagrams in Fig.~\ref{fig:SigmaAO-Feyn}.}
\end{figure}






%--------------------------------------------------------
\subsection{Effective screening for exchange term}\label{sec:AllOrder-effectiveScreening}


In the all-orders method, the frequency integrations can no longer be performed analytically.
This is fine for the direct potential, since it contains only a single integral (the frequency integral inside the polarisation operator can be done analytically).
The exchange potential, on the other hand, contains a double integral over frequencies, which is numerically expensive.

The exchange contribution to the correlation potential is typically small compared to the direct potential, and the screening is a small correction to this.
Therefore, it seems reasonable to approximately account for the screening in the exchange potential.
This is done by introducing effective screening factors for the Coulomb operator in the exchange potential: $\widetilde Q\approx f\hat Q$.
%
In practice, the Coulomb operator is expanded over multipolarities $\hat Q\sim\sum_k \hat q^k$ (Laplace expansion, as discussed previously), and a different screening factor is used for each multipolarity:
\be
\widetilde q^k(\w)\approx f_k \hat q^k.
\ee
Note that the frequency dependence of $f_k$ has been neglected.

The screening factors are calculated by evaluating the direct energy correction (for each $k$) with and without screening:
\be
f_k = {\bra{v}\Sigma^{\rm(screened),k}_{\rm d}\ket{v} \, / \, \bra{v}\Sigma^{(2),k}_{\rm d}\ket{v}}.
\ee
Then, the frequency integrals for the exchange term can be carried out analytically, and the exchange potential may be calculated by summation over a complete set of states in exact analogy to the Goldstone case, just with the extra $k$-dependent factors.
This greatly improves the efficiency of the exchange part of the calculation, while still maintaining good accuracy.

The hole-particle interaction is not included in $\Sigma$ for calculation of $f_k$
(hole-particle effect enters at third-order in the direct diagrams, but only at fourth-order in exchange).
However, this means the hole-particle effect is not included into the exchange diagrams at all, which in certain cases may be important.
The screening effect is also taken into account approximately, which may also be important in some cases.










%======================================================
%======================================================
\section[Structure radiation + renormalisation]{Structure radiation + renormalisation: Correlation corrections to matrix elements\footnote{Implemented in: /src/MBPT/StructureRad.hpp}}

By using Brueckner orbitals (correlation potential method) to compute matrix elements and including core polarisation, the dominating correlation corrections to matrix elements are included automatically.
However, effects that involve terms where the external field acts {\rm inside} the correlation diagrams -- known as structure radiation -- cannot be included into the correlation potential method, and must be considered separately~\cite{Blundell1987,Dzuba1987jpbRPA}.
This is illustrated in Fig.~\ref{fig:SR1}.
In total, there are 36 such diagrams; 9 for each of the four second-order diagrams in Fig.~\ref{fig:Sigma2}.
At the same level there enters another correction, known as normalisation of states, that also cannot be included into the correlation potential method. 
It arises due to the change of the normalisation of the wavefunctions due to configuration mixing.
All these effects are suppressed compared to the Brueckner and core-polarisation corrections (roughly) by the ratio of the core excitation energy to that of the valence states.

\begin{figure}%[b]
\centering
\includegraphics[width=0.155\textwidth]{img/sr/BOv}
\includegraphics[width=0.155\textwidth]{img/sr/BOw}
\includegraphics[width=0.155\textwidth]{img/sr/SR}
\caption{\label{fig:SR1}\small Correlation corrections to matrix elements: $\Sigma$ represents the correlation potential, and the dashed line is interaction with external field. The first two diagrams are included when Brueckner orbitals are used to compute the matrix elements; the third diagram, called structure radiation, is not.}
\end{figure}

Matrix elements of operator $\hat h$ (rank $k$) are written~\cite{Blundell1987,Dzuba1987jpbRPA}:
\be
\bra{w}h\ket{v} + \bra{w}\delta h^{\rm SR}\ket{v}+\bra{w}\delta h^{\rm Norm}\ket{v}.
\ee
The normalisation contributions can be expressed
\be
\bra{w}|\delta h^{\rm Norm}|\ket{v} = \frac{-1}{2}\bra{w}|h|\ket{v}\left(N_{w}  +  N_{v}\right),
\ee
where (using the short-hand $\en_{ij}\equiv\en_i+\en_j$)
\begin{align}
N_v &=
 \sum_{amn} \frac{\delta\Sigma_{vamn}}{\en_{va} - \en_{mn}}
+\sum_{abn}\frac{\delta\Sigma_{vnab}}{\en_{vn}-\en_{ab}} ,
\end{align}
with
\begin{align}
\delta\Sigma_{vijk} &=\sum_\mu \frac{1}{[\mu][j_v]}\Bigg(
\frac{Q^\mu_{vijk}W^\mu_{vijk}}{\en_{vi} - \en_{jk}}
 \Bigg).
\end{align}
Note that $\delta\Sigma$ are just individual contributions to the second-order energy shift, Eq.~(\ref{eq:dE-SO-red});
see Ref.~\cite{Dzuba1987jpbRPA} for discussion.








The structure radiation terms are more complicated.
Following Ref.~\cite{JohLiuSap96}, they can be broken into three groups of 12 diagrams: ``top'' ($T$), ``bottom'' ($B$), and ``centre'' ($C$):
\[
\bra{w}|\delta h^{\rm SR}|\ket{v} = \bra{w}|T|\ket{v} + \bra{w}|B|\ket{v} + \bra{w}|C|\ket{v}.
\]
Two examples are shown in Fig.~\ref{fig:SR-example}.
Expressions for these terms were presented in Ref.~\cite{JohLiuSap96}:
\begin{align}
\bra{w}|T|\ket{v} &= \sum_{ar} \frac{\bra{a}|h|\ket{r} T^k_{wrva}}{\en_r - \en_a + \w},\\
\bra{w}|B|\ket{v} &= \sum_{ar} \frac{\bra{r}|h|\ket{a} B^k_{wavr}}{\en_r - \en_a - \w},\\
\bra{w}|C|\ket{v} &= -\sum_{ab} {\bra{b}|h|\ket{a} C^{k}_{wavb}} - \sum_{rn} {\bra{r}|h|\ket{n} D^{k}_{wnvr}},
\end{align}
where $\omega$ is the transition frequency,
$a,b,c,...$ are states in the core (holes), $n,m,r,...$ are virtual excited states, and $w,v$ are valence states.
For diagonal matrix elements $T=B$.




\begin{figure}%[h]
\centering\tiny
\includegraphics[width=0.185\textwidth]{img/sr/SR_exC}~~~~~~~
\includegraphics[width=0.185\textwidth]{img/sr/SR_exT}
\caption{\small Example structure radiation diagrams, showing a ``centre'' (left) and ``top'' (right) diagram.\label{fig:SR-example}}
\end{figure}


The $T^k$ terms are written as
$T=T^1+T^2+T^3+T^4$, with:\footnote{Using notation
$\en_{ij}\equiv\en_i+\en_j$, and e.g., `$a$' short for $j_a$ in 6j symbols and phase factors, e.g.,
$(-1)^{a+b}\equiv(-1)^{j_a + j_b}$, while $k$,\,$\mu$,\,$\lambda$ are multipolarities.}
\begin{align}
&\notag
T^{1,k}_{wrvc} = 
\sum_{ab\mu\lambda}(-1)^{v+r+a+b+k}
\sixjs{w}{v}{k}{\lambda}{\mu}{b}
\sixjs{r}{c}{k}{\lambda}{\mu}{a}
\frac{W^\mu_{wrba}Q^\lambda_{vabc}}{\en_{wr}-\en_{ba}}
\\
\begin{split}
&T^{2,k}_{wrvc} = 
\sum_{an\mu}\frac{(-1)^{w-c+k+\mu}}{[\mu]}
\sixjs{w}{v}{k}{r}{c}{\mu}
\frac{W^\mu_{wacn}W^\mu_{varn}}{\en_{rn}-\en_{va}}
\\
&T^{3,k}_{wrvc} = 
\sum_{an\mu}\frac{(-1)^{w-c+k+\mu}}{[\mu]}
\sixjs{w}{v}{k}{r}{c}{\mu}
\frac{W^\mu_{wnca}W^\mu_{vnra}}{\en_{wn}-\en_{ca}}
\end{split}
\\
&\notag
T^{4,k}_{wrvc} = 
\sum_{mn\mu\lambda}(-1)^{v+r+n+m+k}
\sixjs{w}{v}{k}{\lambda}{\mu}{n}
\sixjs{r}{c}{k}{\lambda}{\mu}{m}
\frac{Q^\mu_{wrnm}W^\lambda_{vcnm}}{\en_{nm}-\en_{vc}}.
\end{align}
($T^1$ and $T^4$ each correspond to two diagrams; $T^2$ and $T^3$ each correspond to four).
The $B$ terms are similar:
\be
B^{k}_{wavr} = (-1)^{v-w+a-r}\,T^{k}_{vrwa}.
\ee
%
Finally, the centre $C$ and $D$ terms are:
\begin{align}
&\notag
C^{k}_{wavc} = 
\sum_{bn\mu}\frac{(-1)^{k+\mu}}{[\mu]}
\sixjs{w}{v}{k}{c}{a}{\mu}
\frac{(-1)^{w-c}\,W^\mu_{wnab}W^\mu_{vncb}}{(\en_{wn}-\en_{ab})(\en_{vn}-\en_{bc})}
\\
&+\sum_{mn\mu\lambda}(-1)^{k}
\sixjs{w}{v}{k}{\mu}{\lambda}{n}
\sixjs{c}{a}{k}{\lambda}{\mu}{m}
\frac{(-1)^{v+a+m+n}Q^\mu_{vmnc}W^\lambda_{wanm}}{(\en_{wa}-\en_{nm})(\en_{vc}-\en_{nm})}
\\
&\notag
D^{k}_{wrvm} = 
\sum_{nb\mu}\frac{(-1)^{k+\mu}}{[\mu]}
\sixjs{w}{v}{k}{m}{r}{\mu}
\frac{(-1)^{w-m}W^\mu_{wbrn}W^\mu_{vbmn}}{(\en_{wb}-\en_{rn})(\en_{vb}-\en_{mn})}
\\
&\notag+
\sum_{ab\mu\lambda}(-1)^{k}
\sixjs{w}{v}{k}{\mu}{\lambda}{a}
\sixjs{m}{r}{k}{\lambda}{\mu}{b}
\frac{(-1)^{v+r+a+b}Q^\mu_{vbam}W^\lambda_{wrab}}{(\en_{wr}-\en_{ab})(\en_{vm}-\en_{ab})}.
\end{align}
Note that the formula for $D^k$ is the same as for $C^k$, except with the internal sums over core and excited states swapped
(i.e., $b\leftrightarrow a$ in the first term, and $\sum_{mn}\to\sum_{ab}$ in the second.)



%\begin{align}
%&\notag
%C^{k}_{wavc} = 
%\sum_{bn\mu}\frac{(-1)^{k+\mu}}{[\mu]}
%\sixjs{w}{v}{k}{c}{a}{\mu}
%\frac{(-1)^{w-c}\,W^\mu_{wnab}W^\mu_{vncb}}{(\en_{wn}-\en_{ab})(\en_{vn}-\en_{bc})}
%\\
%&+\sum_{ij\mu\lambda}^{\rm exc.}(-1)^{k}
%\sixjs{w}{v}{k}{\mu}{\lambda}{i}
%\sixjs{c}{a}{k}{\lambda}{\mu}{j}
%\frac{(-1)^{v+a+i+j}Q^\mu_{vjic}W^\lambda_{waij}}{(\en_{wa}-\en_{ij})(\en_{vc}-\en_{ij})}
%\\
%&\notag
%D^{k}_{wavc} = 
%\sum_{bn\mu}\frac{(-1)^{k+\mu}}{[\mu]}
%\sixjs{w}{v}{k}{c}{a}{\mu}
%\frac{(-1)^{w-c}W^\mu_{wban}W^\mu_{vbcn}}{(\en_{wb}-\en_{an})(\en_{vb}-\en_{cn})}
%\\
%&\notag+
%\sum_{ij\mu\lambda}^{\rm core}(-1)^{k}
%\sixjs{w}{v}{k}{\mu}{\lambda}{i}
%\sixjs{c}{a}{k}{\lambda}{\mu}{j}
%\frac{(-1)^{v+a+i+j}Q^\mu_{vjic}W^\lambda_{waij}}{(\en_{wa}-\en_{ij})(\en_{vc}-\en_{ij})}.
%\end{align}






The dominating uncertainty for these corrections comes from completeness of the basis.
In particular, the structure radiation terms involve matrix elements of $\hat h$ between basis states (the normalisation of states only contains matrix elements between valence states).
It is therefore a good test to perform the core-polarisation calculations using both the TDHF (Sec.~\ref{sec:RPA}) and diagram (Sec.~\ref{sec:RPA-diagram}) methods using the same basis as for structure radiation, since the diagram RPA method also involves matrix elements between basis states.
If the TDHF and diagram core polarisation calculations match, it is good indication that the basis is sufficient to also describe the structure radiation.




%======================================================
%======================================================
\section{Relativity beyond Dirac-Coulomb (Breit+QED)}


The Dirac equation as presented in Eq.~(\ref{eq:H-manybody})
accounts for the relativistic motion of the electron in the Coulomb field of the nucleus, however, it treats the Coulomb field classically, and treats the electron-electron Coulomb repulsion non-relativistically (see, e.g., Ref.~\cite{BetheBook}).
For high-accuracy calculations, and particularly for atoms with large $Z$, corrections due to the missing relativistic effects become important ($\sim$\,0.1\,--\,1\%).
The two corrections considered here are the
Breit interaction, which contains the dominating relativistic corrections to the electron-electron Coulomb interaction, and 
the radiative quantum electrodynamics (QED) corrections, which are accounted for via the Ginges-Flambaum radiative potential method.

Our Breit corrections are compared against those calculated by Derevianko in Ref.~\cite{Derevianko2001}.
There, it was demonstrated that the interplay between the Breit effects and correlations were crucial -- even changing the sign of the Breit contribution in many cases.
%Ref.~\cite{Derevianko2001} also demonstrated that the Breit Hamiltonian must be included into the Hamiltonian single-particle states (B-spline basis) used for perturbation theory.
Our Breit calculations agree perfectly with those of Ref.~\cite{Derevianko2001} at the HF level, and agree very well including correlations.
%
The interplay between the QED and correlation corrections turns out also to be important~\cite{GingesQED2015,Ginges2016}, so for high-accuracy calculations, the Breit and QED effects must be included together including correlations.


Tables \ref{tab:QEDBreit-En}, \ref{tab:QED-E1}, and \ref{tab:Breit-E1} show the QED and Breit corrections to the lowest $s$ and $p$ energies and E1 matrix elements at various levels of approximation.
The combination of correlation corrections with the Breit and QED effects are important.


\begin{table}[]
\small
\centering
\caption{\small 
Breit and QED corrections to the removal energies of the lowest $s$ and $p$ states of Cs, as calculated at the Hartree-Fock and $\Sigma^{(2)}$ levels (units: cm$^{-1}$). First column ($\en$) shows energy without QED or Breit.
The Breit corrections at the HF level agree exactly with Derevianko~\cite{Derevianko2001}.
%The discrepancies from\cite{Derevianko2001} are due to correlations; agree exactly at HF level.
\label{tab:QEDBreit-En}}
\begin{tabular}{l D{.}{.}{6.1} D{.}{.}{2.1}D{.}{.}{2.1} l D{.}{.}{2.1}D{.}{.}{2.1}D{.}{.}{2.1}}
\hline
\hline
        &           & \multicolumn{2}{c}{$\delta$QED}       && \multicolumn{3}{c}{$\delta$Breit}       \\
\cline{3-4}\cline{6-8}
        & \multicolumn{1}{c}{$\en~(\Sigma^{(2)})$} &  \multicolumn{1}{c}{HF}    & \multicolumn{1}{c}{$\Sigma^{(2)}$} && \multicolumn{1}{c}{HF}    & \multicolumn{1}{c}{$\Sigma^{(2)}$} & \multicolumn{1}{c}{Ref.~\cite{Derevianko2001}} \\
\hline
$6s_{1/2}$ & 32412.1   & -16.0 & -23.7& & -3.2  & 2.9&  2.6 \\
$7s_{1/2}$ & 13023.0   & -4.3  & -5.2 & & -1.1  & -0.1 & 0.3\\
$6p_{1/2}$ & 20537.8   & 0.8   & 1.1  & & -7.5  & -7.3 & -7.1\\
$7p_{1/2}$ & 9710.0    & 0.3   & 0.4   && -2.7  & -2.6&  -2.5\\
$6p_{3/2}$ & 19939.2   & 0.1   & 0.0  & & -2.9  & -0.6&  -0.8\\
$7p_{3/2}$ & 9520.5    & 0.0   & 0.0   && -1.0  & -0.4 & -0.4\\
\hline
\hline
\end{tabular}
\end{table}

\begin{table}
\small
\centering
\caption{\small 
QED corrections to the electric dipole (E1) reduced matrix elements of lowest $s$ and $p$ states of Cs at the HF, RPA, and $\Sigma^{(2)}$ levels (units: $a_B$). First column shows E1 (absolute value) at the RPA+$\Sigma^{(2)}$ level, without QED (or Breit).%
\label{tab:QED-E1}}
\begin{tabular}{l D{.}{.}{2.4} D{.}{.}{2.4}D{.}{.}{2.4}D{.}{.}{2.4}}
\hline
\hline
         &                  &      \multicolumn{3}{c}{ $\delta$ QED}  \\
\cline{3-5}
        & \multicolumn{1}{c}{$|E1|$} &  \multicolumn{1}{c}{HF}    & \multicolumn{1}{c}{RPA} & \multicolumn{1}{c}{RPA+$\Sigma^{(2)}$}\\
\hline
$6p_{1/2}$--$ 6s_{1/2}$ & 4.3874 & 0.0033  & 0.0033  & 0.0035       \\
$7p_{1/2} $--$ 6s_{1/2}$ & 0.3001 & -0.0025 & -0.0024 & -0.0023      \\
$6p_{3/2} $--$ 6s_{1/2} $& 6.1698 & 0.0048  & 0.0049  & 0.0052       \\
$7p_{3/2} $--$ 6s_{1/2} $& 0.6056 & -0.0029 & -0.0028 & -0.0025      \\
$7p_{1/2} $--$ 7s_{1/2} $& 10.178 & 0.0069   & 0.0069   & 0.0072        \\
$7p_{3/2} $--$ 7s_{1/2} $& 14.123 & 0.0099   & 0.0099   & 0.0103       \\
$7s_{1/2} $--$ 6p_{1/2} $& 4.2241 & -0.0046 & -0.0044 & -0.0045      \\
$7s_{1/2} $--$ 6p_{3/2} $& 6.4705 & -0.0058 & -0.0056 & -0.0054   \\
\hline
\hline
\end{tabular}
\end{table}

\begin{table}
\small
\centering
\caption{\small 
Breit corrections to the E1 reduced matrix elements of $s$ and $p$ states of Cs at the HF, RPA, and $\Sigma^{(2)}$ levels (units: $a_B$).
Corrections at the HF level agree near-perfectly with Derevianko~\cite{Derevianko2001}.%
\label{tab:Breit-E1}}
\begin{tabular}{l D{.}{.}{1.3} D{.}{.}{2.4}D{.}{.}{2.4}D{.}{.}{2.4}D{.}{.}{2.4}}
\hline
\hline
         &                  &      \multicolumn{4}{c}{ $\delta$ Breit}  \\
\cline{3-6}
        & \multicolumn{1}{c}{$|E1|$} &  \multicolumn{1}{c}{HF}    & \multicolumn{1}{c}{RPA} & \multicolumn{1}{c}{RPA+$\Sigma^{(2)}$}& \multicolumn{1}{c}{Ref.~\cite{Derevianko2001}}\\
\hline
$6p_{1/2}$--$ 6s_{1/2}$ & 4.387 &     0.0004 & 0.0000 & -0.0008&  -0.0010 \\
$7p_{1/2} $--$ 6s_{1/2}$ & 0.300 & 0.0018 & 0.0016 & 0.0017& 0.0019   \\
$6p_{3/2} $--$ 6s_{1/2} $& 6.170 &     0.0008 & 0.0001 & -0.0009 &-0.0011  \\
$7p_{3/2} $--$ 6s_{1/2} $& 0.606   & 0.0006 & 0.0003 & 0.0002 &  0.0005 \\
$7p_{1/2} $--$ 7s_{1/2} $& 10.178      & -0.0010 & -0.0011 & -0.0022 & -0.0029  \\
$7p_{3/2} $--$ 7s_{1/2} $& 14.123      & 0.0008  & 0.0006  & 0.0004 &  -0.0013  \\
$7s_{1/2} $--$ 6p_{1/2} $& 4.224    & 0.0046 & 0.0045 & 0.0045 & 0.0049  \\
$7s_{1/2} $--$ 6p_{3/2} $& 6.471  & 0.0018 & 0.0018 & 0.0010&  0.0016\\
\hline
\hline
\end{tabular}
\end{table}






%======================================================
\subsection[Breit interaction]{Breit interaction\footnote{Implemented in: /src/HF/Breit.hpp}\label{sec:Breit}}

This section mostly follows Ref.~\cite{JohnsonBook2007}; see also \cite{Johnson1988a,Mann1971,Derevianko2001}.
The Breit Hamiltonian accounts for magnetic interactions between electrons (also known as the Gaunt interaction), and retardation effects (see, e.g.,~\cite{BetheBook}).
It leads to a correction to the electron-electron Coulomb term in the many-body Hamiltonian (\ref{eq:H-manybody}):
\be
\sum_{ij}\frac{1}{r_{ij}}
\to
\sum_{ij}\left( \frac{1}{r_{ij}} + \hat h^B_{ij}\right),
\ee
where, in the limit of zero frequency, the two-particle Breit Hamiltonian is
\be
\hat h^B_{ij} = - \frac{\v{\a}_i\cdot\v{\a}_j + (\v{\a}_i\cdot\vhat{n}_{ij})(\v{\a}_j\cdot\vhat{n}_{ij})}{2\, {r}_{ij}}.
\ee
Frequency-dependent effects can be neglected in most situations, see, e.g., discussion in Refs.~\cite{BetheBook,JohnsonBook2007}.



%\subsubsection{Matrix elements of the Breit operator}

We follow Ref.~\cite{Mann1971}, and express the angular reduction for the two-particle Breit integrals in the same way as for the Coulomb interaction:
\[
b_{abcd} = \bra{ab}\hat b\ket{cd} = A^k_{abcd} B^k_{abcd}
\]
where $A^k_{abcd}$ is the same angular coefficient as in the regular Coulomb case [see Eq.~\eqref{eq:reduced-Coulomb} in the appendix].
The ``reduced'' Breit integrals, $B^k$, are analogous to the $Q^k$ integrals of the Coulomb interaction, though do not contain all the same symmetries.
Our definition of $B^k$ differs by a factor of $\pm1$ compared to Ref.~\cite{Mann1971}, in order to be consistent with our $Q^k$ definition.

In analogy with the Coulomb case, we express this as
\begin{multline}\label{eq:Bk-Breit}
    B^k_{abcd} = (-1)^{k+|j_a-j_b|}\Big[C^k_{ac}C^k_{bd}
    \left(m^k_{abcd}+o^k_{abcd}+p^k_{abcd}\right)\\
    +
    C^k_{-a,c}C^k_{-b,d}n^k_{abcd}\Big],
\end{multline}
where
$m,n$ are due to the magnetic (Gaunt) effects, $o,p$ are due to retardation, and $C^k_{-b,a} \equiv \bra{-\k_b}|C^k|\ket{\k_a}$. 
The lower-case integrals (e.g., $m^k_{abcd}$) may be called the Breit radial integrals, and are somewhat analogous to $R^k_{abcd}$, though they also depend on angular quantum numbers $\kappa$ (but not projections).
The $B^k$ integrals have similar symmetries as the $W^k$ Coulomb integrals:
\be
    B^k_{abcd} = B^k_{badc} = B^k_{cdab} = B^k_{dcba},
\ee
with the extra symmetry:
\be
    B^k_{cbad} = (-1)^{l_a+l_c+k+1}B^k_{abcd}
\ee
(the $m$, $o$, $p$ parts are anti-symmetric under $a\leftrightarrow c$, while the $n$ is symmetric).
Note also the the $n$ part has the opposite parity selection rule to the other terms, and to the regular Coulomb integrals.


The complete equations are substantially more cumbersome than for the Coulomb case.
We follow Ref.~\cite{Mann1971} and introduce:
\begin{equation}
\begin{split}
P^k_{ij}(r) &= \frac{\Delta_{ij}}{k}X_{ij}(r)-Y_{ij}(r) = -P^k_{ji}(r)\\
Q^k_{ij}(r) &= \frac{\Delta_{ij}}{k+1}X_{ij}(r)+Y_{ij}(r) = -Q^k_{ji}(r),
\end{split}
\end{equation}
where $\Delta_{ij}\equiv\kappa_i-\kappa_j$, 
\begin{equation}
\begin{split}
X_{ij}(r) &= F_i^\dag\hat\theta_xF_j = f_i(r)g_j(r) + g_i(r)f_j(r) = X_{ji}\\
Y_{ij}(r) &= F_i^\dag\hat\theta_yF_j = f_i(r)g_j(r) - g_i(r)f_j(r) = -Y_{ji},
\end{split}
\end{equation}
and 
\be\small
\hat\theta_x =  \matr{0}{1}{1}{0} \, , \quad
\hat\theta_y =  \matr{0}{1}{-1}{0}.
\ee
%(note:\ $\hat\theta_x=\hat\s_x$, and $\hat\theta_y=i\hat\s_y$, except these act in the radial spinor space only),
For numerical simplicity, in the code we define the functions:
\begin{align}
    g^k_{ij}(r) &= 
    \int_0^\infty  \hat q^k X_{ij}(r') \,\d r'\\
    b^k_{ij}(r) &= 
    \int_0^\infty  \hat q^k Y_{ij}(r') \,\d r',
\end{align}
with
\begin{align}
    g^k(r_1) 
    %&\equiv \int_0^\infty  \frac{r_<^k}{r_>^{k+1}} X_{ij}(r_2) \,\d r_2\\
    &= \int_0^{r_1}  \frac{r_2^k}{r_1^{k+1}} X_{ij}(r_2) \,\d r_2
    &&+\int_{r_1}^\infty  \frac{r_1^k}{r_2^{k+1}} X_{ij}(r_2) \d r_2\notag\\
    &= g^{0,k}(r_1) &&+ g^{\infty,k}(r_1).
\end{align}

We also introduce notation for the integrals:
\begin{equation}
\begin{split}
    s^k_{abcd} &= \iint\d r_1\d r_2 \, q^{k+1}Q^k_{ac}(r_1)Q^k_{bd}(r_2)\\
    t^k_{abcd} &= \iint\d r_1\d r_2 \, q^{k-1}P^k_{ac}(r_1)P^k_{bd}(r_2)\\
    u^k_{abcd} &= \iint\d r_1\d r_2 \, q^{k}X_{ac}(r_1)X_{bd}(r_2)\\
    v^k_{abcd} &= \int_0^\infty\d r_1\int_0^{r_1}\d r_2 \, (q^{k-1}-q^{k+1})Q^k_{ac}(r_1)P^k_{bd}(r_2)\\
    &+ \int_0^\infty\d r_1\int_{r_1}^\infty\d r_2 \, (q^{k-1}-q^{k+1})P^k_{ac}(r_1)Q^k_{bd}(r_2),
\end{split}
\end{equation}
where $q^k\equiv\frac{r_<^k}{r_>^{k+1}}$ is the (radial) two-body Coulomb operator.
\begin{comment}
These can also be expressed:
\begin{equation}
\begin{split}
    s^k_{abcd} &= \int\d r\, Q^k_{ac}(r)\left(\frac{\Delta_{bd}}{k+1}g^{k+1}_{bd}(r) + b^{k+1}_{bd}(r)\right)\\
    t^k_{abcd} &= \int\d r P^k_{ac}(r)\left(\frac{\Delta_{bd}}{k}g^{k-1}_{bd}(r) - b^{k-1}_{bd}(r)\right)\\
    u^k_{abcd} &= \int\d r\, X_{ac}(r)g^k_{bd}(r)\\
    v^k_{abcd} &= \int\d r\,  Q^k_{ac}(r)\Bigg(\frac{\Delta_{bd}}{k}\left[g^{0,k-1}_{bd}(r)-g^{0,k+1}_{bd}(r)\right] \\
    &\hspace{2.75cm}- b^{0,k-1}_{bd}(r)+b^{0,k+1}_{bd}(r)\Bigg)\\
    &+\int\d r\,  P^k_{ac}(r)\Bigg(\frac{\Delta_{bd}}{k+1}\left[g^{\infty,k-1}_{bd}(r)-g^{\infty,k+1}_{bd}(r)\right] \\
    &\hspace{2.75cm}+ b^{\infty,k-1}_{bd}(r)-b^{\infty,k+1}_{bd}(r)\Bigg).
\end{split}
\end{equation}
\end{comment}
With these definitions, we can write~\cite{Mann1971,JohnsonBook2007}:
\begin{align}
m^k_{abcd} &= \frac{k+1}{2k+3}s^k_{abcd}+\frac{k}{2k-1}t^k_{abcd}\notag\\
n^k_{abcd} &= -\frac{(\k_a+\k_c)(\k_b+\k_d)}{k(k+1)}u^k_{abcd}\\
o^k_{abcd} &= -\frac{(k+1)^2}{(2k+1)(2k+3)}s^k_{abcd}-\frac{k^2}{(2k+1)(2k-1)}t^k_{abcd}\notag\\
p^k_{abcd} &= -\frac{k(k+1)}{2(2k+1)}v^k_{abcd}.\notag
\end{align}

For including Breit into HF or TDHF equations, it is convenient to define the effective one-body Breit operators, which may be called ``Breit screening functions'' in analogy with $y^k_{bd}(r)$.
For example,
\[
({a}|s^{k(ac)}_{bd}|{c}) \equiv
\int F_a^\dag(r) s^{k(ac)}_{bd}(r) {F_c}(r)\,\d r \equiv
s^k_{abcd}.
\]
The same definitions may be used to define $m^{k(ac)}_{bd}$, etc.
%
With these, we can finally write:
\begin{equation}\small
\begin{split}
s^{k(ac)}_{bd} &= 
%\Upsilon^{k+1}\{Q^k_{bd}\}
\left(\frac{\Delta_{bd}}{k+1}g^{k+1}_{bd}+b^{k+1}_{bd}\right)
\left[\frac{\Delta_{ac}}{k+1}\theta_x + \theta_y\right]\\
%
t^{k(ac)}_{bd} &= 
%\Upsilon^{k-1}\{P^k_{bd}\}
\left(\frac{\Delta_{bd}}{k}g^{k-1}_{bd}-b^{k-1}_{bd}\right)
\left[\frac{\Delta_{ac}}{k}\theta_x - \theta_y\right]\\
%
u^{k(ac)}_{bd} &= 
%\Upsilon^{k}\{X_{bd}\}
g^k_{bd}(r)
\,\theta_x \\
%
v^{k(ac)}_{bd} &= \Bigg(
%\Upsilon_0^{k-1}\{P^k_{bd}\}
\frac{\Delta_{bd}}{k}[g^{0,k-1}_{bd}-g^{0,k+1}_{bd}]
-b^{0,k-1}_{bd}+b^{0,k+1}_{bd}
%-\Upsilon_0^{k+1}\{P^k_{bd}\}
\Bigg)\left[\frac{\Delta_{ac}}{k+1}\theta_x + \theta_y\right]\\
% &+ \left(
% \Upsilon_\infty^{k-1}\{Q^k_{bd}\}
% -\Upsilon_\infty^{k+1}\{Q^k_{bd}\}
% \right)\left[\frac{\delta_{ac}}{k}\theta_x - \theta_y\right].
+\Bigg(&
%\Upsilon_0^{k-1}\{P^k_{bd}\}
\frac{\Delta_{bd}}{k+1}[g^{\infty,k-1}_{bd}-g^{\infty,k+1}_{bd}]
+b^{\infty,k-1}_{bd}-b^{\infty,k+1}_{bd}
%-\Upsilon_0^{k+1}\{P^k_{bd}\}
\Bigg)\left[\frac{\Delta_{ac}}{k}\theta_x - \theta_y\right].
\end{split}
\end{equation}






Inclusion of the Breit Hamiltonian into the Hartree-Fock equations~\cite{Derevianko2001} leads to a correction to the HF potential (\ref{eq:H-HF}):
\be
\hat V_{\rm HF} \to  \hat V_{\rm HF}  + \hat B_{\rm HF} .
\ee
Inclusion into the Hartree-Fock and TDHF equations allows for the inclusion of Breit effects into the calculations of atomic energies and wavefunctions.
Since the Breit potential depends on the core orbitals, an extra term now also appears in the TDHF equations: 
\be
\delta V\to \delta V_{\rm HF}(\delta\phi)+\delta V_{\rm B}(\delta\phi),
\ee
which in fact gives the dominant Breit correction to matrix elements in many cases.

The Breit contribution to the Hartree-Fock potential correction can be found simply in analogy with Eq.~\eqref{eq:Vhf-radial}:
\be\begin{split}\label{eq:HF_Breit}
\hat B_{\rm HF} F_i(r) = \frac{-1}{[j_i]}\sum_b^{\rm core}\sum_k \big[
(C^k_{bi})^2\left(m^{k(ib)}_{bi}+o^{k(ib)}_{bi}+p^{k(ib)}_{bi}\right)\\
+(C^k_{-b,i})^2n^{k(ib)}_{bi}
\big]F_b(r).
\end{split}
\ee
Note that the direct Breit contribution is zero; only the exchange term survives.
The equation for $\delta V_{\rm B}(\delta\phi)$ is not given explicitly here, 
but can be found by making the similar substitution in Eq.~(\ref{eq:dV-rme}).
Note that while no direct Breit term appears in the HF equations, it does enter into $\delta V_{\rm B}$.

%


Note that, at the moment, the Breit interaction cannot be included into the electron Green's function, required to compute the all-orders correlation potential.
Therefore, the Breit effect must be computed only at the second order of MBPT.
(This is not a fundamental limitation, in theory Breit can be included into the Green's function, it just isn't implemented as of now).
Further, we do not include the Breit correction to the Coulomb interaction inside the MBPT diragrams; this affect is very small~\cite{Derevianko2001}.
It is, however, important to include the Breit interaction into the Hamiltonian used to create the spline basis states (which are used to construct the MBPT diagrams), since these states must be orthogonal to the Hartree-Fock core.



%======================================================
\subsection[Radiative QED corrections]{Radiative QED corrections\footnote{Functions defined in:~/src/Physics/RadiativePotential.hpp}}

Radiative QED corrections can be included into the wavefunctions using the radiative potential method developed in Ref.~\cite{FlambaumQED2005}, including the (small) finite nuclear size corrections~\cite{GingesQED2015,Ginges2016}.
In this method, an effective potential, $V_{\rm rad}$,
is added to the Hamiltonian before the equations are solved.
The potential can be written as the sum of the Uehling (vacuum polarisation) and self-energy potentials, see Fig.~\ref{fig:QED}.
The self-energy potential itself is written as the sum of the high- and low-frequency electric contributions, and the magnetic contribution:
\be\label{eq:Vrad}
V_{\rm rad}(\v{r}) = V_{\rm Ueh}(r) + V_{\rm SE}^{h}(r) +  V_{\rm SE}^{l}(r) + V_{\rm SE}^{\rm mag}(\v{r}).
\ee



\begin{figure}%[h]
\centering\tiny
\includegraphics[width=0.185\textwidth]{img/VacuumPol}~~~~~
\includegraphics[width=0.185\textwidth]{img/SelfEnergy}
\caption{\small Vacuum polarisation (left) and self-energy (right) diagrams. In the radiative potential method, the self-energy diagram is replaced with an effective local potential~\cite{FlambaumQED2005}.\label{fig:QED}}
\end{figure}






Including this potential into the Hartree-Fock equations (instead of adding it as a subsequent perturbation) gives an important contribution (core relaxation), especially for states with $l>0$.
The first three (electric) terms on the RHS of Eq.~(\ref{eq:Vrad}),
\be
V^{\rm el}(r) =  V_{\rm Ueh}(r) +V_{\rm SE}^{h}(r) + V_{\rm SE}^{l}(r) ,
\ee
are simple scalar terms, and can be included into the calculations simply (e.g., by adding them to the nuclear potential).
The final (magnetic) term, which can be expressed as~\cite{Ginges2016}
\be
V_{\rm SE}^{\rm mag}(\v{r}) = i (\v{\gamma}\cdot\v{n}) H^{\rm mag}(r),
\ee
leads to off-diagonal terms in the Hamiltonian.
Together, they can be included via additions to the radial derivative (\ref{eq:dF}):
\be\label{eq:dF-Hmag}
\p_r F  = \frac{1}{c}\matr 	{(-{c\k}/{r} + H^{\rm mag})} 	{(\en - \hat V + V^{\rm el} + 2c^2)}  {-(\en - \hat V+ V^{\rm el} )} 	 {({c\k}/{r} - H^{\rm mag})}F.
\ee
The sign convention here for $V_{\rm rad}$ (i.e.,\ with $\hat H \to \hat H -V_{\rm rad}$) is from Ref.~\cite{FlambaumQED2005}.
%; in the code I define $H^{\rm el}=-V^{\rm el}$.
%


Detailed expressions for the individual contributions to $V_{\rm rad}$ are given in Refs.~\cite{FlambaumQED2005,GingesQED2015,Ginges2016}\footnote{Note: there is a small typo in Eq.~(14)  of Ref.~\cite{Ginges2016} $(V^{\rm step}_{\rm high})$; the $r\leq r_N$ and  $r> r_N$ terms should be swapped.} -- they involve some rather nasty integrals that must be evaluated carefully.
%They are reproduced here in slightly different form.
For the Uehling potential (with $\rho = r/\lambdabar_c$ and $\rho_n = r_N/\lambdabar_c$)\footnote{$\lambdabar_c$ is electron (reduced) Compton wavelength. Atomic units: $\lambdabar_c=\alpha$.} we have:
\be
V_{\rm Ueh}(r) = \frac{Z\a}{3\pi \, r}\int\limits_1^\infty \d t\frac{\sqrt{t^2-1}}{t^4}\left(2t^2+1\right) \, e^{-2t\rho}  \, G_{\rm Ueh}(r,t),
\ee
where $r_N$ is the nuclear radius ($r_N=\sqrt{5/3}r_{\rm rms}$) and 
\begin{multline}
G_{\rm Ueh}(r,t) = \\
\begin{cases}
3\left({2 t \rho_n}\right)^{-3} 
 \left[ (2t\rho_n)\cosh (2t\rho_n) - \sinh (2t\rho_n)\right]
& r\geq r_n
\\
3\left({2 t \rho_n}\right)^{-3} 
e^{2t \rho}\left[
2t\rho  - e^{-2 t \rho_n }(1+2t\rho_n )\sinh(2t\rho )
\right]
& r<r_n.
\end{cases}
\end{multline}
Note that $G_{\rm Ueh}\to 1$ as $r_N\to0$.




For the electric self-energy potential, we have
\be
V_{\rm SE}^{l}(r) = - B_l(Z) Z^4\alpha^3 %e^{-r Z} 
F_{\rm SE}^{l}(r)
\ee
where, with $\xi(x) \equiv (x+1)e^{-x}$,
\be
F_{\rm SE}^{l}(r) = \frac{3}{2 r r_N^3 Z^2} \int_0^{r_N}r'\left[\xi(Z|r-r'|)-\xi(Z(r+r'))\right]\d r'.
\ee
Note that $F_{\rm SE}^{l}(r)=e^{-Zr/a_B}$ as $r_N\to0$. 
And:
\begin{multline}
V^h_{\rm SE}(r) = -A_l(Z)\frac{Z\a}{\pi r} \int_1^\infty \d t \,  I_1(t,Z)\\
\times\left[e^{-2t\rho}G_{\rm Ueh}(r,t) -I_2(r,t,Z)\right],
\end{multline}
where $G_{\rm Ueh}$ is the same as from the Uehling potential,  
\begin{multline}
I_1(r,t,Z) = \frac{1}{\sqrt{t^2-1}}\Bigg\{
{1\over t^2}-{3\over2}
\\
+\left(1-\frac{1}{2t^2}\right)\left[\ln(t^2-1)+4\ln\left({(Z\a)^{-1}}+\frac{1}{2}\right)\right]
\Bigg\},
\end{multline}
and
\begin{multline}
I_2(r,t,Z)= 
 \frac{3r_A}{2r_N^3}\int_0^{r_N}r'\Big[E_1\left([|r-r'|+r_A]2t/\lambdabar_c\right)-\\
E_1\left([r+r'+r_A]2t/\lambdabar_c\right)\Big]\d r',
\end{multline}
$E_1$ is the exponential integral, and $r_A\equiv0.07Z^2\a^3$.
Here, $A_l$ and $B_l$ are order-1 fitting factors, taken from Ref.~\cite{Ginges2016}.
%Note that $I_2\to0$ as $r_N\to0$.
Note that $I_2\to e^{-2t\rho} {r_A}/[{r/a_B+r_A}]$ as $r_N\to0$.


Finally for the magnetic form factor:
\begin{multline}
H^{\rm mag}(r) = \frac{Z\a^2}{4\pi r^2} \int\limits_1^\infty \d t \frac{1}{t^2\sqrt{t^2-1}}\\
\times\left[ (1+2t\eta)e^{-2t \rho} G_{\rm mag}(r,t) - (\chi/\rho_n)^3 \right],
\end{multline}
where $\eta = \max(\rho,\rho_n)$,  $\chi = \min(\rho,\rho_n)$, and
\begin{multline}
G_{\rm mag} = \frac{3}{(2t\rho_n)^{3}}\Big(e^{2t(\rho-\eta)} 
 \left[2t\chi \cosh(2t\chi) - \sinh(2t\chi)\right] \Big).
\end{multline}
Note that $G_{\rm mag}\to 1$ as $R_n\to0$.







%======================================================
\section{Configuration Interaction}


In this section, we detail the method used for multi-valence electron atoms. We focus on the case of two-valence systems, but the general method works for any system.
We use the combined Configuration Interaction with Many-Body Perturbation Theory (CI+MBPT) method, which was first introduced in Ref.~\cite{DzubaCIMBPT1996};
see also Refs.~\cite{DzubaCIMBPT1996,DzubaVN-M2005,AMBiT2018,Berengut2006,Kozlov2022,Kozlov2015}.

In the CI+MBPT method, valence-valence correlations are treated with high accuracy using the CI method, and core-valence correlations are treated using perturbation theory.
Since the core excitation energies are much larger than valence excitations, this method has the potential to be highly accurate while maintaining good numerical efficiency.

\subsection{CI Hamiltonian}

We may first break the total Hamiltonian into parts containing only core-electron terms, valence electron terms (including the valence-valence Coulomb interaction), and the core-valence interaction potential:
\begin{align}
H &= H_{\rm c} + H_{\rm v} + V_{\rm cv}
\end{align}
The core-valence interaction is obviously not small.
However, the dominant part of this interaction can be described by the Hartree-Fock potential due to the $N-M$ core electrons:
\be
V_{\rm cv} = \sum_i^M V^{\rm HF}(r_i) + \delta V,
\ee
where $\delta V$ is (assumed to be) a small correction, which we shall treat perturbatively.
Excluding the perturbation, we thus define the standard CI Hamiltonian for the valence space:
\be\label{eq:Hci}
    H_{\rm CI} = H_{\rm CI}^1 + H_{\rm CI}^2 = 
    \sum_i^M h^{\rm HF}(r_i)
+\sum_{i<j}r^{-1}_{ij},
\ee
where the sums extend over only the electrons in the valence subspace (the ``active'' CI space).

For accurate calculations, however, core-valence correlations must be taken into account. 
This may be done by an expansion of the perturbation potential $H_{\rm eff} = H_{\rm CI} + \delta V$:
\be\label{eq:Hci-dV}
    \delta V \approx \sum_i \Sigma^1(r_i) +\sum_{i<j}\Sigma^2(r_i,r_j),
\ee
where $\Sigma^1$ is the (non-local) one-body correlation potential which accounts for the core-valence interactions, and $\Sigma^2$ is the two-body operator which accounts for the screening of the valence-valence Coulomb interaction by the core electrons.
These are to be calculated using Many-Body Perturbation Theory; and will be discussed below.



In the CI method, approximate valence-space wavefunctions, $\Psi$, are expanded over $M$-particle wavefunctions called Configuration-State Functions (CSFs), $\psi_I$:
\be\label{eq:CSF}
    \ket{\Psi,J^\pi J_z} = \sum_I c_I \ket{I,J^\pi J_z}.
\ee
The CSFs are combinations of Slater-determinants
%wavefunctions built from a basis of single-particle orbitals, 
and will be discussed below.
%the single-particle basis choice will be discussed below.
The CSFs are eigenfunctions of $J^2$, $J_z$, and parity ($\pi$).
%; I will drop the $\pi$ label from here.
Then, for each $J^\pi$ symmetry, the energies and wavefunctions (expansion coefficients) are found by solving the Schr\"odinger equation, which for a finite set of $N_{CSF}$ CSFs, is cast to an $N_{CSF}^2$ eigenvalue problem:
\be\label{eq:Heff-CI}
    \sum_J c_J\bra{I}H_{\rm eff}\ket{J} = E c_I,
\ee
where $N_{CSF}$ is the number of CSFs in the expansion \eqref{eq:CSF}.
(We generally don't need to fully solve the eigenvalue problem, there are efficient methods to approximately find just the lowest few eigenvalues.)
The accuracy of the method is controlled by where the CI expansion is truncated (i.e., which CSFs we include in the space), and by how many electron shells are considered to be in the ``valence'' space.

The CSFs are themselves formed from combinations of $M$-particle Slater determinants\footnote{If hole excitations are included into the CI space, the CSFs may be $M+2N_h$ particle functions, where $N_h$ is the number of hole-excitations included. Hole excitations are not included in the CI expansion in AMPSCI, rather they are accounted for using MBPT.} (sometimes called ``projections''):
\be\label{eq:CSF-SD}
    \ket{I,J J_z} = \sum_{\{m\}} d_{\{m\}} \ket{I,J J_z,\{m_1,m_2,\ldots\}}.
\ee
These have definite angular momentum projections, $m_j$, for each of the $M$ electrons that form the CSF; the set of $m$s have $\sum_im_i=J_z$, and 
$
    \sum_{\{m\}} d_{\{m\}}^2=1.
$
Typically, CSFs $\Phi$ are formed in the stretched state with $J_z=J$.

For two-particle states, $d_{\{m\}}$ are just the Clebsch-Gordon coefficients.
For example, for configuration $\{n\kappa,\,n'\kappa'\}$ (which has parity $\pi=(-1)^{l+l'}$),
\be
    \ket{I,J^\pi J} = \eta \sum_m
C^{JJ}_{j,m,j',m'} \, 
    \ket{I,J^\pi J,\{n\kappa m,n'\kappa'm'\}},
\ee
where $m'=J-m$.
The extra factor $\eta$ is required when the two electrons in the CSF are in the same ($n$,\,$\kappa$) orbital:
\be
\eta = 
\begin{cases}
  1/\sqrt{2} & \text{identical}    \\
  1& \text{otherwise} 
\end{cases},
\ee
and accounts for the fact that both cannot occupy the same $m$.

The single-particle basis states may be formed in a number of ways.
One choice is to use the set of eigenstates of the same HF potential that appears in the CI \eqref{eq:Hci}.
In this choice, the Hartree-Fock potential is due to the $N-M$ core electrons, and so is called the $V^{N-M}$ approximation.
The benefit of this method is that the one-particle states are eigenstates of the one-particle part of the CI Hamiltonian, and the many-body corrections become simpler (as discussed below).
The downside, however, is that the the potential seen by the one-electron states is far from realistic, meaning a larger number of CSFs are typically required in the expansion.
For few-valence systems, this is often the best compromise.
For many-valence systems, the CI part of the problem becomes more important (compared to the MBPT part), and so a more realistic initial potential should be used.


\subsection{Angular separation}

Since for two-particle CSFs, the angular linking the CSF to the Slater determinants in Eq.~\eqref{eq:CSF-SD} are just the Clebsch-Gordon coefficients, the angular separation is particularly simple.
Here, I use the short-hand notation $\ket{V}$ for a two-electron CSF
\be\label{eq:CSF-to-SD}
    \ket{V} = \eta_{vw} \sum_{\{m\}}
C^{JJ}_{j_v,m_v,j_w,m_w} \, 
    \ket{\{vw\}},
\ee
(and similarly for $\ket{X}= ...\ket{\{xy\}}$).

The first thing is to evaluate the matrix elements of the CI Hamiltonian Eq.~\eqref{eq:Hci} between two CSFs of the same $J^\pi$ symmetry (ignoring the MBPT part for now).
Considering the one-body part of the Hamiltonian first ($H_{\rm CI}^1$), we have for the diagonal terms:
\begin{equation}
    \bra{V} H_{\rm CI}^1 \ket{V}
    = h^1_{vv}+h^1_{ww},
\end{equation}
%and for off-diagonal ($X\neq V$) terms:
or more generally:
\begin{multline}
    \bra{X} H_{\rm CI}^1 \ket{V}
    = 
    \eta_{xy}\eta_{vw}\Big[
    h^1_{yw}\delta_{xv}
    +h^1_{xv}\delta_{yw}\\
    -(-1)^{J+v+w}\left(
        h^1_{yv}\delta_{xw}
        +h^1_{xw}\delta_{yv}
        \right)
    \Big].
\end{multline}
Note that, in the $V^{N-M}$ approximation,
$h^1_{ij} = \en_i\delta_{ij}$.
For the two-body part $H_{\rm CI}^2$), we have:
\begin{multline}
    \bra{X} H_{\rm CI}^2 \ket{V}
    = 
    \eta_{xy}\eta_{vw}\sum_k(-1)^{x+v+k}
    \,\times\\
    \Bigg(\sixjs{x}{y}{J}{w}{v}{k} (-1)^{J}Q^k_{xyvw}
    +
    \sixjs{x}{y}{J}{v}{w}{k}Q^k_{xywv}
    \Bigg).
\end{multline}
(Note, the formula looks cleaner if this is written terms of the anti-symmetrised $W^k$ integral, though it is less efficient to compute that way).
To include the Breit interaction, we simply replace $Q^k\to Q^k + B^k$ \eqref{eq:Bk-Breit}. 
By including Breit in the HF potential, the Breit contribution to $H_1$ is included automatically.


\subsection{External fields and matrix elements}

For a tensor operator, $T^k_q$, we can write the reduced matrix element as a sum over CSFs:
\begin{equation}
    \bra{\Psi_A}|T^k|\ket{\Psi_B}
    = \sum_{X,V}c_X c_V \bra{X}|T^k|\ket{V}.
\end{equation}
For two-particle states, the reduced matrix elements between CSFs can be expressed [using the notation of \eqref{eq:CSF-to-SD}]
\begin{multline}
    \bra{X}|T^k|\ket{V}
    = (-1)^k\eta_{xy}\eta_{vw}\sqrt{[J_X,J_V]}\times\\ \Bigg[
    (-1)^{x+w+V}\sixjs{X}{V}{k}{v}{x}{w}t^k_{xv}\delta_{yw}\\
    +(-1)^{x+w}\sixjs{X}{V}{k}{w}{x}{v}t^k_{xw}\delta_{yv}\\
    +(-1)^{X+V+1}\sixjs{X}{V}{k}{v}{y}{w}t^k_{yv}\delta_{xw}\\
    +(-1)^{w+v+X}\sixjs{X}{V}{k}{w}{y}{v}t^k_{yw}\delta_{xv}
    \Bigg].
\end{multline}
Core polarisation (RPA) can be taken into account in the usual way, by modifying the single-particle matrix elements.

\subsection{CI+MBPT}

The $\delta V$ terms in Eq.~\eqref{eq:Hci-dV} correct the one- and two-particle parts of the CI Hamiltonian \eqref{eq:Hci} respectively.
%:
%$h^1_{vw}\to h^1_{vw} + \Sigma^1_{vw}$, and 
The one-particle $\Sigma^1_{vw}$ operator is the same one that appears for one-valence systems, shown in Fig.~\ref{fig:Sigma2}, though we require the off-diagonal elements:
\begin{align}\label{eq:Sigma1_ab}
    \Sigma^1_{vw} &= 
    %\bra{v}\Sigma^1\ket{w} \notag\\&= 
    \sum_{amn}
    \frac{g_{vamn}\widetilde g_{nmaw}}{\en_{wa} - \en_{mn}}
    +\sum_{abn}
     \frac{g_{vnab}\widetilde g_{banw}}{\en_{wn}-\en_{ab}}.
\end{align}
We have written the energy denominators directly as implied by the Goldstone diagrams (RS perturbation theory). We shall return to the question of the energy denominators soon.
The angular separation is exactly the same as in Eq.~\eqref{eq:dE-SO-red}.
We have evaluate the matrix elements directly like this, or we may form the correlation potential matrix as in Sec~\ref{sec:Sigma2-goldstone}.
All-orders screening and hole-particle interaction can also be simply included into $\Sigma^1$ by using the all-order correlation potential as described in Sec.~\ref{sec:all-orders}.

\begin{figure}%[h]
\centering\tiny
\includegraphics[width=0.115\textwidth]{img/s2/s2_a1.pdf}
\includegraphics[width=0.115\textwidth]{img/s2/s2_a2.pdf}
\includegraphics[width=0.115\textwidth]{img/s2/s2_a3.pdf}\\
%
\includegraphics[width=0.115\textwidth]{img/s2/s2_b1.pdf}
\includegraphics[width=0.115\textwidth]{img/s2/s2_b2.pdf}
\includegraphics[width=0.115\textwidth]{img/s2/s2_b3.pdf}\\
%
\includegraphics[width=0.115\textwidth]{img/s2/s2_c1.pdf}
\includegraphics[width=0.115\textwidth]{img/s2/s2_c2.pdf}
\includegraphics[width=0.115\textwidth]{img/s2/s2_d.pdf}
\caption{\small Matrix elements of the $\Sigma^2$ operator -- screening of the valence-space Coulomb interaction by core electrons.\label{fig:CI-S2}}
\end{figure}


The two-body $\Sigma^2$ operator corresponds to screening of the valence-valence Coulomb interaction by the core electrons, as shown in Fig.~\ref{fig:CI-S2}.
The diagrams can be evaluated:
\be\begin{split}
    \Sigma^2_{vwxy} 
    =& ~
    % a:
    \frac{g_{vnxa}\widetilde g_{awny}-g_{vnax}g_{awny}}
    {e_{xa}-\en_{vn}}\\
    % B:
    &+
    \frac{g_{vaxn}\widetilde g_{nway}-g_{vanx} g_{nway}}{e_{ya}-\en_{wn}}
    \\
    %c1 : 
    &-\frac{g_{vnay}g_{awxn}}
    {e_{ya}-\en_{vn}}
    %c2 : 
    -\frac{g_{vany}g_{nwxa}}
    {e_{xa}-\en_{wn}}
    +
    \frac{g_{vwab}g_{abxy}}{\en_{ab}-\en_{vw}}.
\end{split}
\ee

In the standard Rayleigh-Schrodinger (RS) perturbation theory (as the above energy denominators are presented), the $\Sigma$ matrix elements, and hence the CI matrix, becomes non-symmetric.
In the Brillouin-Wigner (BW) formalism, the energy denominators instead depend on the whole energy of the atom. This becomes $E_{\rm core}+E_{\rm val}$, and the core part cancels. So the energy denominators depend on the valence configuration.
A good approximation is to use the single-particle energy of the leading configuration.

For $\Sigma^1$, this is as simple as replacing the valence energy with the energy of the lowest valence state of the given single-particle symmetry $e_w \to \bar \e_{\kappa_w}$.
For $\Sigma^2$, we may also use this approximation for all of the valence states.
%
Or, we can make the stronger approximation that the initial/final state energies are roughly the same (valid since the core-valence excitation energy is large compared to the valence excitation energy), $\en_v-\en_x\approx \en_w - \en_y \approx 0$.

The correlation diagrams have the same angular decomposition as the Coulomb integrals:
\be
     \Sigma^2_{vwxy} = \sum_k A^k_{vwxy} S^k_{vwxy},
\ee
where $S^k$ is independent of magnetic quantum numbers.
Note that $S^k$ has different selection rules and fewer symmetries than $Q^k$:
$S^k_{}$
The explicit formulas can be constructed from:
\be
     \widetilde g_{vnxa}\widetilde g_{awny} = \sum_k A^k_{vwxy} \frac{(-1)^k}{[k]}W^k_{vnxa} W^k_{awny},
\ee
and
\begin{multline}
      g_{vwab} g_{abxy} = \sum_k A^k_{vwxy} \sum_{\mu\lambda} (-1)^{v+w+x+y+a-b}
      \times\\
      [k]\sixjs{\lambda}{\mu}{k}{v}{x}{a} \sixjs{\lambda}{\mu}{k}{w}{y}{b} 
      Q^\mu_{vwab} Q^\lambda_{abxy}.
\end{multline}




%======================================================
%\clearpage
%\newpage
%~\\~\\\hrule~\\
\appendix

\setcounter{equation}{0}
\setcounter{figure}{0}
\setcounter{table}{0}
\renewcommand{\theequation}{A.\arabic{equation}}
\renewcommand{\thefigure}{A.\arabic{figure}}
\renewcommand{\thetable}{A.\arabic{table}}

\section{Appendix}
\small

Some useful equations and definitions are given here; see also Refs.~\cite{LLVol3,JohnsonBook2007,Sobelman1992,Varshalovich1988,Lindgren1986,Sapirstein1998,DzubaHFS1984}.
Note that notation differs between all these sources, I have introduced some notation not found in the above.

%======================================================
\subsection{Many-body wavefunction (Slater determinant)}\label{sec:ManyBodyWavefunction}

For a system of non-interaction particles, the  many-body wavefunction may be written as a product state
(independent particle picture).
If each single-particle wavefunction $\psi$ obeys $\hat h\psi=\en\psi$, it clear, e.g., that a two-body product wavefunction $\psi_a(r_1)\psi_b(r_2)$ satisfies the total Hamiltonian:
\be\label{eq:twoBody}
\left[h(r_1)+h(r_2)\right]\psi_a(r_1)\psi_b(r_2) = \left[\en_a+\en_b\right]\psi_a(r_1)\psi_b(r_2).
\ee
This remains true for states where each particle interacts with a common field (e.g., $h = h_0 + V(r)$), as is the basis for mean-field approximations such as Hartree-Fock.
For Fermions, the many-body wavefunction must be anti-symmetric under the exchange of any two particles, and must not allow any two particles to occupy the same state.
A two-particle state which satisfies this may be written
\be
\Psi_{ab}(r_1, r_2) = \frac{1}{\sqrt{2}}\left[ \psi_a(r_1)\psi_b(r_2) - \psi_b(r_1)\psi_a(r_2) \right].
\ee
More generally, an $N$-body wavefunction may be written in the form of a determinant, known as a Slater determinant,
\be
\Psi_{ab...n}(r_1, r_2,..., r_N) =
\frac{1}{\sqrt{N!}} {\small\begin{vmatrix}  
\psi_a(r_1) & \psi_a(r_2) & \ldots & \psi_a(r_N)\\ 
\psi_b(r_1) & \psi_b(r_2) & \ldots & \psi_b(r_N)\\ 
\vdots & \vdots & \ddots & \vdots \\
\psi_n(r_1) & \psi_n(r_2) & \ldots & \psi_n(r_N)
\end{vmatrix}}
\ee
which is an eigenstate of the Hamiltonian
\[
H = \sum_{i}^N h(r_i).
\]
Note that the determinant form encodes the Fermion antisymmetry and exclusion principal.

The introduction of explicit interactions between particles [e.g., introducing $V(r_1,r_2)$ into (\ref{eq:twoBody})] means the wavefunction cannot be written exactly as a single Slater determinant.
However, if the interaction terms can be made to be small (e.g., by good choice of mean field), they may be treated perturbatively.
The many-body wavefunction can be written as an expansion over Slater-determinant states (many-body perturbation theory); see, e.g.,~\cite{JohnsonBook2007,Lindgren1986}.
We will typically refer to the single-particle wavefunctions, $\psi$, that make up the total $N$-body Slater determinant, $\Psi$, as {\em orbitals}.

%======================================================
\subsection{Matrix elements for many-body states\label{sec:app-many-body-mes}}


Let $F$ and $G$ be one- and two-particle operators
\begin{align}
\hat F = \sum_i \hat f(\v{r}_i) \quad,\qquad
\hat G = \sum_{i<j} \hat g(\v{r}_i,\v{r}_j),
\end{align}
where $f(\v{r}_i)$ acts on the $i$th electron; $g(\v{r}_i,\v{r}_j)$ acts on the pair of electrons $\{i,j\}$.
Here, I use the short-hand notation from Ref.~\cite{Lindgren1986}:
\[
\ket{\Phi_i^n} = a_n^\dag a_i \ket{\Phi},
\]
with $i$, $j$ denoting occupied states (core and valence), and $m$, $n$, denoting unoccupied virtual excited states.
$\ket{\Phi}$ is a many-body Slater determinant wavefunction including the Hartree-Fock core and the occupied valence states (e.g., we may have $\ket{\Phi} = a_v^\dag\ket{0_{\rm HF}}$), see Ref.~\cite{Lindgren1986}.
Then, we have for diagonal matrix elements:
\begin{equation}\begin{split}
\bra{\Phi}F\ket{\Phi} &= \sum_i \bra{i}f\ket{i}  = \sum_i f_{ii}\\
\bra{\Phi}G\ket{\Phi} &= \sum_{i<j} \left( \bra{ij}g\ket{ij} - \bra{ji}g\ket{ij} \right) = \sum_{i<j} (g_{ijij}-g_{jiij}),
\end{split}\end{equation}
for matrix elements between states that differ by a single orbital:
\begin{equation}\begin{split}
\bra{\Phi^n_i}F\ket{\Phi} &=  \bra{n}f\ket{i}  = f_{ni}\\
\bra{\Phi^n_i}G\ket{\Phi} &= \sum_{j} \left( \bra{nj}g\ket{ij} - \bra{jn}g\ket{ij} \right)  = \sum_{j} (g_{njij}-g_{jnij}) ,
\end{split}\end{equation}
and for matrix elements between states that differ by two orbitals:
\begin{equation}\begin{split}\label{eq:G-twobody}
\bra{\Phi^{nm}_{ij}}F\ket{\Phi} &=  0 \\
\bra{\Phi^{nm}_{ij}}G\ket{\Phi} &= \bra{nm}g\ket{ij} - \bra{mn}g\ket{ij} = g_{nmij}-g_{mnij}.
\end{split}\end{equation}


%----------------------------------------------------
\subsection{Wigner-Eckhardt theorem}
For irreducible (spherical) tensor operator $T^k_q$ ($q$ component of tensor operator of rank $k$), the Wigner-Eckhardt theorem allows us to define a {\em reduced matrix element} via:
\begin{multline}
\bra{n_a \k_a m_a}T^k_q\ket{n_b \k_b m_b} \\= (-1)^{j_a-m_a}\threej{j_a}{k}{j_b}{-m_a}{q}{m_b} \bra{n_a \k_a}|T^k|\ket{n_b \k_b},
\end{multline}
where the reduced matrix element $\bra{}|T^k|\ket{}$ does not depend on magnetic quantum numbers, and $\left(:::\right)$ is a $3j$-symbol~\cite{Varshalovich1988}.
The reduced matrix elements have symmetry relation:
\be
\bra{j}|T^k|\ket{j'} = (-1)^{j-j'}\bra{j'}|T^k|\ket{j}^*,
\ee
and obey summation relation:
\be
\sum_{m_a,m_b,q} |\bra{n_a \k_a m_a}T^k_q\ket{n_b \k_b m_b}|^2 = |\bra{n_a \k_a}|T^k|\ket{n_b \k_b}|^2.
\ee
%

%=========================================
\subsection{Angular identities}


Clebsch-Gordon coefficients notation:
\begin{align}
\braket{j_1 m_1,j_2m_2|JM} &\equiv (-1)^{j_1-j_2+M}\sqrt{[J]}\threej{j_1}{j_2}{J}{m_1}{m_2}{-M}\\
&\equiv C(j_1,j_2,J; m_1, m_2, M)\\
&\equiv C^{JM}_{j_1m_1,j_2m_2}.
\end{align}
\be
\ket{j_1 j_2;JM} =\sum_{m_1,m_2} \braket{j_1 m_1,j_2m_2|JM} \ket{j_1m_1}\ket{j_2m_2}.
\ee


%----------------------------------------------------
\subsubsection*{Useful identities}


%See also the appendix of Ref.~\cite{DzubaHFS1984} for some very nice general angular identities (though note the minor notational difference between there and here; in particular, the $Q^k$ terms differ by a factor of $\pm1$. My definition is chosen here due to the symmetry properties).

\be
\sum_{m_b}g_{abab} = [j_b] R^0_{abab}.
\ee
%
\begin{align}
\sum_{m_{i,j,k,l}}  g_{ijkl} \, g_{lkji}
    &= \sum_\mu \frac{1}{[\mu]} \left( C^\mu_{ik}C^\mu_{jl} R^\mu_{ijkl}\right)^2 \\
    &= \sum_\mu \frac{1}{[\mu]} \left( Q^\mu_{ijkl}\right)^2 
\end{align}
\begin{align}
\sum_{m_{i,j,k,l}}  g_{ijkl} \, g_{klji}
    &=\sum_{\mu \lambda}(-1)^{\mu+\lambda+1}C^\mu_{ik}C^\mu_{jl}C^\lambda_{il}C^\lambda_{jk} \notag \\
    &\phantom{=\sum_{\mu \lambda}}~~\times \sixj{j_i}{j_k}{\mu}{j_j}{j_l}{\lambda}R^\mu_{ijkl}R^\lambda_{ijlk} \\
    &=-\sum_\mu \frac{1}{[\mu]}  Q^\mu_{ijkl}P^\mu_{ijkl}
\end{align}

\begin{align}
\sum_{m_r m_s}A^\mu_{mnrs} A^\lambda_{rsij} &= \sum_k A^k_{mnij}A^{k\mu\lambda}_{mnrsij}\\
\sum_{m_r m_c}A^\mu_{cnir} A^\lambda_{mrcj} &= \sum_k (-1)^{k+\mu+\lambda}A^k_{mnij}A^{k\lambda\mu}_{mjcrin},
\end{align}
where
\be
A^{k\mu\lambda} \equiv (-1)^{m+n+r+s+i+j+1}[k]\sixjs{m}{i}{k}{\lambda}{\mu}{r}\sixjs{n}{j}{k}{\lambda}{\mu}{s},
\ee


%----------------------------------------------------
%\subsubsection*{Some angular integrals + matrix elements}


\begin{align}\notag
&\sum_{jm}(2j+1)\threej{j_1}{j_2}{j}{m_1}{m_2}{m}\threej{j_1}{j_2}{j}{m_1'}{m_2'}{m} = \delta_{m_1m_1'}\delta_{m_2m_2'}
\\
&\sum_{m_1m_2}(2j+1)\threej{j_1}{j_2}{j}{m_1}{m_2}{m}\threej{j_1}{j_2}{j'}{m_1}{m_2}{m'} = \delta_{jj'}\delta_{mm'}
\end{align}
%
\begin{multline}
\int Y_{l'm'}Y_{lm}Y_{LM}\,\d \Omega = \sqrt{\frac{[l'][l][L]}{4\pi}}\threej{l'}{l}{L}{0}{0}{0}\threej{l'}{l}{L}{m'}{m}{M}
\end{multline}
\be
\sum_{m_l=-l}^l |Y_{lm_l}|^2 = \frac{2l+1}{4\pi}\quad,\qquad \sum_m |\Omega_{\k m}|^2 = \frac{2j+1}{4\pi}
\ee
%
\be
\bra{l_a}|C^k|\ket{l_b} = (-1)^{l_a}\sqrt{[l_a][l_b]}\threej{l_a}{l_b}{k}{0}{0}{0}
\ee
%
$r_q = |r| C^1_q = |r|\sqrt{\frac{4\pi}{3}}Y_{1q}$; $r_0=z$.
\be
\bra{n\k}|r_z|\ket{n'\k'} = ({n\k}|r|{n'\k'})\bra{\k}|C^1|\ket{\k'}.
\ee
%
\begin{multline}
\bra{J'IF'}|T^k|\ket{JIF} \\= (-1)^{F+J'+I+k}\sqrt{[F'][F]}\sixj{J}{I}{F}{F'}{k}{J'}\bra{J'}|T^k|\ket{J}
\end{multline}
where ($[a]\equiv2a+1$).

From Ch.~13 of Ref.~\cite{Varshalovich1988}:
\begin{align}\notag
\bra{jls}|l|\ket{j'l's'}& =\delta_{ll'}\delta_{ss'}(-1)^{j'+l+s+1}\sqrt{[j][j'][l]l(l+1)}\sixjs{j}{1}{j'}{l}{s}{l}\\
\bra{jls}|s|\ket{j'l's'}&= \delta_{ll'}\delta_{ss'}(-1)^{j+l+s+1}\sqrt{[j][j'][s]s(s+1)}\sixjs{j}{1}{j'}{s}{l}{s}.
\end{align}


A 6-$j$ symbol
\be
\sixjs{1}{2}{3}{4}{5}{6}
\ee
is non-zero only if each of the triads obey triangle inequality,
\be
\Delta(1,2,3),\, \Delta(3,4,5),\, \Delta(2,4,6),\, \Delta(5,6,1).
\ee



%======================================================
\subsection{Useful definitions/identities}

\subsubsection*{Dirac matrices}\label{sec:DiracMatrix}

Dirac matrices are defined by the relation:
\be
\{\g^\mu,\g^\nu\} = 2g^{\mu\nu}.
\ee
In the Dirac representation, with $\g^5 \equiv i\g^0\g^1\g^2\g^2$, they are:
\begin{multline}
\g^0 = \matr{1}{0}{0}{-1} \, , ~~
\g^a = \matr{0}{\s^a}{-\s^a}{0} \, , ~~
\g^5 = \matr{0}{1}{1}{0}.
\end{multline}

\subsubsection*{Pauli spin matrices}
\be
\s_x = \matr{0}{1}{1}{0} \, , ~~
\s_y = \matr{0}{-i}{i}{0} \, , ~~
\s_z = \matr{1}{0}{0}{-1}
\ee
\be
\s_i\s_j = i\epsilon_{ijk}\s_k + \delta_{ij} \, , \qquad
[\s_i,\s_j] = 2i\epsilon_{ijk}\s_k
\ee
\be
(\v{\s}\cdot\v{a})\,(\v{\s}\cdot\v{b}) = \v{a}\cdot\v{b} + i\v{\s}\cdot(\v{a}\times\v{b})
\ee
\begin{align}
(\v{\s}\cdot\v{p}) y(r)\Omega_{\k m} &= i\left(y' + \frac{\k+1}{r}y\right)\Omega_{-\k, m} \\
(\v{\s}\cdot\v{n}) \Omega_{\k m} &= -\Omega_{-\k, m}.
\end{align}

\subsubsection*{Dirac orbitals (spherical potential, Dirac basis)}
\be
\phi_{n\k m}(\v{r}) = \frac{1}{r} \twocomp
{f_{n\k}(r)\,\Omega_{\k m}(\v{n})}
{ig_{n\k}(r)\,\Omega_{-\k ,m}(\v{n})},
\ee
\begin{align}
\Omega_{\k m}(\v{n}) &=\sum_{\s=\pm1/2} \braket{l,m-\s ,\,1/2,\s|j,m}\,Y_{l,m-\s}(\v{n})\,\chi_{\s} \\
&=
\twocomp
{(-1)^{j-l-1/2}\sqrt{\frac{\k+1/2-m}{2\k+1}}Y_{l,m-1/2}(\theta,\phi)}
{\phantom{(-1)^{j-l-1/2}}\sqrt{\frac{\k+1/2+m}{2\k+1}}Y_{l,m+1/2}(\theta,\phi)},
\end{align}
%(with $l \equiv \abs{\k+1/2}-1/2$), 
where $j$ and $l$ are the total and orbital angular momentum, with
\be
\k = (l-j)(2j+1) \, ,  ~~
l = \abs{\k+1/2}-1/2\, ,  ~~
j = \abs{\k}-1/2.
\ee

Note that strictly parity $(-1)^l$, not $l$, is the good quantum number.




%======================================================
~\\\hrule
{\footnotesize
\itemsep0.25em
\bibliography{library}
}
\end{document}
